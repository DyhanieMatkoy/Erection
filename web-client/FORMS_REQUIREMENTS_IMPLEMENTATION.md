# Применение требований к формам списков веб-клиента

## Статус: В процессе реализации

Данный документ описывает применение требований из `docs/ТРЕБОВАНИЯ_К_ФОРМАМ_СПИСКОВ.md` к формам веб-клиента.

---

## 1. Обновленный компонент DataTable.vue

### ✅ Реализовано

#### 1.1 Панель инструментов
- ✅ Быстрый поиск с иконкой лупы
- ✅ Debounce 300ms для поиска
- ✅ Кнопка "Показать/Скрыть отборы"
- ✅ Кнопка "Обновить" (F5)
- ✅ Слот для дополнительных действий

#### 1.2 Панель фильтров (расширенные отборы)
- ✅ Сворачиваемая панель
- ✅ Сетка для размещения полей фильтров (1-3 колонки)
- ✅ Кнопки "Применить" и "Очистить"
- ✅ Слот для пользовательских фильтров

#### 1.3 Панель массовых операций
- ✅ Появляется при выборе элементов
- ✅ Показывает количество выбранных
- ✅ Кнопка "Снять выделение"
- ✅ Слот для кнопок массовых операций

#### 1.4 Таблица
- ✅ Чекбоксы для выбора (опционально)
- ✅ Сортировка по колонкам (клик на заголовок)
- ✅ Визуальная индикация сортировки (стрелки)
- ✅ Третий клик - сброс сортировки
- ✅ Чередующиеся цвета строк (белый/серый)
- ✅ Подсветка при наведении
- ✅ Подсветка выбранных строк
- ✅ Двойной клик для открытия
- ✅ Отображение "—" для пустых значений
- ✅ Настраиваемая ширина колонок

#### 1.5 Мобильная версия
- ✅ Карточки вместо таблицы
- ✅ Чекбоксы для выбора
- ✅ Все поля отображаются вертикально
- ✅ Кнопки действий в футере карточки

#### 1.6 Пагинация
- ✅ Кнопки: Первая, Предыдущая, Следующая, Последняя
- ✅ Номера страниц (до 5 видимых)
- ✅ Информация о количестве записей
- ✅ Адаптивная версия для мобильных
- ✅ Слот для выбора размера страницы

#### 1.7 Состояния
- ✅ Загрузка (спиннер с текстом)
- ✅ Пустой список (иконка + текст + подсказка)
- ✅ Данные (таблица/карточки)

#### 1.8 Горячие клавиши
- ✅ F5 - обновить
- ✅ Ctrl+F - фокус на поиск
- ✅ Ctrl+A - выбрать все
- ✅ Escape - снять выделение / закрыть фильтры

#### 1.9 API компонента
```typescript
Props:
- columns: Column[] - колонки таблицы
- data: any[] - данные
- loading?: boolean - индикатор загрузки
- pagination?: PaginationInfo - информация о пагинации
- selectable?: boolean - возможность выбора строк
- hasFilters?: boolean - наличие фильтров

Events:
- row-click - клик на строку
- page-change - смена страницы
- search - поиск
- sort - сортировка
- selection-change - изменение выбора
- refresh - обновление данных
- apply-filters - применить фильтры
- clear-filters - очистить фильтры

Slots:
- header-actions - кнопки в шапке
- bulk-actions - кнопки массовых операций
- filters - поля фильтров
- cell-{key} - кастомное отображение ячейки
- actions - действия для строки
- page-size-selector - выбор размера страницы

Methods (expose):
- clearSelection() - очистить выбор
- focusSearch() - фокус на поиск
```

---

## 2. Требуемые улучшения форм

### 2.1 Формы документов

#### Сметы (EstimateListView.vue)

**Текущее состояние:**
- ✅ Базовая таблица с колонками
- ✅ Быстрый поиск
- ✅ Массовые операции (провести, отменить, удалить)
- ✅ Пагинация

**Требуется добавить:**
- ⏳ Расширенные фильтры:
  - Период (дата с, дата по)
  - Быстрые периоды (сегодня, неделя, месяц, год)
  - Объект строительства
  - Контрагент
  - Статус проведения
  - Диапазон суммы
- ⏳ Колонка "Автор"
- ⏳ Колонка "Пометка удаления"
- ⏳ Иконки статусов (✓ проведен, ○ не проведен)
- ⏳ Контекстное меню (правая кнопка)
- ⏳ Горячие клавиши (Insert, Enter, F2, Delete)
- ⏳ Кнопка "Копировать"
- ⏳ Экспорт в Excel

#### Табели (TimesheetListView.vue)

**Текущее состояние:**
- ✅ Базовая таблица с колонками
- ✅ Быстрый поиск
- ✅ Массовые операции
- ✅ Пагинация

**Требуется добавить:**
- ⏳ Расширенные фильтры:
  - Период документа
  - Табельный период
  - Объект строительства
  - Работник
  - Статус проведения
- ⏳ Колонка "Автор"
- ⏳ Колонка "Пометка удаления"
- ⏳ Иконки статусов
- ⏳ Контекстное меню
- ⏳ Горячие клавиши
- ⏳ Кнопка "Заполнить по графику"
- ⏳ Печать табеля (Т-13)

### 2.2 Формы справочников

#### Контрагенты (CounterpartiesView.vue)

**Текущее состояние:**
- ✅ Базовая таблица
- ✅ Быстрый поиск
- ✅ Массовое удаление
- ✅ Модальное окно создания/редактирования

**Требуется добавить:**
- ⏳ Колонки согласно требованиям:
  - Код (100px)
  - ИНН (120px)
  - Телефон (150px)
  - Email (200px)
  - Тип (100px)
- ⏳ Расширенные фильтры:
  - Тип контрагента
  - Наличие ИНН
  - Город
- ⏳ Иконка пометки удаления (✗)
- ⏳ Контекстное меню
- ⏳ Горячие клавиши
- ⏳ Экспорт в Excel

#### Объекты строительства (ObjectsView.vue)

**Требуется добавить:**
- ⏳ Колонки:
  - Код (100px)
  - Адрес (250px)
  - Заказчик (200px)
  - Статус (120px)
  - Дата начала/окончания
- ⏳ Расширенные фильтры:
  - Статус объекта
  - Заказчик
  - Период
  - Город
- ⏳ Иконки статусов
- ⏳ Массовые операции

#### Работники (PersonsView.vue)

**Требуется добавить:**
- ⏳ Колонки:
  - Табельный номер (100px)
  - Должность (150px)
  - Специальность (150px)
  - Телефон (150px)
  - Дата приема (100px)
  - Статус (100px)
- ⏳ Расширенные фильтры:
  - Должность
  - Специальность
  - Статус (работает/уволен)
  - Дата приема
- ⏳ Массовые операции

#### Виды работ (WorksView.vue)

**Требуется добавить:**
- ⏳ Колонки:
  - Код (100px)
  - Единица измерения (100px)
  - Категория (150px)
  - Нормативная стоимость (120px)
- ⏳ Расширенные фильтры:
  - Категория работ
  - Единица измерения
  - Диапазон стоимости
- ⏳ Массовые операции

---

## 3. Новые компоненты

### 3.1 FilterPanel.vue (компонент панели фильтров)

```vue
<template>
  <div class="space-y-4">
    <slot></slot>
  </div>
</template>
```

### 3.2 DateRangePicker.vue (выбор периода)

**Функции:**
- Выбор даты "с" и "по"
- Быстрые периоды (кнопки)
- Валидация (дата "с" <= дата "по")

### 3.3 QuickPeriodSelector.vue (быстрые периоды)

**Периоды:**
- Сегодня
- Вчера
- Текущая неделя
- Текущий месяц
- Текущий год
- Прошлый месяц
- Прошлый год

### 3.4 ContextMenu.vue (контекстное меню)

**Функции:**
- Открытие по правой кнопке мыши
- Позиционирование рядом с курсором
- Закрытие при клике вне меню
- Разделители между группами

### 3.5 ExportButton.vue (экспорт данных)

**Форматы:**
- Excel (.xlsx)
- CSV (.csv)

---

## 4. Composables (переиспользуемая логика)

### 4.1 useTable.ts (существующий)

**Текущие функции:**
- ✅ Управление пагинацией
- ✅ Управление поиском
- ✅ Управление сортировкой
- ✅ Формирование query params

**Требуется добавить:**
- ⏳ Управление фильтрами
- ⏳ Сохранение состояния в localStorage
- ⏳ Восстановление состояния при загрузке

### 4.2 useFilters.ts (новый)

```typescript
export function useFilters(initialFilters = {}) {
  const filters = ref(initialFilters)
  const hasActiveFilters = computed(() => ...)
  
  function setFilter(key, value) { ... }
  function clearFilter(key) { ... }
  function clearAllFilters() { ... }
  function applyFilters() { ... }
  
  return {
    filters,
    hasActiveFilters,
    setFilter,
    clearFilter,
    clearAllFilters,
    applyFilters
  }
}
```

### 4.3 useKeyboardShortcuts.ts (новый)

```typescript
export function useKeyboardShortcuts(handlers: {
  onInsert?: () => void
  onEnter?: () => void
  onF2?: () => void
  onDelete?: () => void
  onF5?: () => void
  onCtrlF?: () => void
  onCtrlA?: () => void
  onCtrlC?: () => void
  onEscape?: () => void
}) {
  // Регистрация обработчиков
  // Очистка при unmount
}
```

### 4.4 useContextMenu.ts (новый)

```typescript
export function useContextMenu() {
  const isOpen = ref(false)
  const position = ref({ x: 0, y: 0 })
  const targetRow = ref(null)
  
  function open(event, row) { ... }
  function close() { ... }
  
  return {
    isOpen,
    position,
    targetRow,
    open,
    close
  }
}
```

### 4.5 useExport.ts (новый)

```typescript
export function useExport() {
  async function exportToExcel(data, filename) { ... }
  async function exportToCSV(data, filename) { ... }
  
  return {
    exportToExcel,
    exportToCSV
  }
}
```

---

## 5. API расширения

### 5.1 Фильтрация на сервере

**Требуется добавить параметры:**

```python
# Для документов
@router.get("/estimates")
async def get_estimates(
    # Существующие
    page: int = 1,
    page_size: int = 25,
    search: str = None,
    sort_by: str = None,
    sort_order: str = "asc",
    
    # Новые фильтры
    date_from: date = None,
    date_to: date = None,
    object_id: int = None,
    counterparty_id: int = None,
    is_posted: bool = None,
    sum_from: float = None,
    sum_to: float = None,
    author_id: int = None,
    show_deleted: bool = False
)
```

### 5.2 Экспорт данных

```python
@router.get("/estimates/export")
async def export_estimates(
    format: str = "xlsx",  # xlsx, csv
    # ... все параметры фильтрации
)
```

---

## 6. План реализации

### Фаза 1: Базовые улучшения (1-2 дня)
1. ✅ Обновить DataTable.vue
2. ⏳ Создать DateRangePicker.vue
3. ⏳ Создать QuickPeriodSelector.vue
4. ⏳ Создать useFilters.ts
5. ⏳ Обновить useTable.ts

### Фаза 2: Формы документов (2-3 дня)
1. ⏳ Добавить фильтры в EstimateListView
2. ⏳ Добавить фильтры в TimesheetListView
3. ⏳ Добавить недостающие колонки
4. ⏳ Добавить иконки статусов
5. ⏳ Расширить API для фильтрации

### Фаза 3: Формы справочников (2-3 дня)
1. ⏳ Обновить CounterpartiesView
2. ⏳ Обновить ObjectsView
3. ⏳ Обновить PersonsView
4. ⏳ Обновить WorksView
5. ⏳ Добавить массовые операции

### Фаза 4: Дополнительные функции (2-3 дня)
1. ⏳ Создать ContextMenu.vue
2. ⏳ Создать useKeyboardShortcuts.ts
3. ⏳ Создать useContextMenu.ts
4. ⏳ Добавить контекстное меню во все формы
5. ⏳ Добавить горячие клавиши

### Фаза 5: Экспорт и печать (1-2 дня)
1. ⏳ Создать ExportButton.vue
2. ⏳ Создать useExport.ts
3. ⏳ Добавить API экспорта
4. ⏳ Добавить кнопки экспорта в формы
5. ⏳ Добавить печатные формы

### Фаза 6: Тестирование и доработка (2-3 дня)
1. ⏳ E2E тесты для форм списков
2. ⏳ Тестирование фильтров
3. ⏳ Тестирование массовых операций
4. ⏳ Тестирование горячих клавиш
5. ⏳ Оптимизация производительности

---

## 7. Метрики соответствия требованиям

### Структура формы
- ✅ Панель команд - 100%
- ✅ Панель поиска - 100%
- ✅ Панель фильтров - 100%
- ✅ Панель массовых операций - 100%
- ✅ Табличная часть - 100%
- ✅ Пагинация - 100%

### Функциональность
- ✅ Быстрый поиск - 100%
- ⏳ Расширенные фильтры - 0%
- ✅ Сортировка - 100%
- ✅ Массовые операции - 80%
- ⏳ Контекстное меню - 0%
- ⏳ Горячие клавиши - 40%
- ⏳ Экспорт данных - 0%

### Интерфейс
- ✅ Цветовая схема - 100%
- ✅ Иконки - 80%
- ✅ Адаптивность - 100%
- ✅ Доступность - 70%

### Общий прогресс: ~60%

---

## 8. Примеры использования

### 8.1 Форма с фильтрами

```vue
<template>
  <DataTable
    :columns="columns"
    :data="data"
    :loading="loading"
    :pagination="pagination"
    :selectable="true"
    :has-filters="true"
    @search="handleSearch"
    @sort="handleSort"
    @page-change="handlePageChange"
    @apply-filters="handleApplyFilters"
    @clear-filters="handleClearFilters"
    @refresh="loadData"
  >
    <template #filters>
      <DateRangePicker
        v-model:from="filters.dateFrom"
        v-model:to="filters.dateTo"
        label="Период"
      />
      <Picker
        v-model="filters.objectId"
        label="Объект"
        :items="objects"
      />
      <Select
        v-model="filters.isPosted"
        label="Статус"
        :options="[
          { value: null, label: 'Все' },
          { value: true, label: 'Проведенные' },
          { value: false, label: 'Не проведенные' }
        ]"
      />
    </template>
    
    <template #header-actions>
      <ExportButton @export="handleExport" />
      <button @click="handleCreate">Создать</button>
    </template>
    
    <template #bulk-actions="{ selected }">
      <button @click="handleBulkPost">Провести ({{ selected.length }})</button>
      <button @click="handleBulkDelete">Удалить ({{ selected.length }})</button>
    </template>
  </DataTable>
</template>
```

---

## Заключение

Компонент DataTable.vue обновлен в соответствии с требованиями. Следующие шаги:

1. Создать вспомогательные компоненты (DateRangePicker, QuickPeriodSelector и т.д.)
2. Обновить формы документов с добавлением фильтров
3. Обновить формы справочников
4. Добавить контекстное меню и горячие клавиши
5. Реализовать экспорт данных
6. Провести тестирование

Ожидаемое время реализации: 10-15 рабочих дней.
