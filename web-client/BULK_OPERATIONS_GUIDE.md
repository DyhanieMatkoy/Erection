# Руководство по групповым операциям

## Обзор

В web-клиенте добавлена функциональность групповых операций над документами в списках. Это позволяет выполнять действия сразу над несколькими документами.

## Доступные операции

### Для всех типов документов:
- **Групповое удаление** - удаление нескольких документов одновременно
- **Групповое проведение** - проведение нескольких документов (только для администраторов)
- **Отмена проведения** - отмена проведения нескольких документов (только для администраторов)

### Поддерживаемые документы:
- Сметы (Estimates)
- Ежедневные отчеты (Daily Reports)
- Табели (Timesheets)

## Использование

### 1. Выбор документов

В списке документов появились чекбоксы для выбора:

1. **Выбор отдельных документов**: кликните на чекбокс слева от строки документа
2. **Выбор всех документов на странице**: кликните на чекбокс в заголовке таблицы

### 2. Выполнение операций

После выбора документов появляются кнопки групповых операций:

- **Провести (N)** - зеленая кнопка для проведения выбранных документов
- **Отменить проведение (N)** - желтая кнопка для отмены проведения
- **Удалить (N)** - красная кнопка для удаления выбранных документов

Где N - количество выбранных документов.

### 3. Подтверждение

При нажатии на кнопку групповой операции появится диалог подтверждения с указанием количества документов.

### 4. Результат

После выполнения операции:
- Отображается сообщение с количеством успешно обработанных документов
- Если были ошибки, они отображаются в отдельном списке
- Выбор автоматически снимается
- Список документов обновляется

## Ограничения

### Групповое удаление
- Нельзя удалить проведенные документы
- Документы помечаются как удаленные (soft delete)

### Групповое проведение
- Доступно только администраторам
- Документы должны быть корректно заполнены
- Для смет: должны быть указаны все обязательные поля
- Для отчетов: должна быть связь со сметой

### Отмена проведения
- Доступно только администраторам
- Может быть недоступно, если документ используется в других документах

## API Endpoints

### Сметы
```
POST /api/documents/estimates/bulk-delete
POST /api/documents/estimates/bulk-post
POST /api/documents/estimates/bulk-unpost
```

### Ежедневные отчеты
```
POST /api/documents/daily-reports/bulk-delete
POST /api/documents/daily-reports/bulk-post
POST /api/documents/daily-reports/bulk-unpost
```

### Табели
```
POST /api/documents/timesheets/bulk-delete
POST /api/documents/timesheets/bulk-post
POST /api/documents/timesheets/bulk-unpost
```

### Формат запроса
```json
{
  "ids": [1, 2, 3, 4, 5]
}
```

### Формат ответа
```json
{
  "success": true,
  "deleted_count": 3,
  "posted_count": 3,
  "unposted_count": 3,
  "errors": [
    "Смета ID 4: Смета уже проведена",
    "Отчет ID 5: Отчет не найден"
  ],
  "message": "Удалено документов: 3"
}
```

## Технические детали

### Компонент DataTable

Обновлен компонент `DataTable.vue` с поддержкой:
- Prop `selectable` для включения режима выбора
- Event `selection-change` для отслеживания выбранных строк
- Slot `bulk-actions` для кнопок групповых операций
- Метод `clearSelection()` для программной очистки выбора

### Пример использования

```vue
<DataTable
  ref="tableRef"
  :columns="columns"
  :data="items"
  :selectable="true"
  @selection-change="handleSelectionChange"
>
  <template #bulk-actions="{ selected }">
    <div v-if="selected.length > 0" class="flex gap-2">
      <button @click="handleBulkPost">
        Провести ({{ selected.length }})
      </button>
      <button @click="handleBulkDelete">
        Удалить ({{ selected.length }})
      </button>
    </div>
  </template>
</DataTable>
```

## Безопасность

- Все операции проведения/отмены проведения требуют роль администратора
- Проверка прав выполняется на backend
- Каждая операция логируется
- Транзакции обеспечивают целостность данных

## Производительность

- Операции выполняются последовательно для каждого документа
- Для больших объемов (>50 документов) рекомендуется разбивать на несколько операций
- Таймаут операции: 60 секунд

## Обработка ошибок

Если операция не удалась для некоторых документов:
1. Успешно обработанные документы остаются в новом состоянии
2. Документы с ошибками остаются в исходном состоянии
3. Список ошибок отображается пользователю
4. Операция не откатывается полностью (partial success)

## Примеры использования

### Массовое проведение смет в конце месяца
1. Откройте список смет
2. Отфильтруйте по нужному периоду
3. Выберите все непроведенные сметы
4. Нажмите "Провести"
5. Проверьте результат

### Удаление тестовых данных
1. Откройте нужный список документов
2. Выберите тестовые документы
3. Нажмите "Удалить"
4. Подтвердите операцию

### Отмена ошибочного проведения
1. Откройте список документов
2. Выберите ошибочно проведенные документы
3. Нажмите "Отменить проведение"
4. Исправьте данные
5. Проведите заново
