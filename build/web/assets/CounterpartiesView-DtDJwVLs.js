import{d as H,f as u,g as O,h as Q,c as G,w as s,o as i,a,b as h,u as m,i as _,n as J,j as d,t as g,e as K,k as V,l as $,v as D}from"./index-OcrUBGsV.js";import{u as W,_ as X}from"./DataTable.vue_vue_type_script_setup_true_lang-CIOfCPly.js";import{u as Y}from"./useFilters-DiIRWo9Z.js";import{u as Z,g as ee,a as te,c as ae,d as le,b as ne}from"./references-C4ONrARJ.js";import{_ as oe}from"./AppLayout.vue_vue_type_script_setup_true_lang-C777ZaO3.js";import{_ as se}from"./Modal.vue_vue_type_script_setup_true_lang-BNdb9fbR.js";import{_ as re}from"./FormField.vue_vue_type_script_setup_true_lang-CJXR9oI6.js";import{_ as ie}from"./Picker.vue_vue_type_script_setup_true_lang-Je5YKjAW.js";const ue={class:"space-y-6"},de={key:0,class:"flex gap-2"},ce={key:0,class:"text-gray-500"},pe={key:1,class:"text-gray-400"},me={key:0,class:"text-sm text-gray-900"},fe={key:1,class:"text-gray-400"},ve={class:"flex items-center justify-center"},be=["title"],ge={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},ye={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},xe=["onClick"],he=["onClick"],_e={key:0,class:"rounded-md bg-red-50 p-4"},we={class:"text-sm text-red-800"},ke=["disabled"],je=H({__name:"CounterpartiesView",setup(Ce){const E=Z(),n=W(),w=u(),y=u([]),c=Y({type:null,isDeleted:null}),B=[{key:"code",label:"Код",width:"100px"},{key:"name",label:"Наименование",width:"300px"},{key:"inn",label:"ИНН",width:"120px"},{key:"phone",label:"Телефон",width:"150px"},{key:"email",label:"Email",width:"200px"},{key:"type",label:"Тип",width:"100px"},{key:"is_deleted",label:"Статус",width:"40px",sortable:!1}],b=u(!1),p=u(null),r=u({name:"",parent_id:null}),f=u({}),v=u(""),x=u(!1),F=O(()=>n.data.value.filter(t=>!t.is_deleted&&t.id!==p.value?.id).map(t=>({id:t.id,name:t.name})));function P(t){return n.data.value.find(l=>l.id===t)?.name||""}async function o(){n.loading.value=!0;try{const t={...n.queryParams.value,...c.getQueryParams()},e=await ee(t);n.data.value=e.data,n.pagination.value=e.pagination,await E.fetchCounterparties(!0)}catch(t){console.error("Failed to load counterparties:",t),alert(t.response?.data?.detail||"Ошибка при загрузке")}finally{n.loading.value=!1}}function j(){c.applyFilters(),n.setPage(1),o()}function M(){c.clearAllFilters(),n.setPage(1),o()}function L(t){n.setPage(t),o()}function N(t){n.setSearch(t),o()}function R(t,e){n.setSort(t,e),o()}function z(){p.value=null,r.value={name:"",parent_id:null},f.value={},v.value="",b.value=!0}function k(t){p.value=t,r.value={name:t.name,parent_id:t.parent_id},f.value={},v.value="",b.value=!0}async function C(){if(f.value={},!r.value.name.trim()){f.value.name="Обязательное поле";return}x.value=!0,v.value="";try{p.value?await te(p.value.id,r.value):await ae(r.value),b.value=!1,await o()}catch(t){const e=t;v.value=e.response?.data?.detail||"Ошибка при сохранении"}finally{x.value=!1}}async function U(t){if(confirm(`Удалить контрагента "${t.name}"?`))try{await le(t.id),await o()}catch(e){alert(e.response?.data?.detail||"Ошибка при удалении")}}function A(t){y.value=t}async function I(){if(y.value.length!==0&&confirm(`Удалить выбранные контрагенты (${y.value.length})?`))try{const t=y.value.map(l=>l.id),e=await ne(t);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),w.value?.clearSelection(),await o()}catch(t){alert(t.response?.data?.detail||"Ошибка при групповом удалении")}}function S(){b.value=!1,p.value=null}function T(t){return{customer:"Заказчик",contractor:"Подрядчик",supplier:"Поставщик"}[t]||t}return Q(()=>{o()}),(t,e)=>(i(),G(oe,null,{default:s(()=>[a("div",ue,[e[11]||(e[11]=a("div",null,[a("h2",{class:"text-2xl font-bold text-gray-900"},"Контрагенты"),a("p",{class:"mt-1 text-sm text-gray-600"},"Управление справочником контрагентов")],-1)),h(X,{ref_key:"tableRef",ref:w,columns:B,data:m(n).data.value,loading:m(n).loading.value,pagination:m(n).pagination.value,selectable:!0,"has-filters":!0,onRowClick:k,onPageChange:L,onSearch:N,onSort:R,onSelectionChange:A,onRefresh:o,onApplyFilters:j,onClearFilters:M},{filters:s(()=>[a("div",null,[e[5]||(e[5]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Тип",-1)),$(a("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>m(c).filters.value.type=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[4]||(e[4]=[a("option",{value:null},"Все типы",-1),a("option",{value:"customer"},"Заказчик",-1),a("option",{value:"contractor"},"Подрядчик",-1),a("option",{value:"supplier"},"Поставщик",-1)])],512),[[D,m(c).filters.value.type]])]),a("div",null,[e[7]||(e[7]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Статус",-1)),$(a("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>m(c).filters.value.isDeleted=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[6]||(e[6]=[a("option",{value:null},"Все",-1),a("option",{value:!1},"Активные",-1),a("option",{value:!0},"Удаленные",-1)])],512),[[D,m(c).filters.value.isDeleted]])])]),"bulk-actions":s(({selected:l})=>[l.length>0?(i(),d("div",de,[a("button",{onClick:I,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+g(l.length)+") ",1)])):V("",!0)]),"header-actions":s(()=>[a("button",{onClick:z,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},[...e[8]||(e[8]=[a("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),K(" Создать ",-1)])])]),"cell-parent_id":s(({row:l})=>[l.parent_id?(i(),d("span",ce,g(P(l.parent_id)),1)):(i(),d("span",pe,"—"))]),"cell-type":s(({value:l})=>[l?(i(),d("span",me,g(T(l)),1)):(i(),d("span",fe,"—"))]),"cell-is_deleted":s(({value:l})=>[a("div",ve,[a("span",{class:J(["inline-flex items-center justify-center w-6 h-6 rounded-full",l?"bg-red-100 text-red-600":"bg-green-100 text-green-600"]),title:l?"Удален":"Активен"},[l?(i(),d("svg",ge,[...e[9]||(e[9]=[a("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"},null,-1)])])):(i(),d("svg",ye,[...e[10]||(e[10]=[a("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])]))],10,be)])]),actions:s(({row:l})=>[a("button",{onClick:_(q=>k(l),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Изменить ",8,xe),a("button",{onClick:_(q=>U(l),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,he)]),_:1},8,["data","loading","pagination"]),h(se,{open:b.value,title:p.value?"Редактирование контрагента":"Создание контрагента",size:"md",onClose:S},{footer:s(()=>[a("button",{onClick:S,type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),a("button",{onClick:C,type:"button",disabled:x.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50"},g(x.value?"Сохранение...":"Сохранить"),9,ke)]),default:s(()=>[a("form",{onSubmit:_(C,["prevent"]),class:"space-y-4"},[h(re,{modelValue:r.value.name,"onUpdate:modelValue":e[2]||(e[2]=l=>r.value.name=l),label:"Наименование",type:"text",required:"",error:f.value.name},null,8,["modelValue","error"]),h(ie,{modelValue:r.value.parent_id,"onUpdate:modelValue":e[3]||(e[3]=l=>r.value.parent_id=l),label:"Родительский элемент",items:F.value,error:f.value.parent_id},null,8,["modelValue","items","error"]),v.value?(i(),d("div",_e,[a("p",we,g(v.value),1)])):V("",!0)],32)]),_:1},8,["open","title"])])]),_:1}))}});export{je as default};
