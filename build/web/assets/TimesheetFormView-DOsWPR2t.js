import{d as Q,f as $,g as k,p as X,j as i,a as e,k as c,e as N,F as E,m as S,t as y,i as Z,l as H,s as q,o as l,n as K,y as ee,z as te,h as se,c as z,w as ae,x as oe,b as F,u as J}from"./index-DUoOKtDv.js";import{u as re}from"./references-eDFEYnSt.js";import{u as le,_ as ne}from"./PrintDialog.vue_vue_type_script_setup_true_lang-Bo6HFs8v.js";import{getEstimates as ie,getTimesheet as de,autofillTimesheet as ue,createTimesheet as ce,updateTimesheet as me,postTimesheet as pe,unpostTimesheet as ve}from"./documents-ChgHnlwZ.js";import{_ as ye}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as W}from"./FormField.vue_vue_type_script_setup_true_lang-BL-nFudA.js";import{_ as G}from"./Picker.vue_vue_type_script_setup_true_lang-BLaBmckP.js";import"./Modal.vue_vue_type_script_setup_true_lang-pxS1gZgL.js";const fe={class:"bg-white shadow rounded-lg p-4 space-y-3"},be={class:"flex items-center justify-between"},he={class:"border border-gray-200 rounded-lg overflow-hidden"},xe={class:"flex"},ge={class:"flex-shrink-0 border-r border-gray-200"},_e={class:"divide-y divide-gray-200"},we={class:"bg-white divide-y divide-gray-200"},ke={key:0},$e={class:"px-2 py-1 whitespace-nowrap text-xs text-gray-900"},Ve={class:"px-2 py-1 whitespace-nowrap"},je=["onUpdate:modelValue","disabled","onInput"],Ce={key:1,class:"bg-gray-100 font-bold"},De={class:"flex-1 overflow-x-auto"},Ie={class:"divide-y divide-gray-200"},Ee={class:"bg-gray-50"},Se={class:"bg-white divide-y divide-gray-200"},Ae={key:0},Ue=["colspan"],Te=["onUpdate:modelValue","disabled","onInput"],Le={key:1,class:"bg-gray-100 font-bold"},Oe={class:"flex-shrink-0 border-l border-gray-200"},Fe={class:"divide-y divide-gray-200"},Ne={class:"bg-gray-50"},Pe={key:0,class:"px-2 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16"},Be={class:"bg-white divide-y divide-gray-200"},Me={key:0},Re=["colspan"],He={class:"px-2 py-1 whitespace-nowrap text-xs font-medium text-gray-900 bg-blue-50"},qe={class:"px-2 py-1 whitespace-nowrap text-xs font-medium text-gray-900 bg-blue-50"},ze={key:0,class:"px-2 py-1 whitespace-nowrap text-xs"},Ye=["onClick"],Ke={key:1,class:"bg-gray-100 font-bold"},Je={class:"px-2 py-1 text-xs bg-blue-100"},We={class:"px-2 py-1 text-xs bg-blue-100"},Ge={key:0},Qe={class:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col"},Xe={class:"px-6 py-4 overflow-y-auto flex-1"},Ze={class:"mb-4"},et={class:"space-y-2"},tt=["onClick"],st={class:"font-medium text-gray-900"},at={key:0,class:"text-sm text-gray-500"},ot={class:"px-6 py-4 border-t border-gray-200 flex justify-end"},rt=Q({__name:"TimesheetLines",props:{modelValue:{},persons:{},monthYear:{},disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(h,{emit:C}){const f=h,V=C,u=$([]),D=$(!1),b=$(""),_=k(()=>{if(!f.monthYear)return 31;const n=f.monthYear.split("-").map(Number),s=n[0],a=n[1];return!s||!a?31:new Date(s,a,0).getDate()}),t=k(()=>{const n=b.value.toLowerCase();return f.persons.filter(s=>!s.is_deleted&&(s.full_name.toLowerCase().includes(n)||s.position&&s.position.toLowerCase().includes(n)))}),x=k(()=>u.value.reduce((n,s)=>n+s.total_hours,0)),A=k(()=>u.value.reduce((n,s)=>n+s.total_amount,0));function p(n){return f.persons.find(a=>a.id===n)?.full_name||"Неизвестно"}function U(n){if(!f.monthYear)return!1;const s=f.monthYear.split("-").map(Number),a=s[0],d=s[1];if(!a||!d)return!1;const g=new Date(a,d-1,n).getDay();return g===0||g===6}function P(n){return u.value.reduce((s,a)=>{const d=a.days[n]||0;return s+(typeof d=="number"?d:0)},0)}function I(n){const s=u.value[n];s&&(s.total_hours=Object.values(s.days).reduce((a,d)=>a+(typeof d=="number"?d:0),0),s.total_amount=s.total_hours*s.hourly_rate,T())}function B(){b.value="",D.value=!0}function M(n){if(u.value.some(a=>a.employee_id===n.id)){alert("Этот сотрудник уже добавлен");return}const s={line_number:u.value.length+1,employee_id:n.id,employee_name:n.full_name,hourly_rate:0,days:{},total_hours:0,total_amount:0};for(let a=1;a<=_.value;a++)s.days[a]=0;u.value.push(s),D.value=!1,T()}function R(n){confirm("Удалить строку?")&&(u.value.splice(n,1),u.value.forEach((s,a)=>{s.line_number=a+1}),T())}function T(){V("update:modelValue",u.value)}function L(n){const s=n.target;if(n.key==="ArrowUp"||n.key==="ArrowDown"){n.preventDefault();const a=s.closest("td"),d=a?.closest("tr"),v=d?.closest("tbody");if(!a||!d||!v)return;const g=Array.from(v.querySelectorAll("tr")).filter(r=>!r.classList.contains("bg-gray-100")),j=g.indexOf(d),O=Array.from(d.querySelectorAll('input[type="number"]')).indexOf(s);if(O===-1)return;let o=j;if(n.key==="ArrowUp"&&j>0?o=j-1:n.key==="ArrowDown"&&j<g.length-1&&(o=j+1),o!==j){const r=g[o],w=Array.from(r.querySelectorAll('input[type="number"]'))[O];w&&(w.focus(),w.select())}}}return X(()=>f.modelValue,n=>{u.value=JSON.parse(JSON.stringify(n))},{immediate:!0,deep:!0}),(n,s)=>(l(),i("div",fe,[e("div",be,[s[4]||(s[4]=e("h3",{class:"text-base font-medium text-gray-900"},"Табличная часть",-1)),h.disabled?c("",!0):(l(),i("button",{key:0,onClick:B,class:"inline-flex items-center px-2 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...s[3]||(s[3]=[e("svg",{class:"h-4 w-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),N(" Добавить сотрудника ",-1)])]))]),e("div",he,[e("div",xe,[e("div",ge,[e("table",_e,[s[7]||(s[7]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-2 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40"}," Сотрудник "),e("th",{class:"px-2 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20"}," Ставка ")])],-1)),e("tbody",we,[u.value.length===0?(l(),i("tr",ke,[...s[5]||(s[5]=[e("td",{colspan:"2",class:"px-2 py-2 text-center text-xs text-gray-500"}," Нет данных ",-1)])])):c("",!0),(l(!0),i(E,null,S(u.value,(a,d)=>(l(),i("tr",{key:d,class:"hover:bg-gray-50"},[e("td",$e,y(p(a.employee_id)),1),e("td",Ve,[H(e("input",{"onUpdate:modelValue":v=>a.hourly_rate=v,type:"number",min:"0",step:"0.01",disabled:h.disabled,class:"w-16 rounded border-gray-300 text-xs text-center focus:border-blue-500 focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 no-spinner",onInput:v=>I(d),onKeydown:L},null,40,je),[[q,a.hourly_rate,void 0,{number:!0}]])])]))),128)),u.value.length>0?(l(),i("tr",Ce,[...s[6]||(s[6]=[e("td",{class:"px-2 py-1 text-xs text-gray-900"},"Итого:",-1),e("td",{class:"px-2 py-1"},null,-1)])])):c("",!0)])])]),e("div",De,[e("table",Ie,[e("thead",Ee,[e("tr",null,[(l(!0),i(E,null,S(_.value,a=>(l(),i("th",{key:a,class:K(["px-1 py-1.5 text-center text-xs font-medium w-14",U(a)?"bg-red-50 text-red-700":"text-gray-500"])},y(a),3))),128))])]),e("tbody",Se,[u.value.length===0?(l(),i("tr",Ae,[e("td",{colspan:_.value,class:"px-2 py-2 text-center text-xs text-gray-500"}," Добавьте сотрудников ",8,Ue)])):c("",!0),(l(!0),i(E,null,S(u.value,(a,d)=>(l(),i("tr",{key:d,class:"hover:bg-gray-50"},[(l(!0),i(E,null,S(_.value,v=>(l(),i("td",{key:v,class:"px-1 py-1"},[H(e("input",{"onUpdate:modelValue":g=>a.days[v]=g,type:"number",min:"0",max:"24",step:"0.5",disabled:h.disabled,class:K(["w-12 rounded border-gray-300 text-xs text-center focus:border-blue-500 focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 no-spinner",U(v)?"bg-red-50":""]),onInput:g=>I(d),onKeydown:L},null,42,Te),[[q,a.days[v],void 0,{number:!0}]])]))),128))]))),128)),u.value.length>0?(l(),i("tr",Le,[(l(!0),i(E,null,S(_.value,a=>(l(),i("td",{key:a,class:"px-1 py-1 text-center text-xs"},y(P(a).toFixed(1)),1))),128))])):c("",!0)])])]),e("div",Oe,[e("table",Fe,[e("thead",Ne,[e("tr",null,[s[8]||(s[8]=e("th",{class:"px-2 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 w-16"}," Итого ",-1)),s[9]||(s[9]=e("th",{class:"px-2 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 w-20"}," Сумма ",-1)),h.disabled?c("",!0):(l(),i("th",Pe))])]),e("tbody",Be,[u.value.length===0?(l(),i("tr",Me,[e("td",{colspan:h.disabled?2:3,class:"px-2 py-2 text-center text-xs text-gray-500"}," - ",8,Re)])):c("",!0),(l(!0),i(E,null,S(u.value,(a,d)=>(l(),i("tr",{key:d,class:"hover:bg-gray-50"},[e("td",He,y(a.total_hours.toFixed(1)),1),e("td",qe,y(a.total_amount.toFixed(0)),1),h.disabled?c("",!0):(l(),i("td",ze,[e("button",{onClick:v=>R(d),class:"text-red-600 hover:text-red-900",title:"Удалить"}," ✕ ",8,Ye)]))]))),128)),u.value.length>0?(l(),i("tr",Ke,[e("td",Je,y(x.value.toFixed(1)),1),e("td",We,y(A.value.toFixed(0)),1),h.disabled?c("",!0):(l(),i("td",Ge))])):c("",!0)])])])])]),D.value?(l(),i("div",{key:0,class:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50",onClick:s[2]||(s[2]=Z(a=>D.value=!1,["self"]))},[e("div",Qe,[s[10]||(s[10]=e("div",{class:"px-6 py-4 border-b border-gray-200"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Выбор сотрудника")],-1)),e("div",Xe,[e("div",Ze,[H(e("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>b.value=a),type:"text",placeholder:"Поиск...",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"},null,512),[[q,b.value]])]),e("div",et,[(l(!0),i(E,null,S(t.value,a=>(l(),i("button",{key:a.id,onClick:d=>M(a),class:"w-full text-left px-4 py-3 border border-gray-200 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"},[e("div",st,y(a.full_name),1),a.position?(l(),i("div",at,y(a.position),1)):c("",!0)],8,tt))),128))])]),e("div",ot,[e("button",{onClick:s[1]||(s[1]=a=>D.value=!1),class:"px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Отмена ")])])])):c("",!0)]))}}),lt=(h,C)=>{const f=h.__vccOpts||h;for(const[V,u]of C)f[V]=u;return f},nt=lt(rt,[["__scopeId","data-v-edec12b4"]]),it={class:"space-y-6"},dt={class:"flex items-center justify-between"},ut={class:"text-2xl font-bold text-gray-900"},ct={class:"mt-1 text-sm text-gray-600"},mt={class:"flex items-center space-x-2"},pt={key:0,class:"px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"},vt={class:"bg-white shadow rounded-lg p-6 space-y-6"},yt={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},ft={key:0,class:"mt-1 text-sm text-amber-600"},bt={class:"text-sm text-gray-600"},ht={class:"flex justify-between items-center"},xt=["disabled"],gt={class:"flex items-center space-x-3"},_t={key:0,class:"text-sm text-red-600"},wt=["disabled"],kt=["disabled"],$t=["disabled"],Ut=Q({__name:"TimesheetFormView",setup(h){const C=oe(),f=te(),V=re(),{isAdmin:u}=ee(),{printTimesheet:D}=le(),b=k(()=>f.params.id==="new"),_=$(!1),t=$({number:"",date:new Date().toISOString().split("T")[0],object_id:0,estimate_id:0,foreman_id:0,month_year:new Date().toISOString().slice(0,7),is_posted:!1,posted_at:null,marked_for_deletion:!1,lines:[]}),x=$({}),A=$(""),p=$(!1),U=$([]),P=k(()=>V.objects.filter(o=>!o.is_deleted).map(o=>({id:o.id,name:o.name}))),I=k(()=>{let o=U.value;return t.value.object_id&&(o=o.filter(r=>r.object_id===t.value.object_id)),o.map(r=>({id:r.id,name:`${r.number} от ${T(r.date)}`}))}),B=k(()=>I.value),M=k(()=>t.value.object_id?I.value.length===0?"Нет смет для выбранного объекта":`Выберите смету (доступно: ${I.value.length})`:"Сначала выберите объект"),R=k(()=>V.persons.filter(o=>!o.is_deleted));function T(o){return new Date(o).toLocaleDateString("ru-RU")}function L(o){if(!o)return"";const[r,m]=o.split("-");return new Date(parseInt(r),parseInt(m)-1).toLocaleDateString("ru-RU",{year:"numeric",month:"long"})}function n(){t.value.date&&(t.value.month_year=t.value.date.slice(0,7))}function s(){t.value.estimate_id=0}async function a(){if(!t.value.object_id||!t.value.estimate_id){alert("Выберите объект и смету");return}if(!(t.value.lines&&t.value.lines.length>0&&!confirm("Табличная часть содержит данные. Заменить их?"))){p.value=!0;try{const o=await ue(t.value.object_id,t.value.estimate_id,t.value.month_year);t.value.lines=o.lines}catch(o){alert(o.response?.data?.detail||"Ошибка при автозаполнении")}finally{p.value=!1}}}async function d(){if(b.value){t.value.number=`ТБ-${Date.now()}`;return}try{const o=await de(Number(f.params.id));t.value=o}catch(o){console.error("Failed to load timesheet:",o),alert("Ошибка загрузки табеля"),C.push("/documents/timesheets")}}async function v(){if(x.value={},t.value.number||(x.value.number="Обязательное поле"),t.value.date||(x.value.date="Обязательное поле"),t.value.object_id||(x.value.object_id="Обязательное поле"),!(Object.keys(x.value).length>0)){p.value=!0,A.value="";try{const o={...t.value,estimate_id:t.value.estimate_id||null,foreman_id:t.value.foreman_id||null};if(b.value){const r=await ce(o);C.push(`/documents/timesheets/${r.id}`)}else await me(t.value.id,o),await d()}catch(o){const r=o;A.value=r.response?.data?.detail||"Ошибка при сохранении"}finally{p.value=!1}}}async function g(){if(confirm("Провести табель?")){p.value=!0;try{await pe(t.value.id),await d()}catch(o){alert(o.response?.data?.detail||"Ошибка при проведении")}finally{p.value=!1}}}async function j(){if(confirm("Отменить проведение табеля?")){p.value=!0;try{await ve(t.value.id),await d()}catch(o){alert(o.response?.data?.detail||"Ошибка при отмене проведения")}finally{p.value=!1}}}function Y(){C.push("/documents/timesheets")}async function O(o,r){try{await D(t.value.id,o,r,`Табель_${t.value.number}`),_.value=!1}catch(m){console.error("Print failed:",m)}}return se(async()=>{await V.fetchObjects(),await V.fetchPersons();try{const o=[];let r=1,m=!0;for(;m;){const w=await ie({page:r,page_size:100});o.push(...w.data),m=!!(w.pagination&&r<w.pagination.total_pages),r++}U.value=o.filter(w=>!w.marked_for_deletion),console.log(`Loaded ${U.value.length} estimates`)}catch(o){console.error("Failed to load estimates:",o)}await d()}),(o,r)=>(l(),z(ye,null,{default:ae(()=>[e("div",it,[e("div",dt,[e("div",null,[e("h2",ut,y(b.value?"Новый табель":`Табель ${t.value.number}`),1),e("p",ct,y(b.value?"Создание нового табеля":"Редактирование табеля"),1)]),e("div",mt,[t.value.is_posted?(l(),i("span",pt," Проведен ")):c("",!0),e("button",{onClick:Y,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Назад ")])]),e("div",vt,[e("div",yt,[F(W,{modelValue:t.value.number,"onUpdate:modelValue":r[0]||(r[0]=m=>t.value.number=m),label:"Номер",required:"",disabled:t.value.is_posted,error:x.value.number},null,8,["modelValue","disabled","error"]),F(W,{modelValue:t.value.date,"onUpdate:modelValue":[r[1]||(r[1]=m=>t.value.date=m),n],label:"Дата",type:"date",required:"",disabled:t.value.is_posted,error:x.value.date},null,8,["modelValue","disabled","error"]),F(G,{modelValue:t.value.object_id,"onUpdate:modelValue":[r[2]||(r[2]=m=>t.value.object_id=m),s],label:"Объект",items:P.value,required:"",disabled:t.value.is_posted,error:x.value.object_id},null,8,["modelValue","items","disabled","error"]),e("div",null,[F(G,{modelValue:t.value.estimate_id,"onUpdate:modelValue":r[3]||(r[3]=m=>t.value.estimate_id=m),label:"Смета",items:B.value,disabled:t.value.is_posted||!t.value.object_id,error:x.value.estimate_id,placeholder:M.value},null,8,["modelValue","items","disabled","error","placeholder"]),t.value.object_id&&I.value.length===0?(l(),i("p",ft,' ⚠️ Для выбранного объекта нет смет. Создайте смету в разделе "Документы → Сметы". ')):c("",!0)])]),e("div",bt,[r[7]||(r[7]=e("strong",null,"Период:",-1)),N(" "+y(L(t.value.month_year)),1)])]),t.value.lines?(l(),z(nt,{key:0,modelValue:t.value.lines,"onUpdate:modelValue":r[4]||(r[4]=m=>t.value.lines=m),persons:R.value,"month-year":t.value.month_year,disabled:t.value.is_posted},null,8,["modelValue","persons","month-year","disabled"])):c("",!0),e("div",ht,[e("div",null,[!b.value&&!t.value.is_posted&&t.value.object_id&&t.value.estimate_id?(l(),i("button",{key:0,onClick:a,disabled:p.value,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"},[...r[8]||(r[8]=[e("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),N(" Заполнить из ежедневных отчетов ",-1)])],8,xt)):c("",!0)]),e("div",gt,[A.value?(l(),i("div",_t,y(A.value),1)):c("",!0),b.value?c("",!0):(l(),i("button",{key:1,onClick:r[5]||(r[5]=m=>_.value=!0),class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...r[9]||(r[9]=[e("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1),N(" Печать ",-1)])])),!b.value&&J(u)&&!t.value.is_posted?(l(),i("button",{key:2,onClick:g,disabled:p.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50"}," Провести ",8,wt)):c("",!0),!b.value&&J(u)&&t.value.is_posted?(l(),i("button",{key:3,onClick:j,disabled:p.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"}," Отменить проведение ",8,kt)):c("",!0),t.value.is_posted?c("",!0):(l(),i("button",{key:4,onClick:v,disabled:p.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"},y(p.value?"Сохранение...":"Сохранить"),9,$t))])])]),t.value.id?(l(),z(ne,{key:0,open:_.value,"document-type":"timesheet","document-id":t.value.id,"document-name":`Табель_${t.value.number}`,onClose:r[6]||(r[6]=m=>_.value=!1),onPrint:O},null,8,["open","document-id","document-name"])):c("",!0)]),_:1}))}});export{Ut as default};
