import{d as H,f as g,h as Q,c as G,w as m,a as o,b as h,j as c,k as $,i as D,n as J,e as v,t as f,u as a,l as y,v as x,m as _,F as T,x as K,o as u}from"./index-DUoOKtDv.js";import{u as W,_ as X}from"./DataTable.vue_vue_type_script_setup_true_lang-DTxzDPkq.js";import{u as Z}from"./useFilters-CZ5mbCA9.js";import{u as ee}from"./references-eDFEYnSt.js";import{getTimesheets as te,getEstimates as le,deleteTimesheet as oe,bulkDeleteTimesheets as re,bulkPostTimesheets as ae,bulkUnpostTimesheets as ne}from"./documents-ChgHnlwZ.js";import{_ as se}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as j}from"./DateRangePicker.vue_vue_type_script_setup_true_lang-_kJAyLKD.js";const ie={class:"space-y-6"},ue=["value"],de=["value"],me={key:0,class:"flex gap-2"},ce={class:"flex items-center justify-center"},fe=["title"],pe={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},ge={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},be=["onClick"],he=["onClick"],$e=H({__name:"TimesheetListView",setup(ve){const w=K(),n=W(),k=ee(),p=g(),i=g([]),r=Z({dateFrom:null,dateTo:null,periodFrom:null,periodTo:null,objectId:null,estimateId:null,isPosted:null}),C=g([]),b=g([]),E=[{key:"number",label:"Номер",width:"100px"},{key:"date",label:"Дата",width:"100px"},{key:"is_posted",label:"Статус",width:"40px",sortable:!1},{key:"month_year",label:"Период",width:"150px"},{key:"object_name",label:"Объект",width:"250px"},{key:"estimate_number",label:"Смета",width:"120px"},{key:"foreman_name",label:"Бригадир",width:"200px"},{key:"total_hours",label:"Часов",width:"100px"},{key:"author",label:"Автор",width:"150px"}];function P(l){return new Date(l).toLocaleDateString("ru-RU")}function U(l){const[e,t]=l.split("-");return new Date(parseInt(e),parseInt(t)-1).toLocaleDateString("ru-RU",{year:"numeric",month:"long"})}async function s(){n.loading.value=!0;try{const l={...n.queryParams.value,...r.getQueryParams()},e=await te(l);n.data.value=e.data,n.pagination.value=e.pagination}catch(l){console.error("Failed to load timesheets:",l),alert(l.response?.data?.detail||"Ошибка при загрузке")}finally{n.loading.value=!1}}async function B(){try{await k.fetchConstructionObjects(),C.value=k.constructionObjects;const l=[];let e=1,t=!0;for(;t;){const d=await le({page:e,page_size:100});l.push(...d.data),t=!!(d.pagination&&e<d.pagination.total_pages),e++}b.value=l,console.log(`Loaded ${b.value.length} estimates`)}catch(l){console.error("Failed to load references:",l)}}function I(){r.applyFilters(),n.setPage(1),s()}function M(){r.clearAllFilters(),n.setPage(1),s()}function R(l){n.setPage(l),s()}function V(l){n.setSearch(l),s()}function L(l,e){n.setSort(l,e),s()}function N(){w.push("/documents/timesheets/new")}function F(l){w.push(`/documents/timesheets/${l.id}`)}async function Y(l){if(confirm(`Удалить табель ${l.number}?`))try{await oe(l.id),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при удалении")}}function z(l){i.value=l}async function A(){if(i.value.length!==0&&confirm(`Удалить выбранные табели (${i.value.length})?`))try{const l=i.value.map(t=>t.id),e=await re(l);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),p.value?.clearSelection(),await s()}catch(l){alert(l.response?.data?.detail||"Ошибка при групповом удалении")}}async function O(){if(i.value.length!==0&&confirm(`Провести выбранные табели (${i.value.length})?`))try{const l=i.value.map(t=>t.id),e=await ae(l);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),p.value?.clearSelection(),await s()}catch(l){alert(l.response?.data?.detail||"Ошибка при групповом проведении")}}async function q(){if(i.value.length!==0&&confirm(`Отменить проведение выбранных табелей (${i.value.length})?`))try{const l=i.value.map(t=>t.id),e=await ne(l);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),p.value?.clearSelection(),await s()}catch(l){alert(l.response?.data?.detail||"Ошибка при отмене проведения")}}Q(async()=>{await B();const l=new Date,e=new Date(l.getFullYear(),l.getMonth(),1),t=new Date(l.getFullYear(),l.getMonth()+1,0);r.filters.value.dateFrom=S(e),r.filters.value.dateTo=S(t),r.applyFilters(),s()});function S(l){const e=l.getFullYear(),t=String(l.getMonth()+1).padStart(2,"0"),d=String(l.getDate()).padStart(2,"0");return`${e}-${t}-${d}`}return(l,e)=>(u(),G(se,null,{default:m(()=>[o("div",ie,[e[16]||(e[16]=o("div",null,[o("h2",{class:"text-2xl font-bold text-gray-900"},"Табели"),o("p",{class:"mt-1 text-sm text-gray-600"},"Управление табелями учета рабочего времени")],-1)),h(X,{ref_key:"tableRef",ref:p,columns:E,data:a(n).data.value,loading:a(n).loading.value,pagination:a(n).pagination.value,selectable:!0,"has-filters":!0,onRowClick:F,onPageChange:R,onSearch:V,onSort:L,onSelectionChange:z,onRefresh:s,onApplyFilters:I,onClearFilters:M},{filters:m(()=>[h(j,{from:a(r).filters.value.dateFrom,"onUpdate:from":e[0]||(e[0]=t=>a(r).filters.value.dateFrom=t),to:a(r).filters.value.dateTo,"onUpdate:to":e[1]||(e[1]=t=>a(r).filters.value.dateTo=t),label:"Период документа"},null,8,["from","to"]),h(j,{from:a(r).filters.value.periodFrom,"onUpdate:from":e[2]||(e[2]=t=>a(r).filters.value.periodFrom=t),to:a(r).filters.value.periodTo,"onUpdate:to":e[3]||(e[3]=t=>a(r).filters.value.periodTo=t),label:"Табельный период","show-quick-periods":!1},null,8,["from","to"]),o("div",null,[e[8]||(e[8]=o("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Объект",-1)),y(o("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a(r).filters.value.objectId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[7]||(e[7]=o("option",{value:null},"Все объекты",-1)),(u(!0),c(T,null,_(C.value,t=>(u(),c("option",{key:t.id,value:t.id},f(t.name),9,ue))),128))],512),[[x,a(r).filters.value.objectId]])]),o("div",null,[e[10]||(e[10]=o("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Смета",-1)),y(o("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>a(r).filters.value.estimateId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[9]||(e[9]=o("option",{value:null},"Все сметы",-1)),(u(!0),c(T,null,_(b.value,t=>(u(),c("option",{key:t.id,value:t.id},f(t.number)+" - "+f(t.object_name),9,de))),128))],512),[[x,a(r).filters.value.estimateId]])]),o("div",null,[e[12]||(e[12]=o("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Статус проведения",-1)),y(o("select",{"onUpdate:modelValue":e[6]||(e[6]=t=>a(r).filters.value.isPosted=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[11]||(e[11]=[o("option",{value:null},"Все",-1),o("option",{value:!0},"Проведенные",-1),o("option",{value:!1},"Не проведенные",-1)])],512),[[x,a(r).filters.value.isPosted]])])]),"bulk-actions":m(({selected:t})=>[t.length>0?(u(),c("div",me,[o("button",{onClick:O,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"}," Провести ("+f(t.length)+") ",1),o("button",{onClick:q,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700"}," Отменить проведение ("+f(t.length)+") ",1),o("button",{onClick:A,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+f(t.length)+") ",1)])):$("",!0)]),"header-actions":m(()=>[o("button",{onClick:N,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...e[13]||(e[13]=[o("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),v(" Создать табель ",-1)])])]),"cell-date":m(({value:t})=>[v(f(P(t)),1)]),"cell-month_year":m(({value:t})=>[v(f(U(t)),1)]),"cell-is_posted":m(({value:t})=>[o("div",ce,[o("span",{class:J(["inline-flex items-center justify-center w-6 h-6 rounded-full",t?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400"]),title:t?"Проведен":"Не проведен"},[t?(u(),c("svg",pe,[...e[14]||(e[14]=[o("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])])):(u(),c("svg",ge,[...e[15]||(e[15]=[o("circle",{cx:"10",cy:"10",r:"3"},null,-1)])]))],10,fe)])]),actions:m(({row:t})=>[o("button",{onClick:D(d=>F(t),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Открыть ",8,be),t.is_posted?$("",!0):(u(),c("button",{key:0,onClick:D(d=>Y(t),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,he))]),_:1},8,["data","loading","pagination"])])]),_:1}))}});export{$e as default};
