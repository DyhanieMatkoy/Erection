import{d as B,f as g,g as k,p as Q,j as n,o as r,a as t,k as b,b as w,n as V,t as c,w as M,l as R,i as I,s as E,F as K,m as j,T as G,c as z,y as J,z as W,h as X,x as Y,e as Z,u as L}from"./index-DUoOKtDv.js";import{u as ee}from"./references-eDFEYnSt.js";import{u as te,_ as ae}from"./PrintDialog.vue_vue_type_script_setup_true_lang-Bo6HFs8v.js";import{getEstimates as se,getDailyReport as le,getEstimate as oe,createDailyReport as re,updateDailyReport as ne,postDailyReport as de,unpostDailyReport as ie}from"./documents-ChgHnlwZ.js";import{_ as ue}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as ce}from"./FormField.vue_vue_type_script_setup_true_lang-BL-nFudA.js";import{_ as N}from"./Picker.vue_vue_type_script_setup_true_lang-BLaBmckP.js";import"./Modal.vue_vue_type_script_setup_true_lang-pxS1gZgL.js";const me={class:"relative"},pe=["disabled"],ye={key:0,class:"block truncate"},ve={key:1,class:"block truncate text-gray-400"},xe={key:0,class:"mt-1 text-sm text-red-600"},fe={key:0,class:"absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"},be={class:"sticky top-0 bg-white px-2 py-2 border-b border-gray-200"},ge={key:0},_e=["onClick"],he={class:"flex items-center"},we=["checked","onClick"],ke={key:1,class:"py-2 px-3 text-sm text-gray-500"},S=B({__name:"MultiPicker",props:{modelValue:{default:()=>[]},items:{},valueKey:{default:"id"},displayKey:{default:"name"},placeholder:{default:"Выберите..."},disabled:{type:Boolean},error:{}},emits:["update:modelValue"],setup(u,{emit:_}){const p=u,h=_,m=g(!1),y=g(""),f=k(()=>p.items.filter(d=>p.modelValue?.includes(d[p.valueKey]))),v=k(()=>{if(!y.value)return p.items;const d=y.value.toLowerCase();return p.items.filter(a=>{const i=a[p.displayKey];return typeof i=="string"&&i.toLowerCase().includes(d)})});function e(d){return p.modelValue?.includes(d)||!1}function s(d){const a=d[p.valueKey],i=p.modelValue||[];e(a)?h("update:modelValue",i.filter($=>$!==a)):h("update:modelValue",[...i,a])}return Q(m,d=>{d||(y.value="")}),(d,a)=>(r(),n("div",me,[t("button",{type:"button",disabled:u.disabled,class:V(["relative w-full cursor-pointer rounded-md border bg-white py-2 pl-3 pr-10 text-left shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 sm:text-sm",u.error?"border-red-300":"border-gray-300",u.disabled?"bg-gray-100 cursor-not-allowed":""]),onClick:a[0]||(a[0]=i=>m.value=!m.value)},[f.value.length>0?(r(),n("span",ye,c(f.value.map(i=>i[u.displayKey]).join(", ")),1)):(r(),n("span",ve,c(u.placeholder),1)),a[4]||(a[4]=t("span",{class:"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2"},[t("svg",{class:"h-5 w-5 text-gray-400",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z","clip-rule":"evenodd"})])],-1))],10,pe),u.error?(r(),n("p",xe,c(u.error),1)):b("",!0),w(G,{"leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:M(()=>[m.value?(r(),n("div",fe,[t("div",be,[R(t("input",{"onUpdate:modelValue":a[1]||(a[1]=i=>y.value=i),type:"text",placeholder:"Поиск...",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm",onClick:a[2]||(a[2]=I(()=>{},["stop"]))},null,512),[[E,y.value]])]),v.value.length>0?(r(),n("div",ge,[(r(!0),n(K,null,j(v.value,i=>(r(),n("div",{key:i[u.valueKey],class:V(["relative cursor-pointer select-none py-2 pl-3 pr-9 hover:bg-gray-100",e(i[u.valueKey])?"bg-blue-50 text-blue-900":"text-gray-900"]),onClick:$=>s(i)},[t("div",he,[t("input",{type:"checkbox",checked:e(i[u.valueKey]),class:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3",onClick:I($=>s(i),["stop"])},null,8,we),t("span",{class:V(["block truncate",e(i[u.valueKey])?"font-semibold":"font-normal"])},c(i[u.displayKey]),3)])],10,_e))),128))])):(r(),n("div",ke,"Ничего не найдено"))])):b("",!0)]),_:1}),m.value?(r(),n("div",{key:1,class:"fixed inset-0 z-0",onClick:a[3]||(a[3]=i=>m.value=!1)})):b("",!0)]))}}),$e={class:"bg-white shadow rounded-lg p-6 space-y-4"},Ve={class:"hidden md:block overflow-x-auto"},Ce={class:"min-w-full divide-y divide-gray-200"},De={class:"bg-white divide-y divide-gray-200"},Ue={class:"px-3 py-2 text-sm text-gray-900"},Re={class:"px-3 py-2 text-sm text-gray-900"},Ee={class:"px-3 py-2 text-sm text-gray-900"},Ke={class:"px-3 py-2"},je=["onUpdate:modelValue","onInput"],ze={key:1,class:"text-sm text-gray-900"},Be={class:"px-3 py-2"},Fe={key:1,class:"text-sm text-gray-900"},Ie={key:0},Le={class:"md:hidden space-y-4"},Ne={class:"flex items-center justify-between"},Se={class:"text-sm font-medium text-gray-500"},Me={class:"space-y-2"},Pe={class:"text-sm text-gray-900"},Te={class:"grid grid-cols-2 gap-2"},qe={class:"text-sm text-gray-900"},Ae=["onUpdate:modelValue","onInput"],He={key:1,class:"text-sm text-gray-900"},Oe={key:1,class:"text-sm text-gray-900"},Qe={key:0,class:"text-center py-8 text-sm text-gray-500"},Ge=B({__name:"DailyReportLines",props:{modelValue:{},persons:{},disabled:{type:Boolean}},emits:["update:modelValue"],setup(u,{emit:_}){const p=u,h=_,m=k({get:()=>p.modelValue||[],set:v=>h("update:modelValue",v)});function y(v){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v)}function f(v){const e=m.value[v];e.deviation=e.actual_labor-e.planned_labor}return(v,e)=>(r(),n("div",$e,[e[7]||(e[7]=t("h3",{class:"text-lg font-medium text-gray-900"},"Строки отчета",-1)),t("div",Ve,[t("table",Ce,[e[1]||(e[1]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12"},"#"),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Работа"),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," План. труд. "),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Факт. труд. "),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Отклонение "),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Исполнители ")])],-1)),t("tbody",De,[(r(!0),n(K,null,j(m.value,(s,d)=>(r(),n("tr",{key:d},[t("td",Ue,c(d+1),1),t("td",Re,c(s.work_name),1),t("td",Ee,c(y(s.planned_labor)),1),t("td",Ke,[u.disabled?(r(),n("span",ze,c(y(s.actual_labor)),1)):R((r(),n("input",{key:0,"onUpdate:modelValue":a=>s.actual_labor=a,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:a=>f(d)},null,40,je)),[[E,s.actual_labor,void 0,{number:!0}]])]),t("td",{class:V(["px-3 py-2 text-sm font-medium",s.deviation>=0?"text-green-600":"text-red-600"])},c(y(s.deviation)),3),t("td",Be,[u.disabled?(r(),n("span",Fe,c(s.executor_names?.join(", ")||"—"),1)):(r(),z(S,{key:0,modelValue:s.executors,"onUpdate:modelValue":a=>s.executors=a,items:u.persons,"display-key":"full_name",placeholder:"Выберите исполнителей"},null,8,["modelValue","onUpdate:modelValue","items"]))])]))),128)),m.value.length===0?(r(),n("tr",Ie,[...e[0]||(e[0]=[t("td",{colspan:"6",class:"px-3 py-8 text-center text-sm text-gray-500"}," Нет строк. Выберите смету для автозаполнения. ",-1)])])):b("",!0)])])]),t("div",Le,[(r(!0),n(K,null,j(m.value,(s,d)=>(r(),n("div",{key:d,class:"border border-gray-200 rounded-lg p-4 space-y-3"},[t("div",Ne,[t("span",Se,"Строка "+c(d+1),1)]),t("div",Me,[t("div",null,[e[2]||(e[2]=t("label",{class:"block text-xs font-medium text-gray-500"},"Работа",-1)),t("span",Pe,c(s.work_name),1)]),t("div",Te,[t("div",null,[e[3]||(e[3]=t("label",{class:"block text-xs font-medium text-gray-500"},"План. труд.",-1)),t("span",qe,c(y(s.planned_labor)),1)]),t("div",null,[e[4]||(e[4]=t("label",{class:"block text-xs font-medium text-gray-500"},"Факт. труд.",-1)),u.disabled?(r(),n("span",He,c(y(s.actual_labor)),1)):R((r(),n("input",{key:0,"onUpdate:modelValue":a=>s.actual_labor=a,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:a=>f(d)},null,40,Ae)),[[E,s.actual_labor,void 0,{number:!0}]])])]),t("div",null,[e[5]||(e[5]=t("label",{class:"block text-xs font-medium text-gray-500"},"Отклонение",-1)),t("span",{class:V(["text-sm font-medium",s.deviation>=0?"text-green-600":"text-red-600"])},c(y(s.deviation)),3)]),t("div",null,[e[6]||(e[6]=t("label",{class:"block text-xs font-medium text-gray-500"},"Исполнители",-1)),u.disabled?(r(),n("span",Oe,c(s.executor_names?.join(", ")||"—"),1)):(r(),z(S,{key:0,modelValue:s.executors,"onUpdate:modelValue":a=>s.executors=a,items:u.persons,"display-key":"full_name",placeholder:"Выберите исполнителей"},null,8,["modelValue","onUpdate:modelValue","items"]))])])]))),128)),m.value.length===0?(r(),n("div",Qe," Нет строк. Выберите смету для автозаполнения. ")):b("",!0)])]))}}),Je={class:"space-y-6"},We={class:"flex items-center justify-between"},Xe={class:"text-2xl font-bold text-gray-900"},Ye={class:"mt-1 text-sm text-gray-600"},Ze={class:"flex items-center space-x-2"},et={key:0,class:"px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"},tt={class:"bg-white shadow rounded-lg p-6 space-y-6"},at={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},st={class:"flex justify-between items-center"},lt={key:0,class:"text-sm text-red-600"},ot={class:"flex space-x-3 ml-auto"},rt=["disabled"],nt=["disabled"],dt=["disabled"],ft=B({__name:"DailyReportFormView",setup(u){const _=Y(),p=W(),h=ee(),{isAdmin:m}=J(),{printDailyReport:y}=te(),f=k(()=>p.params.id==="new"),v=g(!1),e=g({date:new Date().toISOString().split("T")[0],estimate_id:0,foreman_id:0,is_posted:!1,posted_at:null,is_deleted:!1,lines:[]}),s=g({}),d=g(""),a=g(!1),i=g([]),$=k(()=>i.value.map(l=>({id:l.id,name:`${l.number} от ${C(l.date)} (${l.object_name})`}))),F=k(()=>h.persons.filter(l=>!l.is_deleted));function C(l){return new Date(l).toLocaleDateString("ru-RU")}async function P(){if(e.value.estimate_id)try{const l=await oe(e.value.estimate_id);e.value.lines=(l.lines||[]).filter(o=>!o.is_group).map(o=>({estimate_line_id:o.id,work_id:o.work_id,work_name:o.work_name,planned_labor:o.labor,actual_labor:0,deviation:-o.labor,executors:[]}))}catch(l){console.error("Failed to load estimate:",l)}}async function D(){if(!f.value)try{const l=await le(Number(p.params.id));e.value=l}catch(l){console.error("Failed to load daily report:",l),alert("Ошибка загрузки отчета"),_.push("/documents/daily-reports")}}async function T(){if(s.value={},e.value.date||(s.value.date="Обязательное поле"),e.value.estimate_id||(s.value.estimate_id="Обязательное поле"),e.value.foreman_id||(s.value.foreman_id="Обязательное поле"),!(Object.keys(s.value).length>0)){a.value=!0,d.value="";try{if(f.value){const l=await re(e.value);_.push(`/documents/daily-reports/${l.id}`)}else await ne(e.value.id,e.value),await D()}catch(l){const o=l;d.value=o.response?.data?.detail||"Ошибка при сохранении"}finally{a.value=!1}}}async function q(){if(confirm("Провести отчет?")){a.value=!0;try{await de(e.value.id),await D()}catch(l){alert(l.response?.data?.detail||"Ошибка при проведении")}finally{a.value=!1}}}async function A(){if(confirm("Отменить проведение отчета?")){a.value=!0;try{await ie(e.value.id),await D()}catch(l){alert(l.response?.data?.detail||"Ошибка при отмене проведения")}finally{a.value=!1}}}function H(){_.push("/documents/daily-reports")}async function O(l,o){try{await y(e.value.id,l,o,`Отчет_${C(e.value.date)}`),v.value=!1}catch(x){console.error("Print failed:",x)}}return X(async()=>{await h.fetchPersons();try{const l=[];let o=1,x=!0;for(;x;){const U=await se({page:o,page_size:100});l.push(...U.data),x=!!(U.pagination&&o<U.pagination.total_pages),o++}i.value=l,console.log(`Loaded ${i.value.length} estimates`)}catch(l){console.error("Failed to load estimates:",l)}await D()}),(l,o)=>(r(),z(ue,null,{default:M(()=>[t("div",Je,[t("div",We,[t("div",null,[t("h2",Xe,c(f.value?"Новый ежедневный отчет":`Отчет от ${C(e.value.date)}`),1),t("p",Ye,c(f.value?"Создание нового отчета":"Редактирование отчета"),1)]),t("div",Ze,[e.value.is_posted?(r(),n("span",et," Проведен ")):b("",!0),t("button",{onClick:H,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Назад ")])]),t("div",tt,[t("div",at,[w(ce,{modelValue:e.value.date,"onUpdate:modelValue":o[0]||(o[0]=x=>e.value.date=x),label:"Дата",type:"date",required:"",disabled:e.value.is_posted,error:s.value.date},null,8,["modelValue","disabled","error"]),w(N,{modelValue:e.value.estimate_id,"onUpdate:modelValue":[o[1]||(o[1]=x=>e.value.estimate_id=x),P],label:"Смета",items:$.value,required:"",disabled:e.value.is_posted,error:s.value.estimate_id},null,8,["modelValue","items","disabled","error"]),w(N,{modelValue:e.value.foreman_id,"onUpdate:modelValue":o[2]||(o[2]=x=>e.value.foreman_id=x),label:"Бригадир",items:F.value,"display-key":"full_name",required:"",disabled:e.value.is_posted,error:s.value.foreman_id},null,8,["modelValue","items","disabled","error"])])]),w(Ge,{modelValue:e.value.lines,"onUpdate:modelValue":o[3]||(o[3]=x=>e.value.lines=x),persons:F.value,disabled:e.value.is_posted},null,8,["modelValue","persons","disabled"]),t("div",st,[d.value?(r(),n("div",lt,c(d.value),1)):b("",!0),t("div",ot,[f.value?b("",!0):(r(),n("button",{key:0,onClick:o[4]||(o[4]=x=>v.value=!0),class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...o[6]||(o[6]=[t("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1),Z(" Печать ",-1)])])),!f.value&&L(m)&&!e.value.is_posted?(r(),n("button",{key:1,onClick:q,disabled:a.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50"}," Провести ",8,rt)):b("",!0),!f.value&&L(m)&&e.value.is_posted?(r(),n("button",{key:2,onClick:A,disabled:a.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"}," Отменить проведение ",8,nt)):b("",!0),e.value.is_posted?b("",!0):(r(),n("button",{key:3,onClick:T,disabled:a.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"},c(a.value?"Сохранение...":"Сохранить"),9,dt))])])]),w(ae,{open:v.value,"document-type":"daily-report","document-id":e.value.id,"document-name":`Отчет_${C(e.value.date)}`,onClose:o[5]||(o[5]=x=>v.value=!1),onPrint:O},null,8,["open","document-id","document-name"])]),_:1}))}});export{ft as default};
