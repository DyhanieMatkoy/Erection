import{d as re,f as b,h as se,c as ne,w as m,a as l,b as _,j as p,k as B,i as C,n as V,e as x,t as u,u as s,l as y,v as E,m as F,F as $,s as L,x as ae,o as d}from"./index-DUoOKtDv.js";import{u as ie,_ as ue}from"./DataTable.vue_vue_type_script_setup_true_lang-DTxzDPkq.js";import{u as de}from"./useFilters-CZ5mbCA9.js";import{u as ce}from"./references-eDFEYnSt.js";import{getEstimates as me,getTimesheets as pe,importEstimateFromExcel as fe,printEstimate as be,deleteEstimate as ge,bulkDeleteEstimates as xe,bulkPostEstimates as ye,bulkUnpostEstimates as ve}from"./documents-ChgHnlwZ.js";import{_ as he}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as we}from"./DateRangePicker.vue_vue_type_script_setup_true_lang-_kJAyLKD.js";import{_ as ke}from"./Modal.vue_vue_type_script_setup_true_lang-pxS1gZgL.js";const Ce={class:"space-y-6"},_e=["value"],Ee=["value"],Fe={key:0,class:"flex gap-2"},$e={class:"flex items-center justify-center"},Se=["title"],De={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},je={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},Te=["onClick"],Pe=["onClick"],Re=["onClick"],Ue=["onClick"],Me={class:"space-y-4"},Ie={class:"max-h-96 overflow-y-auto border border-gray-300 rounded-md"},Be={class:"min-w-full divide-y divide-gray-200"},Ve={class:"bg-white divide-y divide-gray-200"},Le=["onClick"],Ne={class:"px-3 py-2 text-center"},ze=["checked","onChange"],Ae={class:"px-3 py-2 text-sm"},Oe={class:"px-3 py-2 text-sm"},Ye={class:"px-3 py-2 text-sm"},He={class:"px-3 py-2 text-sm"},qe=["disabled"],lt=re({__name:"EstimateListView",setup(Qe){const v=ae(),a=ie(),h=ce(),w=b(),c=b([]),S=b(),k=b(!1),D=b([]),f=b(null),r=de({dateFrom:null,dateTo:null,objectId:null,customerId:null,isPosted:null,sumFrom:null,sumTo:null}),j=b([]),T=b([]),N=[{key:"number",label:"Номер",width:"100px"},{key:"date",label:"Дата",width:"100px"},{key:"is_posted",label:"Статус",width:"40px",sortable:!1},{key:"customer_name",label:"Заказчик",width:"200px"},{key:"object_name",label:"Объект",width:"250px"},{key:"total_sum",label:"Сумма",width:"120px"},{key:"author",label:"Автор",width:"150px"}];function P(o){return new Date(o).toLocaleDateString("ru-RU")}function z(o){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}async function i(){a.loading.value=!0;try{const o={...a.queryParams.value,...r.getQueryParams()},e=await me(o);a.data.value=e.data,a.pagination.value=e.pagination}catch(o){console.error("Failed to load estimates:",o)}finally{a.loading.value=!1}}async function A(){try{await h.fetchObjects(),await h.fetchCounterparties(),j.value=h.objects,T.value=h.counterparties}catch(o){console.error("Failed to load references:",o)}}function O(){r.applyFilters(),a.setPage(1),i()}function Y(){r.clearAllFilters(),a.setPage(1),i()}function H(o){a.setPage(o),i()}function q(o){a.setSearch(o),i()}function Q(o,e){a.setSort(o,e),i()}function G(){v.push("/documents/estimates/new")}async function J(){try{const o=await pe({page:1,page_size:100,sort_by:"date",sort_order:"desc"});D.value=o.data,f.value=null,k.value=!0}catch(o){alert(o.response?.data?.detail||"Ошибка при загрузке ежедневных отчетов")}}async function K(){if(!f.value){alert("Выберите ежедневный отчет");return}k.value=!1,v.push(`/documents/estimates/new?timesheet_id=${f.value}`)}function R(){k.value=!1,f.value=null}function W(){S.value?.click()}async function X(o){const e=o.target,t=e.files?.[0];if(t)try{const n=await fe(t);alert(`Смета "${n.number}" успешно импортирована`),await i(),v.push(`/documents/estimates/${n.id}`)}catch(n){alert(n.response?.data?.detail||"Ошибка при импорте")}finally{e&&(e.value="")}}async function U(o,e){try{const t=await be(o.id,e),n=window.URL.createObjectURL(t),g=document.createElement("a");g.href=n,g.download=`estimate_${o.number}.${e==="pdf"?"pdf":"xlsx"}`,document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(n)}catch(t){alert(t.response?.data?.detail||"Ошибка при печати")}}function M(o){v.push(`/documents/estimates/${o.id}`)}async function Z(o){if(confirm(`Удалить смету "${o.number}"?`))try{await ge(o.id),await i()}catch(e){alert(e.response?.data?.detail||"Ошибка при удалении")}}function ee(o){c.value=o}async function te(){if(c.value.length!==0&&confirm(`Удалить выбранные сметы (${c.value.length})?`))try{const o=c.value.map(t=>t.id),e=await xe(o);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),w.value?.clearSelection(),await i()}catch(o){alert(o.response?.data?.detail||"Ошибка при групповом удалении")}}async function le(){if(c.value.length!==0&&confirm(`Провести выбранные сметы (${c.value.length})?`))try{const o=c.value.map(t=>t.id),e=await ye(o);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),w.value?.clearSelection(),await i()}catch(o){alert(o.response?.data?.detail||"Ошибка при групповом проведении")}}async function oe(){if(c.value.length!==0&&confirm(`Отменить проведение выбранных смет (${c.value.length})?`))try{const o=c.value.map(t=>t.id),e=await ve(o);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),w.value?.clearSelection(),await i()}catch(o){alert(o.response?.data?.detail||"Ошибка при отмене проведения")}}se(async()=>{await A();const o=new Date,e=new Date(o.getFullYear(),o.getMonth(),1),t=new Date(o.getFullYear(),o.getMonth()+1,0);r.filters.value.dateFrom=I(e),r.filters.value.dateTo=I(t),r.applyFilters(),i()});function I(o){const e=o.getFullYear(),t=String(o.getMonth()+1).padStart(2,"0"),n=String(o.getDate()).padStart(2,"0");return`${e}-${t}-${n}`}return(o,e)=>(d(),ne(he,null,{default:m(()=>[l("div",Ce,[e[22]||(e[22]=l("div",null,[l("h2",{class:"text-2xl font-bold text-gray-900"},"Сметы"),l("p",{class:"mt-1 text-sm text-gray-600"},"Управление сметами")],-1)),_(ue,{ref_key:"tableRef",ref:w,columns:N,data:s(a).data.value,loading:s(a).loading.value,pagination:s(a).pagination.value,selectable:!0,"has-filters":!0,onRowClick:M,onPageChange:H,onSearch:q,onSort:Q,onSelectionChange:ee,onRefresh:i,onApplyFilters:O,onClearFilters:Y},{filters:m(()=>[_(we,{from:s(r).filters.value.dateFrom,"onUpdate:from":e[0]||(e[0]=t=>s(r).filters.value.dateFrom=t),to:s(r).filters.value.dateTo,"onUpdate:to":e[1]||(e[1]=t=>s(r).filters.value.dateTo=t),label:"Период"},null,8,["from","to"]),l("div",null,[e[8]||(e[8]=l("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Объект",-1)),y(l("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>s(r).filters.value.objectId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[7]||(e[7]=l("option",{value:null},"Все объекты",-1)),(d(!0),p($,null,F(j.value,t=>(d(),p("option",{key:t.id,value:t.id},u(t.name),9,_e))),128))],512),[[E,s(r).filters.value.objectId]])]),l("div",null,[e[10]||(e[10]=l("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Заказчик",-1)),y(l("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>s(r).filters.value.customerId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[9]||(e[9]=l("option",{value:null},"Все заказчики",-1)),(d(!0),p($,null,F(T.value,t=>(d(),p("option",{key:t.id,value:t.id},u(t.name),9,Ee))),128))],512),[[E,s(r).filters.value.customerId]])]),l("div",null,[e[12]||(e[12]=l("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Статус проведения",-1)),y(l("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>s(r).filters.value.isPosted=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[11]||(e[11]=[l("option",{value:null},"Все",-1),l("option",{value:!0},"Проведенные",-1),l("option",{value:!1},"Не проведенные",-1)])],512),[[E,s(r).filters.value.isPosted]])]),l("div",null,[e[13]||(e[13]=l("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Сумма от",-1)),y(l("input",{"onUpdate:modelValue":e[5]||(e[5]=t=>s(r).filters.value.sumFrom=t),type:"number",step:"0.01",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0.00"},null,512),[[L,s(r).filters.value.sumFrom,void 0,{number:!0}]])]),l("div",null,[e[14]||(e[14]=l("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Сумма до",-1)),y(l("input",{"onUpdate:modelValue":e[6]||(e[6]=t=>s(r).filters.value.sumTo=t),type:"number",step:"0.01",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0.00"},null,512),[[L,s(r).filters.value.sumTo,void 0,{number:!0}]])])]),"bulk-actions":m(({selected:t})=>[t.length>0?(d(),p("div",Fe,[l("button",{onClick:le,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"}," Провести ("+u(t.length)+") ",1),l("button",{onClick:oe,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700"}," Отменить проведение ("+u(t.length)+") ",1),l("button",{onClick:te,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+u(t.length)+") ",1)])):B("",!0)]),"header-actions":m(()=>[l("div",{class:"flex gap-2"},[l("button",{onClick:J,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50"},[...e[15]||(e[15]=[l("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1),x(" Ввод на основании ежедневного отчета ",-1)])]),l("button",{onClick:W,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50"},[...e[16]||(e[16]=[l("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})],-1),x(" Импорт из Excel ",-1)])]),l("button",{onClick:G,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...e[17]||(e[17]=[l("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),x(" Создать смету ",-1)])])]),l("input",{ref_key:"fileInputRef",ref:S,type:"file",accept:".xlsx,.xls",style:{display:"none"},onChange:X},null,544)]),"cell-date":m(({value:t})=>[x(u(P(t)),1)]),"cell-total_sum":m(({value:t})=>[x(u(z(t)),1)]),"cell-is_posted":m(({value:t})=>[l("div",$e,[l("span",{class:V(["inline-flex items-center justify-center w-6 h-6 rounded-full",t?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400"]),title:t?"Проведен":"Не проведен"},[t?(d(),p("svg",De,[...e[18]||(e[18]=[l("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])])):(d(),p("svg",je,[...e[19]||(e[19]=[l("circle",{cx:"10",cy:"10",r:"3"},null,-1)])]))],10,Se)])]),actions:m(({row:t})=>[l("button",{onClick:C(n=>M(t),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-3"}," Открыть ",8,Te),l("button",{onClick:C(n=>U(t,"excel"),["stop"]),class:"text-green-600 hover:text-green-900 mr-3",title:"Печать в Excel"}," Excel ",8,Pe),l("button",{onClick:C(n=>U(t,"pdf"),["stop"]),class:"text-purple-600 hover:text-purple-900 mr-3",title:"Печать в PDF"}," PDF ",8,Re),t.is_posted?B("",!0):(d(),p("button",{key:0,onClick:C(n=>Z(t),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,Ue))]),_:1},8,["data","loading","pagination"]),_(ke,{open:k.value,title:"Выбор ежедневного отчета",size:"lg",onClose:R},{footer:m(()=>[l("button",{onClick:R,type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),l("button",{onClick:K,type:"button",disabled:!f.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"}," Создать смету ",8,qe)]),default:m(()=>[l("div",Me,[e[21]||(e[21]=l("p",{class:"text-sm text-gray-600"}," Выберите ежедневный отчет для создания сметы на его основании ",-1)),l("div",Ie,[l("table",Be,[e[20]||(e[20]=l("thead",{class:"bg-gray-50 sticky top-0"},[l("tr",null,[l("th",{class:"w-12 px-3 py-3"}),l("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Номер"),l("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Дата"),l("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Объект"),l("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Заказчик")])],-1)),l("tbody",Ve,[(d(!0),p($,null,F(D.value,t=>(d(),p("tr",{key:t.id,onClick:n=>f.value=t.id,class:V(["cursor-pointer hover:bg-gray-50",f.value===t.id?"bg-blue-50":""])},[l("td",Ne,[l("input",{type:"radio",checked:f.value===t.id,onChange:n=>f.value=t.id,class:"h-4 w-4 text-blue-600"},null,40,ze)]),l("td",Ae,u(t.number),1),l("td",Oe,u(P(t.date)),1),l("td",Ye,u(t.object_name),1),l("td",He,u(t.customer_name),1)],10,Le))),128))])])])])]),_:1},8,["open"])])]),_:1}))}});export{lt as default};
