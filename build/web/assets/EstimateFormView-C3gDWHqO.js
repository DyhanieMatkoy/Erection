import{d as P,g as w,p as Q,j as d,a as e,k as x,e as L,F as N,m as S,o as l,n as X,t as m,c as F,l as $,s as U,y as Y,z as Z,f as q,h as ee,w as te,x as se,b as k,u as B}from"./index-DUoOKtDv.js";import{u as ae}from"./references-eDFEYnSt.js";import{u as oe,_ as le}from"./PrintDialog.vue_vue_type_script_setup_true_lang-Bo6HFs8v.js";import{getEstimate as T,getTimesheet as re,createEstimate as de,updateEstimate as ie,postEstimate as ne,unpostEstimate as ue}from"./documents-ChgHnlwZ.js";import{_ as me}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as z}from"./FormField.vue_vue_type_script_setup_true_lang-BL-nFudA.js";import{_ as C}from"./Picker.vue_vue_type_script_setup_true_lang-BLaBmckP.js";import"./Modal.vue_vue_type_script_setup_true_lang-pxS1gZgL.js";const ce={class:"bg-white shadow rounded-lg p-6 space-y-4"},pe={class:"flex items-center justify-between"},be={class:"hidden md:block overflow-x-auto"},ve={class:"min-w-full divide-y divide-gray-200"},ye={class:"bg-gray-50"},xe={key:0,class:"px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase w-24"},fe={class:"bg-white divide-y divide-gray-200"},_e={class:"px-3 py-2 text-sm text-gray-900"},ge={class:"px-3 py-2"},he={key:1,class:"text-sm text-gray-900"},ke={class:"px-3 py-2"},we=["onUpdate:modelValue","onInput"],Ve={key:1,class:"text-sm text-gray-900"},$e={class:"px-3 py-2 text-sm text-gray-500"},Ue={class:"px-3 py-2"},Ce=["onUpdate:modelValue","onInput"],je={key:1,class:"text-sm text-gray-900"},Ee={class:"px-3 py-2 text-sm font-medium text-gray-900"},qe={class:"px-3 py-2"},Ie=["onUpdate:modelValue"],Fe={key:1,class:"text-sm text-gray-900"},De={key:0,class:"px-3 py-2 text-right"},Ne=["onClick"],Se={key:0},Be=["colspan"],Te={class:"md:hidden space-y-4"},ze={class:"flex items-center justify-between"},Pe={class:"text-sm font-medium text-gray-500"},Le=["onClick"],Me={class:"space-y-2"},Oe={key:1,class:"text-sm text-gray-900"},Re={class:"grid grid-cols-2 gap-2"},He=["onUpdate:modelValue","onInput"],Ae={key:1,class:"text-sm text-gray-900"},We={class:"text-sm text-gray-900"},Ge={class:"grid grid-cols-2 gap-2"},Je=["onUpdate:modelValue","onInput"],Ke={key:1,class:"text-sm text-gray-900"},Qe={class:"text-sm font-medium text-gray-900"},Xe=["onUpdate:modelValue"],Ye={key:1,class:"text-sm text-gray-900"},Ze={key:0,class:"text-center py-8 text-sm text-gray-500"},et=P({__name:"EstimateLines",props:{modelValue:{},works:{},disabled:{type:Boolean}},emits:["update:modelValue","update:totals"],setup(p,{emit:j}){const V=p,y=j,v=w({get:()=>V.modelValue||[],set:i=>y("update:modelValue",i)});function _(i){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i)}function f(){const i={work_id:null,quantity:0,price:0,sum:0,labor:0,parent_id:null,is_group:!1,order_num:v.value.length};v.value=[...v.value,i]}function h(i){v.value=v.value.filter((a,s)=>s!==i),g()}function t(i){const a=v.value[i],s=V.works.find(b=>b.id===a.work_id);s&&(a.work_name=s.name,a.unit=s.unit),u(i)}function u(i){const a=v.value[i];a.sum=a.quantity*a.price,g()}function g(){const i=v.value.reduce((a,s)=>(s.is_group||(a.sum+=s.sum,a.labor+=s.labor),a),{sum:0,labor:0});y("update:totals",i)}return Q(()=>v.value,()=>{g()},{deep:!0}),(i,a)=>(l(),d("div",ce,[e("div",pe,[a[1]||(a[1]=e("h3",{class:"text-lg font-medium text-gray-900"},"Строки сметы",-1)),p.disabled?x("",!0):(l(),d("button",{key:0,onClick:f,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"},[...a[0]||(a[0]=[e("svg",{class:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),L(" Добавить строку ",-1)])]))]),e("div",be,[e("table",ve,[e("thead",ye,[e("tr",null,[a[2]||(a[2]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12"},"#",-1)),a[3]||(a[3]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Работа",-1)),a[4]||(a[4]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24"}," Кол-во ",-1)),a[5]||(a[5]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20"}," Ед. ",-1)),a[6]||(a[6]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Цена ",-1)),a[7]||(a[7]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Сумма ",-1)),a[8]||(a[8]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Труд. ",-1)),p.disabled?x("",!0):(l(),d("th",xe," Действия "))])]),e("tbody",fe,[(l(!0),d(N,null,S(v.value,(s,b)=>(l(),d("tr",{key:b,class:X({"bg-gray-50":s.is_group})},[e("td",_e,m(b+1),1),e("td",ge,[p.disabled?(l(),d("span",he,m(s.work_name),1)):(l(),F(C,{key:0,modelValue:s.work_id,"onUpdate:modelValue":[n=>s.work_id=n,n=>t(b)],items:p.works,placeholder:"Выберите работу"},null,8,["modelValue","onUpdate:modelValue","items"]))]),e("td",ke,[!p.disabled&&!s.is_group?$((l(),d("input",{key:0,"onUpdate:modelValue":n=>s.quantity=n,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:n=>u(b)},null,40,we)),[[U,s.quantity,void 0,{number:!0}]]):(l(),d("span",Ve,m(s.quantity),1))]),e("td",$e,m(s.unit),1),e("td",Ue,[!p.disabled&&!s.is_group?$((l(),d("input",{key:0,"onUpdate:modelValue":n=>s.price=n,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:n=>u(b)},null,40,Ce)),[[U,s.price,void 0,{number:!0}]]):(l(),d("span",je,m(_(s.price)),1))]),e("td",Ee,m(_(s.sum)),1),e("td",qe,[!p.disabled&&!s.is_group?$((l(),d("input",{key:0,"onUpdate:modelValue":n=>s.labor=n,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded"},null,8,Ie)),[[U,s.labor,void 0,{number:!0}]]):(l(),d("span",Fe,m(_(s.labor)),1))]),p.disabled?x("",!0):(l(),d("td",De,[e("button",{onClick:n=>h(b),class:"text-red-600 hover:text-red-900 text-sm"}," Удалить ",8,Ne)]))],2))),128)),v.value.length===0?(l(),d("tr",Se,[e("td",{colspan:p.disabled?7:8,class:"px-3 py-8 text-center text-sm text-gray-500"}," Нет строк ",8,Be)])):x("",!0)])])]),e("div",Te,[(l(!0),d(N,null,S(v.value,(s,b)=>(l(),d("div",{key:b,class:"border border-gray-200 rounded-lg p-4 space-y-3"},[e("div",ze,[e("span",Pe,"Строка "+m(b+1),1),p.disabled?x("",!0):(l(),d("button",{key:0,onClick:n=>h(b),class:"text-red-600 hover:text-red-900 text-sm"}," Удалить ",8,Le))]),e("div",Me,[e("div",null,[a[9]||(a[9]=e("label",{class:"block text-xs font-medium text-gray-500"},"Работа",-1)),p.disabled?(l(),d("span",Oe,m(s.work_name),1)):(l(),F(C,{key:0,modelValue:s.work_id,"onUpdate:modelValue":[n=>s.work_id=n,n=>t(b)],items:p.works,placeholder:"Выберите работу"},null,8,["modelValue","onUpdate:modelValue","items"]))]),e("div",Re,[e("div",null,[a[10]||(a[10]=e("label",{class:"block text-xs font-medium text-gray-500"},"Количество",-1)),!p.disabled&&!s.is_group?$((l(),d("input",{key:0,"onUpdate:modelValue":n=>s.quantity=n,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:n=>u(b)},null,40,He)),[[U,s.quantity,void 0,{number:!0}]]):(l(),d("span",Ae,m(s.quantity),1))]),e("div",null,[a[11]||(a[11]=e("label",{class:"block text-xs font-medium text-gray-500"},"Ед. изм.",-1)),e("span",We,m(s.unit),1)])]),e("div",Ge,[e("div",null,[a[12]||(a[12]=e("label",{class:"block text-xs font-medium text-gray-500"},"Цена",-1)),!p.disabled&&!s.is_group?$((l(),d("input",{key:0,"onUpdate:modelValue":n=>s.price=n,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:n=>u(b)},null,40,Je)),[[U,s.price,void 0,{number:!0}]]):(l(),d("span",Ke,m(_(s.price)),1))]),e("div",null,[a[13]||(a[13]=e("label",{class:"block text-xs font-medium text-gray-500"},"Сумма",-1)),e("span",Qe,m(_(s.sum)),1)])]),e("div",null,[a[14]||(a[14]=e("label",{class:"block text-xs font-medium text-gray-500"},"Трудоемкость",-1)),!p.disabled&&!s.is_group?$((l(),d("input",{key:0,"onUpdate:modelValue":n=>s.labor=n,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded"},null,8,Xe)),[[U,s.labor,void 0,{number:!0}]]):(l(),d("span",Ye,m(_(s.labor)),1))])])]))),128)),v.value.length===0?(l(),d("div",Ze," Нет строк ")):x("",!0)])]))}}),tt={class:"space-y-6"},st={class:"flex items-center justify-between"},at={class:"text-2xl font-bold text-gray-900"},ot={class:"mt-1 text-sm text-gray-600"},lt={class:"flex items-center space-x-2"},rt={key:0,class:"px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"},dt={class:"bg-white shadow rounded-lg p-6 space-y-6"},it={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},nt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t"},ut={class:"mt-1 text-lg font-semibold text-gray-900"},mt={class:"mt-1 text-lg font-semibold text-gray-900"},ct={class:"flex justify-between items-center"},pt={key:0,class:"text-sm text-red-600"},bt={class:"flex space-x-3 ml-auto"},vt=["disabled"],yt=["disabled"],xt=["disabled"],Ut=P({__name:"EstimateFormView",setup(p){const j=se(),V=Z(),y=ae(),{isAdmin:v}=Y(),{printEstimate:_}=oe(),f=w(()=>V.params.id==="new"),h=q(!1),t=q({number:"",date:new Date().toISOString().split("T")[0],customer_id:0,object_id:0,contractor_id:0,responsible_id:0,total_sum:0,total_labor:0,is_posted:!1,posted_at:null,is_deleted:!1,lines:[]}),u=q({}),g=q(""),i=q(!1),a=w(()=>y.counterparties.filter(r=>!r.is_deleted)),s=w(()=>y.objects.filter(r=>!r.is_deleted)),b=w(()=>y.organizations.filter(r=>!r.is_deleted)),n=w(()=>y.persons.filter(r=>!r.is_deleted)),M=w(()=>y.works.filter(r=>!r.is_deleted));function D(r){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(r)}function O(r){t.value.total_sum=r.sum,t.value.total_labor=r.labor}async function I(){if(!f.value)try{const r=await T(Number(V.params.id));t.value=r}catch(r){console.error("Failed to load estimate:",r),alert("Ошибка загрузки сметы"),j.push("/documents/estimates")}}async function R(r){try{const o=await re(r);if(t.value.date=o.date,t.value.object_id=o.object_id,o.estimate_id)try{const E=await T(o.estimate_id);t.value.customer_id=E.customer_id,t.value.contractor_id=E.contractor_id,t.value.responsible_id=E.responsible_id}catch(E){console.error("Failed to load estimate:",E)}const K=(new Date().toISOString().split("T")[0]||"").replace(/-/g,"");t.value.number=`СМ-${K}-${Math.floor(Math.random()*1e3)}`,t.value.lines=[]}catch(o){alert(o.response?.data?.detail||"Ошибка при загрузке ежедневного отчета")}}async function H(){if(u.value={},t.value.number.trim()||(u.value.number="Обязательное поле"),t.value.date||(u.value.date="Обязательное поле"),t.value.customer_id||(u.value.customer_id="Обязательное поле"),t.value.object_id||(u.value.object_id="Обязательное поле"),t.value.contractor_id||(u.value.contractor_id="Обязательное поле"),t.value.responsible_id||(u.value.responsible_id="Обязательное поле"),!(Object.keys(u.value).length>0)){i.value=!0,g.value="";try{if(f.value){const r=await de(t.value);j.push(`/documents/estimates/${r.id}`)}else await ie(t.value.id,t.value),await I()}catch(r){const o=r;g.value=o.response?.data?.detail||"Ошибка при сохранении"}finally{i.value=!1}}}async function A(){if(confirm("Провести смету?")){i.value=!0;try{await ne(t.value.id),await I()}catch(r){alert(r.response?.data?.detail||"Ошибка при проведении")}finally{i.value=!1}}}async function W(){if(confirm("Отменить проведение сметы?")){i.value=!0;try{await ue(t.value.id),await I()}catch(r){alert(r.response?.data?.detail||"Ошибка при отмене проведения")}finally{i.value=!1}}}function G(){j.push("/documents/estimates")}async function J(r,o){try{await _(t.value.id,r,o,`Смета_${t.value.number}`),h.value=!1}catch(c){console.error("Print failed:",c)}}return ee(async()=>{await Promise.all([y.fetchCounterparties(),y.fetchObjects(),y.fetchOrganizations(),y.fetchPersons(),y.fetchWorks()]),await I();const r=V.query.timesheet_id;f.value&&r&&await R(Number(r))}),(r,o)=>(l(),F(me,null,{default:te(()=>[e("div",tt,[e("div",st,[e("div",null,[e("h2",at,m(f.value?"Новая смета":`Смета ${t.value.number}`),1),e("p",ot,m(f.value?"Создание новой сметы":"Редактирование сметы"),1)]),e("div",lt,[t.value.is_posted?(l(),d("span",rt," Проведен ")):x("",!0),e("button",{onClick:G,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Назад ")])]),e("div",dt,[e("div",it,[k(z,{modelValue:t.value.number,"onUpdate:modelValue":o[0]||(o[0]=c=>t.value.number=c),label:"Номер",type:"text",required:"",disabled:t.value.is_posted,error:u.value.number},null,8,["modelValue","disabled","error"]),k(z,{modelValue:t.value.date,"onUpdate:modelValue":o[1]||(o[1]=c=>t.value.date=c),label:"Дата",type:"date",required:"",disabled:t.value.is_posted,error:u.value.date},null,8,["modelValue","disabled","error"]),k(C,{modelValue:t.value.customer_id,"onUpdate:modelValue":o[2]||(o[2]=c=>t.value.customer_id=c),label:"Заказчик",items:a.value,required:"",disabled:t.value.is_posted,error:u.value.customer_id},null,8,["modelValue","items","disabled","error"]),k(C,{modelValue:t.value.object_id,"onUpdate:modelValue":o[3]||(o[3]=c=>t.value.object_id=c),label:"Объект",items:s.value,required:"",disabled:t.value.is_posted,error:u.value.object_id},null,8,["modelValue","items","disabled","error"]),k(C,{modelValue:t.value.contractor_id,"onUpdate:modelValue":o[4]||(o[4]=c=>t.value.contractor_id=c),label:"Подрядчик",items:b.value,required:"",disabled:t.value.is_posted,error:u.value.contractor_id},null,8,["modelValue","items","disabled","error"]),k(C,{modelValue:t.value.responsible_id,"onUpdate:modelValue":o[5]||(o[5]=c=>t.value.responsible_id=c),label:"Ответственный",items:n.value,"display-key":"full_name",required:"",disabled:t.value.is_posted,error:u.value.responsible_id},null,8,["modelValue","items","disabled","error"])]),e("div",nt,[e("div",null,[o[9]||(o[9]=e("label",{class:"block text-sm font-medium text-gray-700"},"Общая сумма",-1)),e("div",ut,m(D(t.value.total_sum)),1)]),e("div",null,[o[10]||(o[10]=e("label",{class:"block text-sm font-medium text-gray-700"},"Общая трудоемкость",-1)),e("div",mt,m(D(t.value.total_labor)),1)])])]),k(et,{modelValue:t.value.lines,"onUpdate:modelValue":o[6]||(o[6]=c=>t.value.lines=c),works:M.value,disabled:t.value.is_posted,"onUpdate:totals":O},null,8,["modelValue","works","disabled"]),e("div",ct,[g.value?(l(),d("div",pt,m(g.value),1)):x("",!0),e("div",bt,[f.value?x("",!0):(l(),d("button",{key:0,onClick:o[7]||(o[7]=c=>h.value=!0),class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...o[11]||(o[11]=[e("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1),L(" Печать ",-1)])])),!f.value&&B(v)&&!t.value.is_posted?(l(),d("button",{key:1,onClick:A,disabled:i.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50"}," Провести ",8,vt)):x("",!0),!f.value&&B(v)&&t.value.is_posted?(l(),d("button",{key:2,onClick:W,disabled:i.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"}," Отменить проведение ",8,yt)):x("",!0),t.value.is_posted?x("",!0):(l(),d("button",{key:3,onClick:H,disabled:i.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"},m(i.value?"Сохранение...":"Сохранить"),9,xt))])])]),t.value.id?(l(),F(le,{key:0,open:h.value,"document-type":"estimate","document-id":t.value.id,"document-name":`Смета_${t.value.number}`,onClose:o[8]||(o[8]=c=>h.value=!1),onPrint:J},null,8,["open","document-id","document-name"])):x("",!0)]),_:1}))}});export{Ut as default};
