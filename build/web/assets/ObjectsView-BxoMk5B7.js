import{d as $,f as b,h as R,c as M,w as n,a as s,b as m,i as c,u as l,n as B,j as d,e as g,t as u,l as v,v as x,m as L,F as O,k as U,o as i}from"./index-OcrUBGsV.js";import{u as I}from"./useReferenceView-BwLXfedD.js";import{u as P}from"./useFilters-DiIRWo9Z.js";import{u as E,e as N,f as z,h as A,i as T,j as q}from"./references-C4ONrARJ.js";import{_ as H}from"./AppLayout.vue_vue_type_script_setup_true_lang-C777ZaO3.js";import{_ as G}from"./DataTable.vue_vue_type_script_setup_true_lang-CIOfCPly.js";import{_ as J}from"./DateRangePicker.vue_vue_type_script_setup_true_lang-BuJYH59H.js";import{_ as K}from"./Modal.vue_vue_type_script_setup_true_lang-BNdb9fbR.js";import{_ as Q}from"./FormField.vue_vue_type_script_setup_true_lang-CJXR9oI6.js";import{_ as W}from"./Picker.vue_vue_type_script_setup_true_lang-Je5YKjAW.js";const X={class:"space-y-6"},Y=["value"],Z={key:0,class:"text-gray-500"},ee={key:1,class:"text-gray-400"},te={key:0,class:"text-sm text-gray-900"},le={key:1,class:"text-gray-400"},ae={class:"flex items-center justify-center"},se=["title"],oe={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},re={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},ne=["onClick"],ie=["onClick"],de={key:0,class:"rounded-md bg-red-50 p-4"},ue={class:"text-sm text-red-800"},me=["disabled"],_e=$({__name:"ObjectsView",setup(fe){const p=E(),y=b(),f=b([]),r=P({status:null,customerId:null,startDateFrom:null,startDateTo:null,isDeleted:null}),h=b([]),a=I({getAll:q,create:T,update:A,delete:z},()=>p.fetchObjects(!0)),k=[{key:"code",label:"Код",width:"100px"},{key:"name",label:"Наименование",width:"350px"},{key:"address",label:"Адрес",width:"250px"},{key:"customer_name",label:"Заказчик",width:"200px"},{key:"status",label:"Статус",width:"120px"},{key:"start_date",label:"Дата начала",width:"100px"},{key:"end_date",label:"Дата окончания",width:"100px"},{key:"is_deleted",label:"",width:"40px",sortable:!1}];function _(o){f.value=o}async function C(){if(f.value.length!==0&&confirm(`Удалить выбранные объекты (${f.value.length})?`))try{const o=f.value.map(t=>t.id),e=await N(o);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),y.value?.clearSelection(),await a.loadData()}catch(o){alert(o.response?.data?.detail||"Ошибка при групповом удалении")}}function D(){r.applyFilters(),a.table.setPage(1),a.loadData()}function S(){r.clearAllFilters(),a.table.setPage(1),a.loadData()}function j(o){return{planning:"Планируется",in_progress:"В работе",completed:"Завершен"}[o]||o}function w(o){return o?new Date(o).toLocaleDateString("ru-RU"):"—"}async function V(){try{await p.fetchCounterparties(),h.value=p.counterparties}catch(o){console.error("Failed to load references:",o)}}return R(async()=>{await V(),a.loadData()}),(o,e)=>(i(),M(H,null,{default:n(()=>[s("div",X,[e[20]||(e[20]=s("div",null,[s("h2",{class:"text-2xl font-bold text-gray-900"},"Объекты"),s("p",{class:"mt-1 text-sm text-gray-600"},"Управление справочником объектов")],-1)),m(G,{ref_key:"tableRef",ref:y,columns:k,data:l(a).table.data.value,loading:l(a).table.loading.value,pagination:l(a).table.pagination.value,selectable:!0,"has-filters":!0,onRowClick:l(a).handleEdit,onPageChange:l(a).handlePageChange,onSearch:l(a).handleSearch,onSort:l(a).handleSort,onSelectionChange:_,onRefresh:l(a).loadData,onApplyFilters:D,onClearFilters:S},{filters:n(()=>[s("div",null,[e[12]||(e[12]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Статус",-1)),v(s("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>l(r).filters.value.status=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[11]||(e[11]=[s("option",{value:null},"Все",-1),s("option",{value:"planning"},"Планируется",-1),s("option",{value:"in_progress"},"В работе",-1),s("option",{value:"completed"},"Завершен",-1)])],512),[[x,l(r).filters.value.status]])]),s("div",null,[e[14]||(e[14]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Заказчик",-1)),v(s("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>l(r).filters.value.customerId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[13]||(e[13]=s("option",{value:null},"Все заказчики",-1)),(i(!0),d(O,null,L(h.value,t=>(i(),d("option",{key:t.id,value:t.id},u(t.name),9,Y))),128))],512),[[x,l(r).filters.value.customerId]])]),m(J,{from:l(r).filters.value.startDateFrom,"onUpdate:from":e[2]||(e[2]=t=>l(r).filters.value.startDateFrom=t),to:l(r).filters.value.startDateTo,"onUpdate:to":e[3]||(e[3]=t=>l(r).filters.value.startDateTo=t),label:"Дата начала","show-quick-periods":!1},null,8,["from","to"]),s("div",null,[e[16]||(e[16]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Удаленные",-1)),v(s("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>l(r).filters.value.isDeleted=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[15]||(e[15]=[s("option",{value:null},"Все",-1),s("option",{value:!1},"Активные",-1),s("option",{value:!0},"Удаленные",-1)])],512),[[x,l(r).filters.value.isDeleted]])])]),"bulk-actions":n(({selected:t})=>[s("button",{onClick:C,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+u(t.length)+") ",1)]),"header-actions":n(()=>[s("button",{onClick:e[5]||(e[5]=(...t)=>l(a).handleCreate&&l(a).handleCreate(...t)),class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...e[17]||(e[17]=[s("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),g(" Создать ",-1)])])]),"cell-parent_id":n(({row:t})=>[t.parent_id?(i(),d("span",Z,u(l(a).getParentName(t.parent_id)),1)):(i(),d("span",ee,"—"))]),"cell-status":n(({value:t})=>[t?(i(),d("span",te,u(j(t)),1)):(i(),d("span",le,"—"))]),"cell-start_date":n(({value:t})=>[g(u(w(t)),1)]),"cell-end_date":n(({value:t})=>[g(u(w(t)),1)]),"cell-is_deleted":n(({value:t})=>[s("div",ae,[s("span",{class:B(["inline-flex items-center justify-center w-6 h-6 rounded-full",t?"bg-red-100 text-red-600":"bg-green-100 text-green-600"]),title:t?"Удален":"Активен"},[t?(i(),d("svg",oe,[...e[18]||(e[18]=[s("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"},null,-1)])])):(i(),d("svg",re,[...e[19]||(e[19]=[s("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])]))],10,se)])]),actions:n(({row:t})=>[s("button",{onClick:c(F=>l(a).handleEdit(t),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Изменить ",8,ne),s("button",{onClick:c(F=>l(a).handleDelete(t),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,ie)]),_:1},8,["data","loading","pagination","onRowClick","onPageChange","onSearch","onSort","onRefresh"]),m(K,{open:l(a).modalOpen.value,title:l(a).editingItem.value?"Редактирование объекта":"Создание объекта",size:"md",onClose:l(a).handleCloseModal},{footer:n(()=>[s("button",{onClick:e[9]||(e[9]=(...t)=>l(a).handleCloseModal&&l(a).handleCloseModal(...t)),type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),s("button",{onClick:e[10]||(e[10]=(...t)=>l(a).handleSubmit&&l(a).handleSubmit(...t)),type:"button",disabled:l(a).submitting.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50"},u(l(a).submitting.value?"Сохранение...":"Сохранить"),9,me)]),default:n(()=>[s("form",{onSubmit:e[8]||(e[8]=c((...t)=>l(a).handleSubmit&&l(a).handleSubmit(...t),["prevent"])),class:"space-y-4"},[m(Q,{modelValue:l(a).formData.value.name,"onUpdate:modelValue":e[6]||(e[6]=t=>l(a).formData.value.name=t),label:"Наименование",type:"text",required:"",error:l(a).errors.value.name},null,8,["modelValue","error"]),m(W,{modelValue:l(a).formData.value.parent_id,"onUpdate:modelValue":e[7]||(e[7]=t=>l(a).formData.value.parent_id=t),label:"Родительский элемент",items:l(a).parentItems.value,error:l(a).errors.value.parent_id},null,8,["modelValue","items","error"]),l(a).submitError.value?(i(),d("div",de,[s("p",ue,u(l(a).submitError.value),1)])):U("",!0)],32)]),_:1},8,["open","title","onClose"])])]),_:1}))}});export{_e as default};
