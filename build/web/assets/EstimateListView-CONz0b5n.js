import{d as P,f as p,h as R,c as V,w as l,a as n,b as F,j as h,k as b,i as x,n as U,t as i,e as u,u as d,l as M,o as m}from"./index-BmuF08LN.js";import{u as I,_ as L}from"./DataTable.vue_vue_type_script_setup_true_lang-BHfRwsQq.js";import{getEstimates as T,deleteEstimate as q,bulkDeleteEstimates as z,bulkPostEstimates as H,bulkUnpostEstimates as A}from"./documents-BLg9IHiW.js";import{_ as G}from"./AppLayout.vue_vue_type_script_setup_true_lang-n4va9pfH.js";const J={class:"space-y-6"},K={key:0,class:"flex gap-2"},O=["onClick"],Q=["onClick"],te=P({__name:"EstimateListView",setup(W){const f=M(),r=I(),c=p(),o=p([]),v=[{key:"number",label:"Номер"},{key:"date",label:"Дата"},{key:"customer_name",label:"Заказчик"},{key:"object_name",label:"Объект"},{key:"total_sum",label:"Сумма"},{key:"is_posted",label:"Статус"}];function k(e){return new Date(e).toLocaleDateString("ru-RU")}function y(e){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}async function s(){r.loading.value=!0;try{const e=await T(r.queryParams.value);r.data.value=e.data,r.pagination.value=e.pagination}catch(e){console.error("Failed to load estimates:",e)}finally{r.loading.value=!1}}function _(e){r.setPage(e),s()}function w(e){r.setSearch(e),s()}function C(e,t){r.setSort(e,t),s()}function E(){f.push("/documents/estimates/new")}function g(e){f.push(`/documents/estimates/${e.id}`)}async function $(e){if(confirm(`Удалить смету "${e.number}"?`))try{await q(e.id),await s()}catch(t){alert(t.response?.data?.detail||"Ошибка при удалении")}}function S(e){o.value=e}async function D(){if(o.value.length!==0&&confirm(`Удалить выбранные сметы (${o.value.length})?`))try{const e=o.value.map(a=>a.id),t=await z(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),c.value?.clearSelection(),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при групповом удалении")}}async function B(){if(o.value.length!==0&&confirm(`Провести выбранные сметы (${o.value.length})?`))try{const e=o.value.map(a=>a.id),t=await H(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),c.value?.clearSelection(),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при групповом проведении")}}async function j(){if(o.value.length!==0&&confirm(`Отменить проведение выбранных смет (${o.value.length})?`))try{const e=o.value.map(a=>a.id),t=await A(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),c.value?.clearSelection(),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при отмене проведения")}}return R(()=>{s()}),(e,t)=>(m(),V(G,null,{default:l(()=>[n("div",J,[t[1]||(t[1]=n("div",null,[n("h2",{class:"text-2xl font-bold text-gray-900"},"Сметы"),n("p",{class:"mt-1 text-sm text-gray-600"},"Управление сметами")],-1)),F(L,{ref_key:"tableRef",ref:c,columns:v,data:d(r).data.value,loading:d(r).loading.value,pagination:d(r).pagination.value,selectable:!0,onRowClick:g,onPageChange:_,onSearch:w,onSort:C,onSelectionChange:S},{"bulk-actions":l(({selected:a})=>[a.length>0?(m(),h("div",K,[n("button",{onClick:B,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"}," Провести ("+i(a.length)+") ",1),n("button",{onClick:j,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700"}," Отменить проведение ("+i(a.length)+") ",1),n("button",{onClick:D,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+i(a.length)+") ",1)])):b("",!0)]),"header-actions":l(()=>[n("button",{onClick:E,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...t[0]||(t[0]=[n("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),u(" Создать смету ",-1)])])]),"cell-date":l(({value:a})=>[u(i(k(a)),1)]),"cell-total_sum":l(({value:a})=>[u(i(y(a)),1)]),"cell-is_posted":l(({value:a})=>[n("span",{class:U(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",a?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"])},i(a?"Проведен":"Не проведен"),3)]),actions:l(({row:a})=>[n("button",{onClick:x(N=>g(a),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Открыть ",8,O),a.is_posted?b("",!0):(m(),h("button",{key:0,onClick:x(N=>$(a),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,Q))]),_:1},8,["data","loading","pagination"])])]),_:1}))}});export{te as default};
