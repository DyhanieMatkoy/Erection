import{d as z,g as w,m as W,j as l,a as e,k as y,e as L,F,p as N,o,n as G,t as m,c as I,q as V,v as $,s as J,x as K,f as q,h as Q,w as X,l as Y,b as h,u as B}from"./index-B1sRxO42.js";import{u as Z,_ as P}from"./FormField.vue_vue_type_script_setup_true_lang-wE-3Fa0o.js";import{u as ee,_ as te}from"./PrintDialog.vue_vue_type_script_setup_true_lang-DpS_j7I6.js";import{getEstimate as se,createEstimate as ae,updateEstimate as oe,postEstimate as le,unpostEstimate as re}from"./documents-BqcbhH-2.js";import{_ as de}from"./AppLayout.vue_vue_type_script_setup_true_lang-D5nXF41d.js";import{_ as U}from"./Picker.vue_vue_type_script_setup_true_lang-zGKsYr2N.js";import"./Modal.vue_vue_type_script_setup_true_lang-DYjBthM_.js";const ne={class:"bg-white shadow rounded-lg p-6 space-y-4"},ie={class:"flex items-center justify-between"},ue={class:"hidden md:block overflow-x-auto"},me={class:"min-w-full divide-y divide-gray-200"},ce={class:"bg-gray-50"},pe={key:0,class:"px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase w-24"},be={class:"bg-white divide-y divide-gray-200"},ve={class:"px-3 py-2 text-sm text-gray-900"},xe={class:"px-3 py-2"},ye={key:1,class:"text-sm text-gray-900"},fe={class:"px-3 py-2"},_e=["onUpdate:modelValue","onInput"],ge={key:1,class:"text-sm text-gray-900"},he={class:"px-3 py-2 text-sm text-gray-500"},ke={class:"px-3 py-2"},we=["onUpdate:modelValue","onInput"],Ve={key:1,class:"text-sm text-gray-900"},$e={class:"px-3 py-2 text-sm font-medium text-gray-900"},Ue={class:"px-3 py-2"},Ce=["onUpdate:modelValue"],je={key:1,class:"text-sm text-gray-900"},qe={key:0,class:"px-3 py-2 text-right"},Ee=["onClick"],Ie={key:0},De=["colspan"],Fe={class:"md:hidden space-y-4"},Ne={class:"flex items-center justify-between"},Be={class:"text-sm font-medium text-gray-500"},Pe=["onClick"],ze={class:"space-y-2"},Le={key:1,class:"text-sm text-gray-900"},Re={class:"grid grid-cols-2 gap-2"},Se=["onUpdate:modelValue","onInput"],Oe={key:1,class:"text-sm text-gray-900"},Te={class:"text-sm text-gray-900"},He={class:"grid grid-cols-2 gap-2"},Me=["onUpdate:modelValue","onInput"],Ae={key:1,class:"text-sm text-gray-900"},We={class:"text-sm font-medium text-gray-900"},Ge=["onUpdate:modelValue"],Je={key:1,class:"text-sm text-gray-900"},Ke={key:0,class:"text-center py-8 text-sm text-gray-500"},Qe=z({__name:"EstimateLines",props:{modelValue:{},works:{},disabled:{type:Boolean}},emits:["update:modelValue","update:totals"],setup(c,{emit:C}){const j=c,x=C,v=w({get:()=>j.modelValue||[],set:n=>x("update:modelValue",n)});function _(n){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n)}function f(){const n={work_id:null,quantity:0,price:0,sum:0,labor:0,parent_id:null,is_group:!1,order_num:v.value.length};v.value=[...v.value,n]}function k(n){v.value=v.value.filter((a,s)=>s!==n),g()}function t(n){const a=v.value[n],s=j.works.find(p=>p.id===a.work_id);s&&(a.work_name=s.name,a.unit=s.unit),u(n)}function u(n){const a=v.value[n];a.sum=a.quantity*a.price,g()}function g(){const n=v.value.reduce((a,s)=>(s.is_group||(a.sum+=s.sum,a.labor+=s.labor),a),{sum:0,labor:0});x("update:totals",n)}return W(()=>v.value,()=>{g()},{deep:!0}),(n,a)=>(o(),l("div",ne,[e("div",ie,[a[1]||(a[1]=e("h3",{class:"text-lg font-medium text-gray-900"},"Строки сметы",-1)),c.disabled?y("",!0):(o(),l("button",{key:0,onClick:f,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"},[...a[0]||(a[0]=[e("svg",{class:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),L(" Добавить строку ",-1)])]))]),e("div",ue,[e("table",me,[e("thead",ce,[e("tr",null,[a[2]||(a[2]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12"},"#",-1)),a[3]||(a[3]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Работа",-1)),a[4]||(a[4]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24"}," Кол-во ",-1)),a[5]||(a[5]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20"}," Ед. ",-1)),a[6]||(a[6]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Цена ",-1)),a[7]||(a[7]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Сумма ",-1)),a[8]||(a[8]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Труд. ",-1)),c.disabled?y("",!0):(o(),l("th",pe," Действия "))])]),e("tbody",be,[(o(!0),l(F,null,N(v.value,(s,p)=>(o(),l("tr",{key:p,class:G({"bg-gray-50":s.is_group})},[e("td",ve,m(p+1),1),e("td",xe,[c.disabled?(o(),l("span",ye,m(s.work_name),1)):(o(),I(U,{key:0,modelValue:s.work_id,"onUpdate:modelValue":[i=>s.work_id=i,i=>t(p)],items:c.works,placeholder:"Выберите работу"},null,8,["modelValue","onUpdate:modelValue","items"]))]),e("td",fe,[!c.disabled&&!s.is_group?V((o(),l("input",{key:0,"onUpdate:modelValue":i=>s.quantity=i,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:i=>u(p)},null,40,_e)),[[$,s.quantity,void 0,{number:!0}]]):(o(),l("span",ge,m(s.quantity),1))]),e("td",he,m(s.unit),1),e("td",ke,[!c.disabled&&!s.is_group?V((o(),l("input",{key:0,"onUpdate:modelValue":i=>s.price=i,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:i=>u(p)},null,40,we)),[[$,s.price,void 0,{number:!0}]]):(o(),l("span",Ve,m(_(s.price)),1))]),e("td",$e,m(_(s.sum)),1),e("td",Ue,[!c.disabled&&!s.is_group?V((o(),l("input",{key:0,"onUpdate:modelValue":i=>s.labor=i,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded"},null,8,Ce)),[[$,s.labor,void 0,{number:!0}]]):(o(),l("span",je,m(_(s.labor)),1))]),c.disabled?y("",!0):(o(),l("td",qe,[e("button",{onClick:i=>k(p),class:"text-red-600 hover:text-red-900 text-sm"}," Удалить ",8,Ee)]))],2))),128)),v.value.length===0?(o(),l("tr",Ie,[e("td",{colspan:c.disabled?7:8,class:"px-3 py-8 text-center text-sm text-gray-500"}," Нет строк ",8,De)])):y("",!0)])])]),e("div",Fe,[(o(!0),l(F,null,N(v.value,(s,p)=>(o(),l("div",{key:p,class:"border border-gray-200 rounded-lg p-4 space-y-3"},[e("div",Ne,[e("span",Be,"Строка "+m(p+1),1),c.disabled?y("",!0):(o(),l("button",{key:0,onClick:i=>k(p),class:"text-red-600 hover:text-red-900 text-sm"}," Удалить ",8,Pe))]),e("div",ze,[e("div",null,[a[9]||(a[9]=e("label",{class:"block text-xs font-medium text-gray-500"},"Работа",-1)),c.disabled?(o(),l("span",Le,m(s.work_name),1)):(o(),I(U,{key:0,modelValue:s.work_id,"onUpdate:modelValue":[i=>s.work_id=i,i=>t(p)],items:c.works,placeholder:"Выберите работу"},null,8,["modelValue","onUpdate:modelValue","items"]))]),e("div",Re,[e("div",null,[a[10]||(a[10]=e("label",{class:"block text-xs font-medium text-gray-500"},"Количество",-1)),!c.disabled&&!s.is_group?V((o(),l("input",{key:0,"onUpdate:modelValue":i=>s.quantity=i,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:i=>u(p)},null,40,Se)),[[$,s.quantity,void 0,{number:!0}]]):(o(),l("span",Oe,m(s.quantity),1))]),e("div",null,[a[11]||(a[11]=e("label",{class:"block text-xs font-medium text-gray-500"},"Ед. изм.",-1)),e("span",Te,m(s.unit),1)])]),e("div",He,[e("div",null,[a[12]||(a[12]=e("label",{class:"block text-xs font-medium text-gray-500"},"Цена",-1)),!c.disabled&&!s.is_group?V((o(),l("input",{key:0,"onUpdate:modelValue":i=>s.price=i,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:i=>u(p)},null,40,Me)),[[$,s.price,void 0,{number:!0}]]):(o(),l("span",Ae,m(_(s.price)),1))]),e("div",null,[a[13]||(a[13]=e("label",{class:"block text-xs font-medium text-gray-500"},"Сумма",-1)),e("span",We,m(_(s.sum)),1)])]),e("div",null,[a[14]||(a[14]=e("label",{class:"block text-xs font-medium text-gray-500"},"Трудоемкость",-1)),!c.disabled&&!s.is_group?V((o(),l("input",{key:0,"onUpdate:modelValue":i=>s.labor=i,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded"},null,8,Ge)),[[$,s.labor,void 0,{number:!0}]]):(o(),l("span",Je,m(_(s.labor)),1))])])]))),128)),v.value.length===0?(o(),l("div",Ke," Нет строк ")):y("",!0)])]))}}),Xe={class:"space-y-6"},Ye={class:"flex items-center justify-between"},Ze={class:"text-2xl font-bold text-gray-900"},et={class:"mt-1 text-sm text-gray-600"},tt={class:"flex items-center space-x-2"},st={key:0,class:"px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"},at={class:"bg-white shadow rounded-lg p-6 space-y-6"},ot={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},lt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t"},rt={class:"mt-1 text-lg font-semibold text-gray-900"},dt={class:"mt-1 text-lg font-semibold text-gray-900"},nt={class:"flex justify-between items-center"},it={key:0,class:"text-sm text-red-600"},ut={class:"flex space-x-3 ml-auto"},mt=["disabled"],ct=["disabled"],pt=["disabled"],ht=z({__name:"EstimateFormView",setup(c){const C=Y(),j=K(),x=Z(),{isAdmin:v}=J(),{printEstimate:_}=ee(),f=w(()=>j.params.id==="new"),k=q(!1),t=q({number:"",date:new Date().toISOString().split("T")[0],customer_id:0,object_id:0,contractor_id:0,responsible_id:0,total_sum:0,total_labor:0,is_posted:!1,posted_at:null,is_deleted:!1,lines:[]}),u=q({}),g=q(""),n=q(!1),a=w(()=>x.counterparties.filter(d=>!d.is_deleted)),s=w(()=>x.objects.filter(d=>!d.is_deleted)),p=w(()=>x.organizations.filter(d=>!d.is_deleted)),i=w(()=>x.persons.filter(d=>!d.is_deleted)),R=w(()=>x.works.filter(d=>!d.is_deleted));function D(d){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(d)}function S(d){t.value.total_sum=d.sum,t.value.total_labor=d.labor}async function E(){if(!f.value)try{const d=await se(Number(j.params.id));t.value=d}catch(d){console.error("Failed to load estimate:",d),alert("Ошибка загрузки сметы"),C.push("/documents/estimates")}}async function O(){if(u.value={},t.value.number.trim()||(u.value.number="Обязательное поле"),t.value.date||(u.value.date="Обязательное поле"),t.value.customer_id||(u.value.customer_id="Обязательное поле"),t.value.object_id||(u.value.object_id="Обязательное поле"),t.value.contractor_id||(u.value.contractor_id="Обязательное поле"),t.value.responsible_id||(u.value.responsible_id="Обязательное поле"),!(Object.keys(u.value).length>0)){n.value=!0,g.value="";try{if(f.value){const d=await ae(t.value);C.push(`/documents/estimates/${d.id}`)}else await oe(t.value.id,t.value),await E()}catch(d){const r=d;g.value=r.response?.data?.detail||"Ошибка при сохранении"}finally{n.value=!1}}}async function T(){if(confirm("Провести смету?")){n.value=!0;try{await le(t.value.id),await E()}catch(d){alert(d.response?.data?.detail||"Ошибка при проведении")}finally{n.value=!1}}}async function H(){if(confirm("Отменить проведение сметы?")){n.value=!0;try{await re(t.value.id),await E()}catch(d){alert(d.response?.data?.detail||"Ошибка при отмене проведения")}finally{n.value=!1}}}function M(){C.push("/documents/estimates")}async function A(d,r){try{await _(t.value.id,d,r,`Смета_${t.value.number}`),k.value=!1}catch(b){console.error("Print failed:",b)}}return Q(async()=>{await Promise.all([x.fetchCounterparties(),x.fetchObjects(),x.fetchOrganizations(),x.fetchPersons(),x.fetchWorks()]),await E()}),(d,r)=>(o(),I(de,null,{default:X(()=>[e("div",Xe,[e("div",Ye,[e("div",null,[e("h2",Ze,m(f.value?"Новая смета":`Смета ${t.value.number}`),1),e("p",et,m(f.value?"Создание новой сметы":"Редактирование сметы"),1)]),e("div",tt,[t.value.is_posted?(o(),l("span",st," Проведен ")):y("",!0),e("button",{onClick:M,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Назад ")])]),e("div",at,[e("div",ot,[h(P,{modelValue:t.value.number,"onUpdate:modelValue":r[0]||(r[0]=b=>t.value.number=b),label:"Номер",type:"text",required:"",disabled:t.value.is_posted,error:u.value.number},null,8,["modelValue","disabled","error"]),h(P,{modelValue:t.value.date,"onUpdate:modelValue":r[1]||(r[1]=b=>t.value.date=b),label:"Дата",type:"date",required:"",disabled:t.value.is_posted,error:u.value.date},null,8,["modelValue","disabled","error"]),h(U,{modelValue:t.value.customer_id,"onUpdate:modelValue":r[2]||(r[2]=b=>t.value.customer_id=b),label:"Заказчик",items:a.value,required:"",disabled:t.value.is_posted,error:u.value.customer_id},null,8,["modelValue","items","disabled","error"]),h(U,{modelValue:t.value.object_id,"onUpdate:modelValue":r[3]||(r[3]=b=>t.value.object_id=b),label:"Объект",items:s.value,required:"",disabled:t.value.is_posted,error:u.value.object_id},null,8,["modelValue","items","disabled","error"]),h(U,{modelValue:t.value.contractor_id,"onUpdate:modelValue":r[4]||(r[4]=b=>t.value.contractor_id=b),label:"Подрядчик",items:p.value,required:"",disabled:t.value.is_posted,error:u.value.contractor_id},null,8,["modelValue","items","disabled","error"]),h(U,{modelValue:t.value.responsible_id,"onUpdate:modelValue":r[5]||(r[5]=b=>t.value.responsible_id=b),label:"Ответственный",items:i.value,"display-key":"full_name",required:"",disabled:t.value.is_posted,error:u.value.responsible_id},null,8,["modelValue","items","disabled","error"])]),e("div",lt,[e("div",null,[r[9]||(r[9]=e("label",{class:"block text-sm font-medium text-gray-700"},"Общая сумма",-1)),e("div",rt,m(D(t.value.total_sum)),1)]),e("div",null,[r[10]||(r[10]=e("label",{class:"block text-sm font-medium text-gray-700"},"Общая трудоемкость",-1)),e("div",dt,m(D(t.value.total_labor)),1)])])]),h(Qe,{modelValue:t.value.lines,"onUpdate:modelValue":r[6]||(r[6]=b=>t.value.lines=b),works:R.value,disabled:t.value.is_posted,"onUpdate:totals":S},null,8,["modelValue","works","disabled"]),e("div",nt,[g.value?(o(),l("div",it,m(g.value),1)):y("",!0),e("div",ut,[f.value?y("",!0):(o(),l("button",{key:0,onClick:r[7]||(r[7]=b=>k.value=!0),class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...r[11]||(r[11]=[e("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1),L(" Печать ",-1)])])),!f.value&&B(v)&&!t.value.is_posted?(o(),l("button",{key:1,onClick:T,disabled:n.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50"}," Провести ",8,mt)):y("",!0),!f.value&&B(v)&&t.value.is_posted?(o(),l("button",{key:2,onClick:H,disabled:n.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"}," Отменить проведение ",8,ct)):y("",!0),t.value.is_posted?y("",!0):(o(),l("button",{key:3,onClick:O,disabled:n.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"},m(n.value?"Сохранение...":"Сохранить"),9,pt))])])]),h(te,{open:k.value,"document-type":"estimate","document-id":t.value.id,"document-name":`Смета_${t.value.number}`,onClose:r[8]||(r[8]=b=>k.value=!1),onPrint:A},null,8,["open","document-id","document-name"])]),_:1}))}});export{ht as default};
