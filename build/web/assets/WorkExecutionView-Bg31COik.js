const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/documents-ChgHnlwZ.js","assets/index-DUoOKtDv.js","assets/index-DKXCwU4m.css"])))=>i.map(i=>d[i]);
import{E as R,d as M,f as b,p as N,j as p,k as B,a as t,t as o,F as S,m as U,i as L,x as W,o as u,g as V,h as z,_ as A,c as P,w as I,b as f,n as q}from"./index-DUoOKtDv.js";import{u as T}from"./references-eDFEYnSt.js";import{_ as G}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as F}from"./FormField.vue_vue_type_script_setup_true_lang-BL-nFudA.js";import{_ as O}from"./Picker.vue_vue_type_script_setup_true_lang-BLaBmckP.js";async function H(y){return(await R.get("/registers/work-execution",{params:y})).data}async function J(y){return(await R.get("/registers/work-execution/movements",{params:y})).data}const K={class:"flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0"},Q={class:"inline-block w-full max-w-5xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl"},X={class:"px-6 py-4 bg-gray-50 border-b border-gray-200"},Y={class:"mt-1 text-sm text-gray-600"},Z={class:"px-6 py-4 max-h-[70vh] overflow-y-auto"},tt={key:0,class:"text-center py-8"},et={key:1},st={class:"min-w-full divide-y divide-gray-200"},at={class:"bg-white divide-y divide-gray-200"},it=["onDblclick"],ot={class:"px-4 py-3 text-sm text-gray-900"},lt={class:"px-4 py-3 text-sm text-blue-600 hover:text-blue-800"},rt={class:"px-4 py-3 text-sm text-gray-900"},nt={class:"px-4 py-3 text-sm text-right text-gray-900"},dt={class:"px-4 py-3 text-sm text-right text-gray-900"},ut={class:"px-4 py-3 text-sm text-right text-gray-900"},pt={class:"px-4 py-3 text-sm text-right text-gray-900"},xt={key:2,class:"text-center py-8 text-gray-500"},ct=M({__name:"WorkExecutionDetailDialog",props:{isOpen:{type:Boolean},periodStart:{},periodEnd:{},filters:{}},emits:["close"],setup(y,{emit:_}){const a=y,j=_,c=W(),h=b(!1),m=b([]);function v(r){return new Date(r).toLocaleDateString("ru-RU")}function w(r){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(r)}async function C(){if(a.isOpen){h.value=!0;try{const r={period_from:a.periodStart,period_to:a.periodEnd};a.filters.object_id&&(r.object_id=a.filters.object_id),a.filters.estimate_id&&(r.estimate_id=a.filters.estimate_id),a.filters.work_id&&(r.work_id=a.filters.work_id);const l=[];let d=1,D=!0;for(;D;){const E={...r,page:d,page_size:100},k=await J(E);l.push(...k.data),D=!!(k.pagination&&d<k.pagination.total_pages),d++}m.value=l}catch(r){console.error("Failed to load work execution movements:",r)}finally{h.value=!1}}}function g(){j("close")}function n(r){r.recorder_type==="estimate"?c.push(`/documents/estimates/${r.recorder_id}`):r.recorder_type==="daily_report"&&c.push(`/documents/daily-reports/${r.recorder_id}`),g()}return N(()=>a.isOpen,r=>{r&&C()}),(r,l)=>y.isOpen?(u(),p("div",{key:0,class:"fixed inset-0 z-50 overflow-y-auto",onClick:L(g,["self"])},[t("div",K,[t("div",{class:"fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75",onClick:g}),t("div",Q,[t("div",X,[t("div",{class:"flex items-center justify-between"},[l[1]||(l[1]=t("h3",{class:"text-lg font-medium text-gray-900"}," Детализация выполнения работ ",-1)),t("button",{onClick:g,class:"text-gray-400 hover:text-gray-500"},[...l[0]||(l[0]=[t("span",{class:"sr-only"},"Закрыть",-1),t("svg",{class:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),t("p",Y," Период: "+o(v(y.periodStart))+" - "+o(v(y.periodEnd)),1)]),t("div",Z,[h.value?(u(),p("div",tt,[...l[2]||(l[2]=[t("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1),t("p",{class:"mt-2 text-sm text-gray-600"},"Загрузка...",-1)])])):m.value.length>0?(u(),p("div",et,[t("table",st,[l[3]||(l[3]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Тип документа "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Номер/Дата "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Дата движения "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Приход кол-во "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Расход кол-во "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Приход сумма "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Расход сумма ")])],-1)),t("tbody",at,[(u(!0),p(S,null,U(m.value,d=>(u(),p("tr",{key:d.id,class:"hover:bg-gray-50 cursor-pointer",onDblclick:D=>n(d)},[t("td",ot,o(d.recorder_type==="estimate"?"Смета":"Ежедневный отчет"),1),t("td",lt,o(d.estimate_number||v(d.period)),1),t("td",rt,o(v(d.period)),1),t("td",nt,o(w(d.quantity_income)),1),t("td",dt,o(w(d.quantity_expense)),1),t("td",ut,o(w(d.sum_income)),1),t("td",pt,o(w(d.sum_expense)),1)],40,it))),128))])]),l[4]||(l[4]=t("p",{class:"mt-4 text-sm text-gray-500 italic"}," Дважды кликните на строку, чтобы открыть документ ",-1))])):(u(),p("div",xt," Нет данных "))]),t("div",{class:"px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end"},[t("button",{onClick:g,class:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"}," Закрыть ")])])])])):B("",!0)}}),mt={class:"space-y-6"},yt={class:"bg-white shadow rounded-lg p-6"},_t={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},gt={class:"bg-white shadow rounded-lg p-6"},ft={key:0,class:"text-center py-8"},bt={key:1,class:"space-y-4"},ht={class:"hidden md:block overflow-x-auto"},vt={class:"min-w-full divide-y divide-gray-200"},wt={class:"bg-white divide-y divide-gray-200"},kt=["onDblclick"],$t={class:"px-4 py-3 text-sm text-gray-900"},qt={class:"px-4 py-3 text-sm text-gray-900"},jt={class:"px-4 py-3 text-sm text-gray-900"},Dt={class:"px-4 py-3 text-sm text-gray-900"},Vt={class:"px-4 py-3 text-sm text-right text-gray-900"},Ct={class:"px-4 py-3 text-sm text-right text-gray-900"},Et={class:"px-4 py-3 text-sm text-right text-gray-900"},Ft={class:"px-4 py-3 text-sm text-right text-gray-900"},Ot={class:"bg-gray-50 font-semibold"},St={class:"px-4 py-3 text-sm text-right text-gray-900"},Ut={class:"px-4 py-3 text-sm text-right text-gray-900"},Rt={class:"px-4 py-3 text-sm text-right text-gray-900"},Mt={class:"px-4 py-3 text-sm text-right text-gray-900"},Bt={class:"md:hidden space-y-4"},Nt=["onClick"],Lt={class:"grid grid-cols-2 gap-2 text-sm"},Wt={class:"ml-2 text-gray-900"},zt={class:"ml-2 text-gray-900"},At={class:"ml-2 text-gray-900"},Pt={class:"ml-2 text-gray-900"},It={class:"border-t pt-2 grid grid-cols-2 gap-2 text-sm"},Tt={class:"ml-2 text-gray-900"},Gt={class:"ml-2 text-gray-900"},Ht={class:"col-span-2"},Jt={class:"border-2 border-gray-300 rounded-lg p-4 bg-gray-50"},Kt={class:"grid grid-cols-2 gap-2 text-sm"},Qt={class:"ml-2 text-gray-900"},Xt={class:"ml-2 text-gray-900"},Yt={class:"col-span-2"},Zt={key:2,class:"text-center py-8 text-gray-500"},te={key:3,class:"mt-4 text-sm text-gray-500 italic"},le=M({__name:"WorkExecutionView",setup(y){const _=T(),a=b({period_from:"",period_to:"",object_id:null,estimate_id:null,work_id:null,group_by:""}),j=b(!1),c=b([]),h=b([]),m=b({isOpen:!1,periodStart:"",periodEnd:"",filters:{}}),v=[{value:"",label:"Без группировки"},{value:"object",label:"По объекту"},{value:"estimate",label:"По смете"},{value:"work",label:"По работе"}],w=V(()=>_.objects.filter(s=>!s.is_deleted).map(s=>({id:s.id,name:s.name}))),C=V(()=>_.works.filter(s=>!s.is_deleted).map(s=>({id:s.id,name:s.name}))),g=V(()=>h.value.map(s=>({id:s.id,name:`${s.number} от ${r(s.date)}`}))),n=V(()=>c.value.reduce((s,e)=>(s.income_quantity+=e.income_quantity,s.income_sum+=e.income_sum,s.expense_quantity+=e.expense_quantity,s.expense_sum+=e.expense_sum,s.balance_quantity+=e.balance_quantity,s.balance_sum+=e.balance_sum,s),{income_quantity:0,income_sum:0,expense_quantity:0,expense_sum:0,balance_quantity:0,balance_sum:0}));function r(s){return new Date(s).toLocaleDateString("ru-RU")}function l(s){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(s)}async function d(){j.value=!0;try{const s={};a.value.period_from&&(s.period_from=a.value.period_from),a.value.period_to&&(s.period_to=a.value.period_to),a.value.object_id&&(s.object_id=a.value.object_id),a.value.estimate_id&&(s.estimate_id=a.value.estimate_id),a.value.work_id&&(s.work_id=a.value.work_id),a.value.group_by&&(s.group_by=a.value.group_by);const e=await H(s);c.value=e.data}catch(s){console.error("Failed to load work execution register:",s)}finally{j.value=!1}}function D(){d()}function E(){a.value={period_from:"",period_to:"",object_id:null,estimate_id:null,work_id:null,group_by:""},c.value=[]}function k(s){!a.value.period_from||!a.value.period_to||(m.value={isOpen:!0,periodStart:a.value.period_from,periodEnd:a.value.period_to,filters:{object_id:s.object_id||a.value.object_id,estimate_id:s.estimate_id||a.value.estimate_id,work_id:s.work_id||a.value.work_id}})}return z(async()=>{await Promise.all([_.fetchObjects(),_.fetchWorks()]);try{const{default:s}=await A(async()=>{const{default:x}=await import("./documents-ChgHnlwZ.js");return{default:x}},__vite__mapDeps([0,1,2])),e=[];let i=1,$=!0;for(;$;){const x=await s.getEstimates({page:i,page_size:100});e.push(...x.data),$=!!(x.pagination&&i<x.pagination.total_pages),i++}h.value=e.map(x=>({id:x.id,number:x.number,date:x.date}))}catch(s){console.error("Failed to load estimates:",s)}}),(s,e)=>(u(),P(G,null,{default:I(()=>[t("div",mt,[e[22]||(e[22]=t("div",null,[t("h2",{class:"text-2xl font-bold text-gray-900"},"Регистр выполнения работ"),t("p",{class:"mt-1 text-sm text-gray-600"},"Просмотр движений по выполнению работ")],-1)),t("div",yt,[e[7]||(e[7]=t("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Фильтры",-1)),t("div",_t,[f(F,{modelValue:a.value.period_from,"onUpdate:modelValue":e[0]||(e[0]=i=>a.value.period_from=i),label:"Период с",type:"date"},null,8,["modelValue"]),f(F,{modelValue:a.value.period_to,"onUpdate:modelValue":e[1]||(e[1]=i=>a.value.period_to=i),label:"Период по",type:"date"},null,8,["modelValue"]),f(O,{modelValue:a.value.object_id,"onUpdate:modelValue":e[2]||(e[2]=i=>a.value.object_id=i),label:"Объект",items:w.value,placeholder:"Все объекты"},null,8,["modelValue","items"]),f(O,{modelValue:a.value.estimate_id,"onUpdate:modelValue":e[3]||(e[3]=i=>a.value.estimate_id=i),label:"Смета",items:g.value,placeholder:"Все сметы"},null,8,["modelValue","items"]),f(O,{modelValue:a.value.work_id,"onUpdate:modelValue":e[4]||(e[4]=i=>a.value.work_id=i),label:"Работа",items:C.value,placeholder:"Все работы"},null,8,["modelValue","items"]),f(F,{modelValue:a.value.group_by,"onUpdate:modelValue":e[5]||(e[5]=i=>a.value.group_by=i),label:"Группировка",type:"select",options:v},null,8,["modelValue"])]),t("div",{class:"mt-4 flex space-x-3"},[t("button",{onClick:D,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"}," Применить "),t("button",{onClick:E,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Сбросить ")])]),t("div",gt,[j.value?(u(),p("div",ft,[...e[8]||(e[8]=[t("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1),t("p",{class:"mt-2 text-sm text-gray-600"},"Загрузка...",-1)])])):c.value.length>0?(u(),p("div",bt,[t("div",ht,[t("table",vt,[e[10]||(e[10]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Период "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Объект "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Смета "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Работа "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Приход кол. "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Приход сумма "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Расход кол. "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Расход сумма "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Остаток кол. "),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"}," Остаток сумма ")])],-1)),t("tbody",wt,[(u(!0),p(S,null,U(c.value,(i,$)=>(u(),p("tr",{key:$,class:"hover:bg-gray-50 cursor-pointer",onDblclick:x=>k(i)},[t("td",$t,o(r(i.period)),1),t("td",qt,o(i.object_name),1),t("td",jt,o(i.estimate_number),1),t("td",Dt,o(i.work_name),1),t("td",Vt,o(l(i.income_quantity)),1),t("td",Ct,o(l(i.income_sum)),1),t("td",Et,o(l(i.expense_quantity)),1),t("td",Ft,o(l(i.expense_sum)),1),t("td",{class:q(["px-4 py-3 text-sm text-right font-medium",i.balance_quantity>=0?"text-green-600":"text-red-600"])},o(l(i.balance_quantity)),3),t("td",{class:q(["px-4 py-3 text-sm text-right font-medium",i.balance_sum>=0?"text-green-600":"text-red-600"])},o(l(i.balance_sum)),3)],40,kt))),128)),t("tr",Ot,[e[9]||(e[9]=t("td",{colspan:"4",class:"px-4 py-3 text-sm text-gray-900"},"Итого:",-1)),t("td",St,o(l(n.value.income_quantity)),1),t("td",Ut,o(l(n.value.income_sum)),1),t("td",Rt,o(l(n.value.expense_quantity)),1),t("td",Mt,o(l(n.value.expense_sum)),1),t("td",{class:q(["px-4 py-3 text-sm text-right",n.value.balance_quantity>=0?"text-green-600":"text-red-600"])},o(l(n.value.balance_quantity)),3),t("td",{class:q(["px-4 py-3 text-sm text-right",n.value.balance_sum>=0?"text-green-600":"text-red-600"])},o(l(n.value.balance_sum)),3)])])])]),t("div",Bt,[(u(!0),p(S,null,U(c.value,(i,$)=>(u(),p("div",{key:$,class:"border border-gray-200 rounded-lg p-4 space-y-2 cursor-pointer hover:bg-gray-50",onClick:x=>k(i)},[t("div",Lt,[t("div",null,[e[11]||(e[11]=t("span",{class:"text-gray-500"},"Период:",-1)),t("span",Wt,o(r(i.period)),1)]),t("div",null,[e[12]||(e[12]=t("span",{class:"text-gray-500"},"Объект:",-1)),t("span",zt,o(i.object_name),1)]),t("div",null,[e[13]||(e[13]=t("span",{class:"text-gray-500"},"Смета:",-1)),t("span",At,o(i.estimate_number),1)]),t("div",null,[e[14]||(e[14]=t("span",{class:"text-gray-500"},"Работа:",-1)),t("span",Pt,o(i.work_name),1)])]),t("div",It,[t("div",null,[e[15]||(e[15]=t("span",{class:"text-gray-500"},"Приход:",-1)),t("span",Tt,o(l(i.income_quantity))+" / "+o(l(i.income_sum)),1)]),t("div",null,[e[16]||(e[16]=t("span",{class:"text-gray-500"},"Расход:",-1)),t("span",Gt,o(l(i.expense_quantity))+" / "+o(l(i.expense_sum)),1)]),t("div",Ht,[e[17]||(e[17]=t("span",{class:"text-gray-500"},"Остаток:",-1)),t("span",{class:q(["ml-2 font-medium",i.balance_quantity>=0?"text-green-600":"text-red-600"])},o(l(i.balance_quantity))+" / "+o(l(i.balance_sum)),3)])])],8,Nt))),128)),t("div",Jt,[e[21]||(e[21]=t("div",{class:"text-sm font-semibold text-gray-900 mb-2"},"Итого:",-1)),t("div",Kt,[t("div",null,[e[18]||(e[18]=t("span",{class:"text-gray-500"},"Приход:",-1)),t("span",Qt,o(l(n.value.income_quantity))+" / "+o(l(n.value.income_sum)),1)]),t("div",null,[e[19]||(e[19]=t("span",{class:"text-gray-500"},"Расход:",-1)),t("span",Xt,o(l(n.value.expense_quantity))+" / "+o(l(n.value.expense_sum)),1)]),t("div",Yt,[e[20]||(e[20]=t("span",{class:"text-gray-500"},"Остаток:",-1)),t("span",{class:q(["ml-2 font-semibold",n.value.balance_sum>=0?"text-green-600":"text-red-600"])},o(l(n.value.balance_quantity))+" / "+o(l(n.value.balance_sum)),3)])])])])])):(u(),p("div",Zt," Нет данных. Примените фильтры для поиска. ")),c.value.length>0?(u(),p("p",te," Дважды кликните на строку, чтобы открыть детализацию ")):B("",!0)])]),f(ct,{"is-open":m.value.isOpen,"period-start":m.value.periodStart,"period-end":m.value.periodEnd,filters:m.value.filters,onClose:e[6]||(e[6]=i=>m.value.isOpen=!1)},null,8,["is-open","period-start","period-end","filters"])]),_:1}))}});export{le as default};
