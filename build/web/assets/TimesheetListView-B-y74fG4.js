import{d as P,f as g,h as R,c as V,w as l,a as n,b as M,j as b,k as y,i as x,n as N,t as i,e as u,u as d,l as U,o as m}from"./index-BmuF08LN.js";import{u as I,_ as L}from"./DataTable.vue_vue_type_script_setup_true_lang-BHfRwsQq.js";import{getTimesheets as q,deleteTimesheet as z,bulkDeleteTimesheets as F,bulkPostTimesheets as H,bulkUnpostTimesheets as Y}from"./documents-BLg9IHiW.js";import{_ as A}from"./AppLayout.vue_vue_type_script_setup_true_lang-n4va9pfH.js";const G={class:"space-y-6"},J={key:0,class:"flex gap-2"},K=["onClick"],O=["onClick"],te=P({__name:"TimesheetListView",setup(Q){const h=U(),r=I(),c=g(),o=g([]),k=[{key:"number",label:"Номер"},{key:"date",label:"Дата"},{key:"month_year",label:"Период"},{key:"object_name",label:"Объект"},{key:"estimate_number",label:"Смета"},{key:"foreman_name",label:"Бригадир"},{key:"is_posted",label:"Статус"}];function v(e){return new Date(e).toLocaleDateString("ru-RU")}function _(e){const[t,a]=e.split("-");return new Date(parseInt(t),parseInt(a)-1).toLocaleDateString("ru-RU",{year:"numeric",month:"long"})}async function s(){r.loading.value=!0;try{const e=await q(r.queryParams.value);r.data.value=e.data,r.pagination.value=e.pagination}catch(e){console.error("Failed to load timesheets:",e)}finally{r.loading.value=!1}}function w(e){r.setPage(e),s()}function C(e){r.setSearch(e),s()}function $(e,t){r.setSort(e,t),s()}function S(){h.push("/documents/timesheets/new")}function f(e){h.push(`/documents/timesheets/${e.id}`)}async function D(e){if(confirm(`Удалить табель ${e.number}?`))try{await z(e.id),await s()}catch(t){alert(t.response?.data?.detail||"Ошибка при удалении")}}function E(e){o.value=e}async function B(){if(o.value.length!==0&&confirm(`Удалить выбранные табели (${o.value.length})?`))try{const e=o.value.map(a=>a.id),t=await F(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),c.value?.clearSelection(),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при групповом удалении")}}async function T(){if(o.value.length!==0&&confirm(`Провести выбранные табели (${o.value.length})?`))try{const e=o.value.map(a=>a.id),t=await H(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),c.value?.clearSelection(),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при групповом проведении")}}async function j(){if(o.value.length!==0&&confirm(`Отменить проведение выбранных табелей (${o.value.length})?`))try{const e=o.value.map(a=>a.id),t=await Y(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),c.value?.clearSelection(),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при отмене проведения")}}return R(()=>{s()}),(e,t)=>(m(),V(A,null,{default:l(()=>[n("div",G,[t[1]||(t[1]=n("div",null,[n("h2",{class:"text-2xl font-bold text-gray-900"},"Табели"),n("p",{class:"mt-1 text-sm text-gray-600"},"Управление табелями учета рабочего времени")],-1)),M(L,{ref_key:"tableRef",ref:c,columns:k,data:d(r).data.value,loading:d(r).loading.value,pagination:d(r).pagination.value,selectable:!0,onRowClick:f,onPageChange:w,onSearch:C,onSort:$,onSelectionChange:E},{"bulk-actions":l(({selected:a})=>[a.length>0?(m(),b("div",J,[n("button",{onClick:T,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"}," Провести ("+i(a.length)+") ",1),n("button",{onClick:j,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700"}," Отменить проведение ("+i(a.length)+") ",1),n("button",{onClick:B,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+i(a.length)+") ",1)])):y("",!0)]),"header-actions":l(()=>[n("button",{onClick:S,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...t[0]||(t[0]=[n("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),u(" Создать табель ",-1)])])]),"cell-date":l(({value:a})=>[u(i(v(a)),1)]),"cell-month_year":l(({value:a})=>[u(i(_(a)),1)]),"cell-is_posted":l(({value:a})=>[n("span",{class:N(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",a?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"])},i(a?"Проведен":"Не проведен"),3)]),actions:l(({row:a})=>[n("button",{onClick:x(p=>f(a),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Открыть ",8,K),a.is_posted?y("",!0):(m(),b("button",{key:0,onClick:x(p=>D(a),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,O))]),_:1},8,["data","loading","pagination"])])]),_:1}))}});export{te as default};
