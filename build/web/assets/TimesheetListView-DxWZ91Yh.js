import{d as H,f as g,h as Q,c as G,w as d,a as o,b,j as m,k as $,i as D,n as J,e as v,t as c,u as a,l as h,v as y,m as _,F as T,x as K,o as u}from"./index-OcrUBGsV.js";import{u as W,_ as X}from"./DataTable.vue_vue_type_script_setup_true_lang-CIOfCPly.js";import{u as Z}from"./useFilters-DiIRWo9Z.js";import{u as ee}from"./references-C4ONrARJ.js";import{getTimesheets as te,getEstimates as re,deleteTimesheet as oe,bulkDeleteTimesheets as le,bulkPostTimesheets as ae,bulkUnpostTimesheets as ne}from"./documents-B_kWNFGN.js";import{_ as se}from"./AppLayout.vue_vue_type_script_setup_true_lang-C777ZaO3.js";import{_ as j}from"./DateRangePicker.vue_vue_type_script_setup_true_lang-BuJYH59H.js";const ie={class:"space-y-6"},ue=["value"],de=["value"],me={key:0,class:"flex gap-2"},ce={class:"flex items-center justify-center"},fe=["title"],pe={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},ge={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},be=["onClick"],ve=["onClick"],$e=H({__name:"TimesheetListView",setup(he){const x=K(),n=W(),w=ee(),f=g(),i=g([]),l=Z({dateFrom:null,dateTo:null,periodFrom:null,periodTo:null,objectId:null,estimateId:null,isPosted:null}),k=g([]),C=g([]),P=[{key:"number",label:"Номер",width:"100px"},{key:"date",label:"Дата",width:"100px"},{key:"is_posted",label:"Статус",width:"40px",sortable:!1},{key:"month_year",label:"Период",width:"150px"},{key:"object_name",label:"Объект",width:"250px"},{key:"estimate_number",label:"Смета",width:"120px"},{key:"foreman_name",label:"Бригадир",width:"200px"},{key:"total_hours",label:"Часов",width:"100px"},{key:"author",label:"Автор",width:"150px"}];function E(r){return new Date(r).toLocaleDateString("ru-RU")}function U(r){const[e,t]=r.split("-");return new Date(parseInt(e),parseInt(t)-1).toLocaleDateString("ru-RU",{year:"numeric",month:"long"})}async function s(){n.loading.value=!0;try{const r={...n.queryParams.value,...l.getQueryParams()},e=await te(r);n.data.value=e.data,n.pagination.value=e.pagination}catch(r){console.error("Failed to load timesheets:",r),alert(r.response?.data?.detail||"Ошибка при загрузке")}finally{n.loading.value=!1}}async function B(){try{await w.fetchConstructionObjects(),k.value=w.constructionObjects;const r=await re({page_size:1e3});C.value=r.data}catch(r){console.error("Failed to load references:",r)}}function I(){l.applyFilters(),n.setPage(1),s()}function R(){l.clearAllFilters(),n.setPage(1),s()}function M(r){n.setPage(r),s()}function V(r){n.setSearch(r),s()}function L(r,e){n.setSort(r,e),s()}function N(){x.push("/documents/timesheets/new")}function F(r){x.push(`/documents/timesheets/${r.id}`)}async function Y(r){if(confirm(`Удалить табель ${r.number}?`))try{await oe(r.id),await s()}catch(e){alert(e.response?.data?.detail||"Ошибка при удалении")}}function z(r){i.value=r}async function A(){if(i.value.length!==0&&confirm(`Удалить выбранные табели (${i.value.length})?`))try{const r=i.value.map(t=>t.id),e=await le(r);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),f.value?.clearSelection(),await s()}catch(r){alert(r.response?.data?.detail||"Ошибка при групповом удалении")}}async function O(){if(i.value.length!==0&&confirm(`Провести выбранные табели (${i.value.length})?`))try{const r=i.value.map(t=>t.id),e=await ae(r);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),f.value?.clearSelection(),await s()}catch(r){alert(r.response?.data?.detail||"Ошибка при групповом проведении")}}async function q(){if(i.value.length!==0&&confirm(`Отменить проведение выбранных табелей (${i.value.length})?`))try{const r=i.value.map(t=>t.id),e=await ne(r);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),f.value?.clearSelection(),await s()}catch(r){alert(r.response?.data?.detail||"Ошибка при отмене проведения")}}Q(async()=>{await B();const r=new Date,e=new Date(r.getFullYear(),r.getMonth(),1),t=new Date(r.getFullYear(),r.getMonth()+1,0);l.filters.value.dateFrom=S(e),l.filters.value.dateTo=S(t),l.applyFilters(),s()});function S(r){const e=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),p=String(r.getDate()).padStart(2,"0");return`${e}-${t}-${p}`}return(r,e)=>(u(),G(se,null,{default:d(()=>[o("div",ie,[e[16]||(e[16]=o("div",null,[o("h2",{class:"text-2xl font-bold text-gray-900"},"Табели"),o("p",{class:"mt-1 text-sm text-gray-600"},"Управление табелями учета рабочего времени")],-1)),b(X,{ref_key:"tableRef",ref:f,columns:P,data:a(n).data.value,loading:a(n).loading.value,pagination:a(n).pagination.value,selectable:!0,"has-filters":!0,onRowClick:F,onPageChange:M,onSearch:V,onSort:L,onSelectionChange:z,onRefresh:s,onApplyFilters:I,onClearFilters:R},{filters:d(()=>[b(j,{from:a(l).filters.value.dateFrom,"onUpdate:from":e[0]||(e[0]=t=>a(l).filters.value.dateFrom=t),to:a(l).filters.value.dateTo,"onUpdate:to":e[1]||(e[1]=t=>a(l).filters.value.dateTo=t),label:"Период документа"},null,8,["from","to"]),b(j,{from:a(l).filters.value.periodFrom,"onUpdate:from":e[2]||(e[2]=t=>a(l).filters.value.periodFrom=t),to:a(l).filters.value.periodTo,"onUpdate:to":e[3]||(e[3]=t=>a(l).filters.value.periodTo=t),label:"Табельный период","show-quick-periods":!1},null,8,["from","to"]),o("div",null,[e[8]||(e[8]=o("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Объект",-1)),h(o("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a(l).filters.value.objectId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[7]||(e[7]=o("option",{value:null},"Все объекты",-1)),(u(!0),m(T,null,_(k.value,t=>(u(),m("option",{key:t.id,value:t.id},c(t.name),9,ue))),128))],512),[[y,a(l).filters.value.objectId]])]),o("div",null,[e[10]||(e[10]=o("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Смета",-1)),h(o("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>a(l).filters.value.estimateId=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[e[9]||(e[9]=o("option",{value:null},"Все сметы",-1)),(u(!0),m(T,null,_(C.value,t=>(u(),m("option",{key:t.id,value:t.id},c(t.number)+" - "+c(t.object_name),9,de))),128))],512),[[y,a(l).filters.value.estimateId]])]),o("div",null,[e[12]||(e[12]=o("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Статус проведения",-1)),h(o("select",{"onUpdate:modelValue":e[6]||(e[6]=t=>a(l).filters.value.isPosted=t),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[11]||(e[11]=[o("option",{value:null},"Все",-1),o("option",{value:!0},"Проведенные",-1),o("option",{value:!1},"Не проведенные",-1)])],512),[[y,a(l).filters.value.isPosted]])])]),"bulk-actions":d(({selected:t})=>[t.length>0?(u(),m("div",me,[o("button",{onClick:O,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700"}," Провести ("+c(t.length)+") ",1),o("button",{onClick:q,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700"}," Отменить проведение ("+c(t.length)+") ",1),o("button",{onClick:A,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+c(t.length)+") ",1)])):$("",!0)]),"header-actions":d(()=>[o("button",{onClick:N,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...e[13]||(e[13]=[o("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),v(" Создать табель ",-1)])])]),"cell-date":d(({value:t})=>[v(c(E(t)),1)]),"cell-month_year":d(({value:t})=>[v(c(U(t)),1)]),"cell-is_posted":d(({value:t})=>[o("div",ce,[o("span",{class:J(["inline-flex items-center justify-center w-6 h-6 rounded-full",t?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400"]),title:t?"Проведен":"Не проведен"},[t?(u(),m("svg",pe,[...e[14]||(e[14]=[o("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])])):(u(),m("svg",ge,[...e[15]||(e[15]=[o("circle",{cx:"10",cy:"10",r:"3"},null,-1)])]))],10,fe)])]),actions:d(({row:t})=>[o("button",{onClick:D(p=>F(t),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Открыть ",8,be),t.is_posted?$("",!0):(u(),m("button",{key:0,onClick:D(p=>Y(t),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,ve))]),_:1},8,["data","loading","pagination"])])]),_:1}))}});export{$e as default};
