import{d as G,f as y,g as E,p as J,h as K,c as X,w as i,a as t,b as x,n as k,i as C,u as r,j as m,e as F,t as b,q as Y,k as $,l as v,v as _,s as B,o as u}from"./index-OcrUBGsV.js";import{u as Z}from"./useReferenceView-BwLXfedD.js";import{u as ee}from"./useFilters-DiIRWo9Z.js";import{u as te,k as j,l as le,m as oe,n as re,o as ae}from"./references-C4ONrARJ.js";import{_ as ne}from"./AppLayout.vue_vue_type_script_setup_true_lang-C777ZaO3.js";import{_ as se}from"./DataTable.vue_vue_type_script_setup_true_lang-CIOfCPly.js";import{_ as ie}from"./Modal.vue_vue_type_script_setup_true_lang-BNdb9fbR.js";import{_ as z}from"./FormField.vue_vue_type_script_setup_true_lang-CJXR9oI6.js";import{_ as ue}from"./Picker.vue_vue_type_script_setup_true_lang-Je5YKjAW.js";const de={class:"space-y-6"},me={class:"flex items-center justify-between"},pe={class:"flex items-center gap-2 bg-white border border-gray-300 rounded-lg p-1"},fe=["onClick"],be={key:1,class:"w-4 h-4 mr-2 text-yellow-500",fill:"currentColor",viewBox:"0 0 20 20"},ve={key:2,class:"w-4 h-4 mr-2 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},ce={key:0,class:"text-sm text-gray-900"},ge={key:1,class:"text-gray-400"},he={class:"flex items-center justify-center"},ye=["title"],xe={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},ke={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},we=["onClick"],Ce=["onClick"],_e={key:0,class:"rounded-md bg-red-50 p-4"},Ve={class:"text-sm text-red-800"},Se=["disabled"],Le=G({__name:"WorksView",setup(De){const D=te(),M=y(),w=y([]),d=y("hierarchy"),c=y(new Set),V=y(1e3),s=ee({category:null,unit:null,priceFrom:null,priceTo:null,isDeleted:null}),o=Z({getAll:j,create:ae,update:re,delete:oe},()=>D.fetchWorks(!0)),P=[{key:"code",label:"Код",width:"100px"},{key:"name",label:"Наименование",width:"400px"},{key:"unit",label:"Ед. изм.",width:"100px"},{key:"category",label:"Категория",width:"150px"},{key:"standard_price",label:"Норм. стоимость",width:"120px"},{key:"is_deleted",label:"",width:"40px",sortable:!1}];function U(a){w.value=a}async function L(){if(w.value.length!==0&&confirm(`Удалить выбранные виды работ (${w.value.length})?`))try{const a=w.value.map(l=>l.id),e=await le(a);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),M.value?.clearSelection(),await o.loadData()}catch(a){alert(a.response?.data?.detail||"Ошибка при групповом удалении")}}function R(){s.applyFilters(),o.table.setPage(1),o.loadData()}function W(){s.clearAllFilters(),o.table.setPage(1),o.loadData()}function N(a){return{construction:"Строительные работы",electrical:"Электромонтажные работы",plumbing:"Сантехнические работы",finishing:"Отделочные работы"}[a]||a}function H(a){return a==null?"—":new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a)}function q(a){const e=new Map,l=[];a.forEach(n=>{e.set(n.id,{...n,_children:[],_level:0,_hasChildren:!1})}),a.forEach(n=>{const h=e.get(n.id);if(n.parent_id&&e.has(n.parent_id)){const f=e.get(n.parent_id);f._children.push(h),f._hasChildren=!0}else l.push(h)});function p(n,h){n.forEach(f=>{f._level=h,f._children&&f._children.length>0&&p(f._children,h+1)})}return p(l,0),l}function T(a){const e=[];function l(p){p.forEach(n=>{e.push(n),n._hasChildren&&c.value.has(n.id)&&n._children&&l(n._children)})}return l(a),e}function A(a){c.value.has(a)?c.value.delete(a):c.value.add(a)}const S=E(()=>{const a=o.table.data.value;if(d.value==="hierarchy"){const e=q(a);return T(e)}return a.map(e=>({...e,_level:0,_hasChildren:!1}))}),I=E(()=>d.value==="hierarchy"?{page:1,page_size:S.value.length,total_items:S.value.length,total_pages:1}:o.table.pagination.value);async function g(){o.table.loading.value=!0;try{const a={page:o.table.pagination.value?.page||1,page_size:d.value==="hierarchy"?1e4:V.value,search:o.table.queryParams.value.search,sort_by:o.table.queryParams.value.sort_by,sort_order:o.table.queryParams.value.sort_order,...s.getQueryParams()},e=await j(a);o.table.data.value=e.data,o.table.pagination.value=e.pagination,await D.fetchWorks(!0)}catch(a){console.error("Failed to load works:",a),alert(a.response?.data?.detail||"Ошибка при загрузке данных")}finally{o.table.loading.value=!1}}function O(a){o.table.setPage(a),g()}function Q(){o.table.setPage(1),g()}return J(d,()=>{g()}),K(()=>{g()}),(a,e)=>(u(),X(ne,null,{default:i(()=>[t("div",de,[t("div",me,[e[17]||(e[17]=t("div",null,[t("h2",{class:"text-2xl font-bold text-gray-900"},"Работы"),t("p",{class:"mt-1 text-sm text-gray-600"},"Управление справочником работ")],-1)),t("div",pe,[t("button",{onClick:e[0]||(e[0]=l=>d.value="flat"),class:k(["px-3 py-1.5 text-sm font-medium rounded-md transition-colors",d.value==="flat"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"]),title:"Плоский список"},[...e[15]||(e[15]=[t("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])],2),t("button",{onClick:e[1]||(e[1]=l=>d.value="hierarchy"),class:k(["px-3 py-1.5 text-sm font-medium rounded-md transition-colors",d.value==="hierarchy"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"]),title:"Иерархический список"},[...e[16]||(e[16]=[t("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})],-1)])],2)])]),x(se,{ref_key:"tableRef",ref:M,columns:P,data:S.value,loading:r(o).table.loading.value,pagination:I.value,selectable:!0,"has-filters":!0,onRowClick:r(o).handleEdit,onPageChange:O,onSearch:r(o).handleSearch,onSort:r(o).handleSort,onSelectionChange:U,onRefresh:g,onApplyFilters:R,onClearFilters:W},{filters:i(()=>[t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Элементов на странице",-1)),v(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>V.value=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",onChange:Q},[...e[18]||(e[18]=[t("option",{value:25},"25",-1),t("option",{value:50},"50",-1),t("option",{value:100},"100",-1),t("option",{value:500},"500",-1),t("option",{value:1e3},"1000",-1)])],544),[[_,V.value,void 0,{number:!0}]])]),t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Категория",-1)),v(t("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>r(s).filters.value.category=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[20]||(e[20]=[t("option",{value:null},"Все категории",-1),t("option",{value:"construction"},"Строительные работы",-1),t("option",{value:"electrical"},"Электромонтажные работы",-1),t("option",{value:"plumbing"},"Сантехнические работы",-1),t("option",{value:"finishing"},"Отделочные работы",-1)])],512),[[_,r(s).filters.value.category]])]),t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Единица измерения",-1)),v(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>r(s).filters.value.unit=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[22]||(e[22]=[t("option",{value:null},"Все единицы",-1),t("option",{value:"м²"},"м²",-1),t("option",{value:"м³"},"м³",-1),t("option",{value:"м"},"м",-1),t("option",{value:"шт"},"шт",-1),t("option",{value:"т"},"т",-1),t("option",{value:"кг"},"кг",-1)])],512),[[_,r(s).filters.value.unit]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Стоимость от",-1)),v(t("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>r(s).filters.value.priceFrom=l),type:"number",step:"0.01",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0.00"},null,512),[[B,r(s).filters.value.priceFrom,void 0,{number:!0}]])]),t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Стоимость до",-1)),v(t("input",{"onUpdate:modelValue":e[6]||(e[6]=l=>r(s).filters.value.priceTo=l),type:"number",step:"0.01",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0.00"},null,512),[[B,r(s).filters.value.priceTo,void 0,{number:!0}]])]),t("div",null,[e[27]||(e[27]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Удаленные",-1)),v(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>r(s).filters.value.isDeleted=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[26]||(e[26]=[t("option",{value:null},"Все",-1),t("option",{value:!1},"Активные",-1),t("option",{value:!0},"Удаленные",-1)])],512),[[_,r(s).filters.value.isDeleted]])])]),"bulk-actions":i(({selected:l})=>[t("button",{onClick:L,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+b(l.length)+") ",1)]),"header-actions":i(()=>[t("button",{onClick:e[8]||(e[8]=(...l)=>r(o).handleCreate&&r(o).handleCreate(...l)),class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...e[28]||(e[28]=[t("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),F(" Создать ",-1)])])]),"cell-name":i(({row:l,value:p})=>[t("div",{style:Y({paddingLeft:`${l._level*24}px`}),class:"flex items-center"},[l._hasChildren&&d.value==="hierarchy"?(u(),m("button",{key:0,onClick:C(n=>A(l.id),["stop"]),class:"mr-2 p-0.5 hover:bg-gray-100 rounded"},[(u(),m("svg",{class:k(["w-4 h-4 transition-transform",{"transform rotate-90":c.value.has(l.id)}]),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[...e[29]||(e[29]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"},null,-1)])],2))],8,fe)):$("",!0),l._hasChildren?(u(),m("svg",be,[...e[30]||(e[30]=[t("path",{d:"M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"},null,-1)])])):(u(),m("svg",ve,[...e[31]||(e[31]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},null,-1)])])),t("span",{class:k({"font-semibold":l._hasChildren})},b(p),3)],4)]),"cell-category":i(({value:l})=>[l?(u(),m("span",ce,b(N(l)),1)):(u(),m("span",ge,"—"))]),"cell-standard_price":i(({value:l})=>[F(b(H(l)),1)]),"cell-is_deleted":i(({value:l})=>[t("div",he,[t("span",{class:k(["inline-flex items-center justify-center w-6 h-6 rounded-full",l?"bg-red-100 text-red-600":"bg-green-100 text-green-600"]),title:l?"Удален":"Активен"},[l?(u(),m("svg",xe,[...e[32]||(e[32]=[t("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"},null,-1)])])):(u(),m("svg",ke,[...e[33]||(e[33]=[t("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])]))],10,ye)])]),actions:i(({row:l})=>[t("button",{onClick:C(p=>r(o).handleEdit(l),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Изменить ",8,we),t("button",{onClick:C(p=>r(o).handleDelete(l),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,Ce)]),_:1},8,["data","loading","pagination","onRowClick","onSearch","onSort"]),x(ie,{open:r(o).modalOpen.value,title:r(o).editingItem.value?"Редактирование работы":"Создание работы",size:"md",onClose:r(o).handleCloseModal},{footer:i(()=>[t("button",{onClick:e[13]||(e[13]=(...l)=>r(o).handleCloseModal&&r(o).handleCloseModal(...l)),type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),t("button",{onClick:e[14]||(e[14]=(...l)=>r(o).handleSubmit&&r(o).handleSubmit(...l)),type:"button",disabled:r(o).submitting.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50"},b(r(o).submitting.value?"Сохранение...":"Сохранить"),9,Se)]),default:i(()=>[t("form",{onSubmit:e[12]||(e[12]=C((...l)=>r(o).handleSubmit&&r(o).handleSubmit(...l),["prevent"])),class:"space-y-4"},[x(z,{modelValue:r(o).formData.value.name,"onUpdate:modelValue":e[9]||(e[9]=l=>r(o).formData.value.name=l),label:"Наименование",type:"text",required:"",error:r(o).errors.value.name},null,8,["modelValue","error"]),x(z,{modelValue:r(o).formData.value.unit,"onUpdate:modelValue":e[10]||(e[10]=l=>r(o).formData.value.unit=l),label:"Единица измерения",type:"text",error:r(o).errors.value.unit},null,8,["modelValue","error"]),x(ue,{modelValue:r(o).formData.value.parent_id,"onUpdate:modelValue":e[11]||(e[11]=l=>r(o).formData.value.parent_id=l),label:"Родительский элемент",items:r(o).parentItems.value,error:r(o).errors.value.parent_id},null,8,["modelValue","items","error"]),r(o).submitError.value?(u(),m("div",_e,[t("p",Ve,b(r(o).submitError.value),1)])):$("",!0)],32)]),_:1},8,["open","title","onClose"])])]),_:1}))}});export{Le as default};
