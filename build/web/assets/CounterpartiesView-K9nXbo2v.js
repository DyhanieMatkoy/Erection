import{d as j,f as c,g as M,h as I,c as q,w as s,o as p,a as n,b as v,u as g,i as _,n as z,t as b,j as x,e as R,k as T}from"./index-B1sRxO42.js";import{u as U,_ as F}from"./DataTable.vue_vue_type_script_setup_true_lang-DOc6hnFw.js";import{u as H,g as O,_ as A,a as G,c as J,d as K}from"./FormField.vue_vue_type_script_setup_true_lang-wE-3Fa0o.js";import{_ as L}from"./AppLayout.vue_vue_type_script_setup_true_lang-D5nXF41d.js";import{_ as Q}from"./Modal.vue_vue_type_script_setup_true_lang-DYjBthM_.js";import{_ as W}from"./Picker.vue_vue_type_script_setup_true_lang-zGKsYr2N.js";const X={class:"space-y-6"},Y={key:0,class:"text-gray-500"},Z={key:1,class:"text-gray-400"},ee=["onClick"],ae=["onClick"],te={key:0,class:"rounded-md bg-red-50 p-4"},ne={class:"text-sm text-red-800"},oe=["disabled"],me=j({__name:"CounterpartiesView",setup(le){const k=H(),o=U(),w=[{key:"id",label:"ID"},{key:"name",label:"Наименование"},{key:"parent_id",label:"Родитель"},{key:"is_deleted",label:"Статус"}],m=c(!1),r=c(null),l=c({name:"",parent_id:null}),i=c({}),u=c(""),f=c(!1),S=M(()=>o.data.value.filter(e=>!e.is_deleted&&e.id!==r.value?.id).map(e=>({id:e.id,name:e.name})));function V(e){return o.data.value.find(t=>t.id===e)?.name||""}async function d(){o.loading.value=!0;try{const e=await O(o.queryParams.value);o.data.value=e.data,o.pagination.value=e.pagination,await k.fetchCounterparties(!0)}catch(e){console.error("Failed to load counterparties:",e)}finally{o.loading.value=!1}}function $(e){o.setPage(e),d()}function E(e){o.setSearch(e),d()}function B(e,a){o.setSort(e,a),d()}function D(){r.value=null,l.value={name:"",parent_id:null},i.value={},u.value="",m.value=!0}function y(e){r.value=e,l.value={name:e.name,parent_id:e.parent_id},i.value={},u.value="",m.value=!0}async function h(){if(i.value={},!l.value.name.trim()){i.value.name="Обязательное поле";return}f.value=!0,u.value="";try{r.value?await G(r.value.id,l.value):await J(l.value),m.value=!1,await d()}catch(e){const a=e;u.value=a.response?.data?.detail||"Ошибка при сохранении"}finally{f.value=!1}}async function N(e){if(confirm(`Удалить контрагента "${e.name}"?`))try{await K(e.id),await d()}catch(a){alert(a.response?.data?.detail||"Ошибка при удалении")}}function C(){m.value=!1,r.value=null}return I(()=>{d()}),(e,a)=>(p(),q(L,null,{default:s(()=>[n("div",X,[a[3]||(a[3]=n("div",null,[n("h2",{class:"text-2xl font-bold text-gray-900"},"Контрагенты"),n("p",{class:"mt-1 text-sm text-gray-600"},"Управление справочником контрагентов")],-1)),v(F,{columns:w,data:g(o).data.value,loading:g(o).loading.value,pagination:g(o).pagination.value,onRowClick:y,onPageChange:$,onSearch:E,onSort:B},{"header-actions":s(()=>[n("button",{onClick:D,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},[...a[2]||(a[2]=[n("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),R(" Создать ",-1)])])]),"cell-parent_id":s(({row:t})=>[t.parent_id?(p(),x("span",Y,b(V(t.parent_id)),1)):(p(),x("span",Z,"—"))]),"cell-is_deleted":s(({value:t})=>[n("span",{class:z(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",t?"bg-red-100 text-red-800":"bg-green-100 text-green-800"])},b(t?"Удален":"Активен"),3)]),actions:s(({row:t})=>[n("button",{onClick:_(P=>y(t),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Изменить ",8,ee),n("button",{onClick:_(P=>N(t),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,ae)]),_:1},8,["data","loading","pagination"]),v(Q,{open:m.value,title:r.value?"Редактирование контрагента":"Создание контрагента",size:"md",onClose:C},{footer:s(()=>[n("button",{onClick:C,type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),n("button",{onClick:h,type:"button",disabled:f.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50"},b(f.value?"Сохранение...":"Сохранить"),9,oe)]),default:s(()=>[n("form",{onSubmit:_(h,["prevent"]),class:"space-y-4"},[v(A,{modelValue:l.value.name,"onUpdate:modelValue":a[0]||(a[0]=t=>l.value.name=t),label:"Наименование",type:"text",required:"",error:i.value.name},null,8,["modelValue","error"]),v(W,{modelValue:l.value.parent_id,"onUpdate:modelValue":a[1]||(a[1]=t=>l.value.parent_id=t),label:"Родительский элемент",items:S.value,error:i.value.parent_id},null,8,["modelValue","items","error"]),u.value?(p(),x("div",te,[n("p",ne,b(u.value),1)])):T("",!0)],32)]),_:1},8,["open","title"])])]),_:1}))}});export{me as default};
