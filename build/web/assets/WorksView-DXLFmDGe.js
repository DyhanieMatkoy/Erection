import{d as G,f as y,g as z,p as J,h as K,c as X,w as i,a as t,b as x,n as k,i as C,u as o,j as p,e as E,t as b,q as Y,k as F,l as v,v as _,s as $,o as d}from"./index-DUoOKtDv.js";import{u as Z}from"./useReferenceView-C-9YuCMZ.js";import{u as ee}from"./useFilters-CZ5mbCA9.js";import{u as te,k as D,l as le,m as ae,n as oe,o as re}from"./references-eDFEYnSt.js";import{_ as ne}from"./AppLayout.vue_vue_type_script_setup_true_lang-B3MB7avE.js";import{_ as se}from"./DataTable.vue_vue_type_script_setup_true_lang-DTxzDPkq.js";import{_ as ie}from"./Modal.vue_vue_type_script_setup_true_lang-pxS1gZgL.js";import{_ as B}from"./FormField.vue_vue_type_script_setup_true_lang-BL-nFudA.js";import{_ as ue}from"./Picker.vue_vue_type_script_setup_true_lang-BLaBmckP.js";const de={class:"space-y-6"},me={class:"flex items-center justify-between"},pe={class:"flex items-center gap-2 bg-white border border-gray-300 rounded-lg p-1"},fe=["onClick"],be={key:1,class:"w-4 h-4 mr-2 text-yellow-500",fill:"currentColor",viewBox:"0 0 20 20"},ve={key:2,class:"w-4 h-4 mr-2 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},ce={key:0,class:"text-sm text-gray-900"},ge={key:1,class:"text-gray-400"},he={class:"flex items-center justify-center"},ye=["title"],xe={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},ke={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},we=["onClick"],Ce=["onClick"],_e={key:0,class:"rounded-md bg-red-50 p-4"},Ve={class:"text-sm text-red-800"},Se=["disabled"],We=G({__name:"WorksView",setup(De){const M=te(),P=y(),w=y([]),m=y("hierarchy"),c=y(new Set),V=y(1e3),s=ee({category:null,unit:null,priceFrom:null,priceTo:null,isDeleted:null}),a=Z({getAll:D,create:re,update:oe,delete:ae},()=>M.fetchWorks(!0)),j=[{key:"code",label:"Код",width:"100px"},{key:"name",label:"Наименование",width:"400px"},{key:"unit",label:"Ед. изм.",width:"100px"},{key:"category",label:"Категория",width:"150px"},{key:"standard_price",label:"Норм. стоимость",width:"120px"},{key:"is_deleted",label:"",width:"40px",sortable:!1}];function U(r){w.value=r}async function W(){if(w.value.length!==0&&confirm(`Удалить выбранные виды работ (${w.value.length})?`))try{const r=w.value.map(l=>l.id),e=await le(r);e.errors.length>0?alert(`${e.message}

Ошибки:
${e.errors.join(`
`)}`):alert(e.message),P.value?.clearSelection(),await a.loadData()}catch(r){alert(r.response?.data?.detail||"Ошибка при групповом удалении")}}function q(){s.applyFilters(),a.table.setPage(1),a.loadData()}function L(){s.clearAllFilters(),a.table.setPage(1),a.loadData()}function R(r){return{construction:"Строительные работы",electrical:"Электромонтажные работы",plumbing:"Сантехнические работы",finishing:"Отделочные работы"}[r]||r}function N(r){return r==null?"—":new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(r)}function H(r){const e=new Map,l=[];r.forEach(n=>{e.set(n.id,{...n,_children:[],_level:0,_hasChildren:!1})}),r.forEach(n=>{const h=e.get(n.id);if(n.parent_id&&e.has(n.parent_id)){const f=e.get(n.parent_id);f._children.push(h),f._hasChildren=!0}else l.push(h)});function u(n,h){n.forEach(f=>{f._level=h,f._children&&f._children.length>0&&u(f._children,h+1)})}return u(l,0),l}function T(r){const e=[];function l(u){u.forEach(n=>{e.push(n),n._hasChildren&&c.value.has(n.id)&&n._children&&l(n._children)})}return l(r),e}function A(r){c.value.has(r)?c.value.delete(r):c.value.add(r)}const S=z(()=>{const r=a.table.data.value;if(m.value==="hierarchy"){const e=H(r);return T(e)}return r.map(e=>({...e,_level:0,_hasChildren:!1}))}),I=z(()=>m.value==="hierarchy"?{page:1,page_size:S.value.length,total_items:S.value.length,total_pages:1}:a.table.pagination.value);async function g(){a.table.loading.value=!0;try{if(m.value==="hierarchy"){const r=[];let e=1,l=!0;for(;l;){const u={page:e,page_size:100,search:a.table.queryParams.value.search,sort_by:a.table.queryParams.value.sort_by,sort_order:a.table.queryParams.value.sort_order,...s.getQueryParams()},n=await D(u);r.push(...n.data),l=!!(n.pagination&&e<n.pagination.total_pages),e++}a.table.data.value=r,a.table.pagination.value={page:1,page_size:r.length,total_items:r.length,total_pages:1}}else{const r={page:a.table.pagination.value?.page||1,page_size:V.value,search:a.table.queryParams.value.search,sort_by:a.table.queryParams.value.sort_by,sort_order:a.table.queryParams.value.sort_order,...s.getQueryParams()},e=await D(r);a.table.data.value=e.data,a.table.pagination.value=e.pagination}await M.fetchWorks(!0)}catch(r){console.error("Failed to load works:",r),alert(r.response?.data?.detail||"Ошибка при загрузке данных")}finally{a.table.loading.value=!1}}function Q(r){a.table.setPage(r),g()}function O(){a.table.setPage(1),g()}return J(m,()=>{g()}),K(()=>{g()}),(r,e)=>(d(),X(ne,null,{default:i(()=>[t("div",de,[t("div",me,[e[17]||(e[17]=t("div",null,[t("h2",{class:"text-2xl font-bold text-gray-900"},"Работы"),t("p",{class:"mt-1 text-sm text-gray-600"},"Управление справочником работ")],-1)),t("div",pe,[t("button",{onClick:e[0]||(e[0]=l=>m.value="flat"),class:k(["px-3 py-1.5 text-sm font-medium rounded-md transition-colors",m.value==="flat"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"]),title:"Плоский список"},[...e[15]||(e[15]=[t("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])],2),t("button",{onClick:e[1]||(e[1]=l=>m.value="hierarchy"),class:k(["px-3 py-1.5 text-sm font-medium rounded-md transition-colors",m.value==="hierarchy"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"]),title:"Иерархический список"},[...e[16]||(e[16]=[t("svg",{class:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})],-1)])],2)])]),x(se,{ref_key:"tableRef",ref:P,columns:j,data:S.value,loading:o(a).table.loading.value,pagination:I.value,selectable:!0,"has-filters":!0,onRowClick:o(a).handleEdit,onPageChange:Q,onSearch:o(a).handleSearch,onSort:o(a).handleSort,onSelectionChange:U,onRefresh:g,onApplyFilters:q,onClearFilters:L},{filters:i(()=>[t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Элементов на странице",-1)),v(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>V.value=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",onChange:O},[...e[18]||(e[18]=[t("option",{value:25},"25",-1),t("option",{value:50},"50",-1),t("option",{value:100},"100",-1),t("option",{value:500},"500",-1),t("option",{value:1e3},"1000",-1)])],544),[[_,V.value,void 0,{number:!0}]])]),t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Категория",-1)),v(t("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>o(s).filters.value.category=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[20]||(e[20]=[t("option",{value:null},"Все категории",-1),t("option",{value:"construction"},"Строительные работы",-1),t("option",{value:"electrical"},"Электромонтажные работы",-1),t("option",{value:"plumbing"},"Сантехнические работы",-1),t("option",{value:"finishing"},"Отделочные работы",-1)])],512),[[_,o(s).filters.value.category]])]),t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Единица измерения",-1)),v(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>o(s).filters.value.unit=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[22]||(e[22]=[t("option",{value:null},"Все единицы",-1),t("option",{value:"м²"},"м²",-1),t("option",{value:"м³"},"м³",-1),t("option",{value:"м"},"м",-1),t("option",{value:"шт"},"шт",-1),t("option",{value:"т"},"т",-1),t("option",{value:"кг"},"кг",-1)])],512),[[_,o(s).filters.value.unit]])]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Стоимость от",-1)),v(t("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>o(s).filters.value.priceFrom=l),type:"number",step:"0.01",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0.00"},null,512),[[$,o(s).filters.value.priceFrom,void 0,{number:!0}]])]),t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Стоимость до",-1)),v(t("input",{"onUpdate:modelValue":e[6]||(e[6]=l=>o(s).filters.value.priceTo=l),type:"number",step:"0.01",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0.00"},null,512),[[$,o(s).filters.value.priceTo,void 0,{number:!0}]])]),t("div",null,[e[27]||(e[27]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Удаленные",-1)),v(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>o(s).filters.value.isDeleted=l),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"},[...e[26]||(e[26]=[t("option",{value:null},"Все",-1),t("option",{value:!1},"Активные",-1),t("option",{value:!0},"Удаленные",-1)])],512),[[_,o(s).filters.value.isDeleted]])])]),"bulk-actions":i(({selected:l})=>[t("button",{onClick:W,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+b(l.length)+") ",1)]),"header-actions":i(()=>[t("button",{onClick:e[8]||(e[8]=(...l)=>o(a).handleCreate&&o(a).handleCreate(...l)),class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"},[...e[28]||(e[28]=[t("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),E(" Создать ",-1)])])]),"cell-name":i(({row:l,value:u})=>[t("div",{style:Y({paddingLeft:`${l._level*24}px`}),class:"flex items-center"},[l._hasChildren&&m.value==="hierarchy"?(d(),p("button",{key:0,onClick:C(n=>A(l.id),["stop"]),class:"mr-2 p-0.5 hover:bg-gray-100 rounded"},[(d(),p("svg",{class:k(["w-4 h-4 transition-transform",{"transform rotate-90":c.value.has(l.id)}]),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[...e[29]||(e[29]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"},null,-1)])],2))],8,fe)):F("",!0),l._hasChildren?(d(),p("svg",be,[...e[30]||(e[30]=[t("path",{d:"M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"},null,-1)])])):(d(),p("svg",ve,[...e[31]||(e[31]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},null,-1)])])),t("span",{class:k({"font-semibold":l._hasChildren})},b(u),3)],4)]),"cell-category":i(({value:l})=>[l?(d(),p("span",ce,b(R(l)),1)):(d(),p("span",ge,"—"))]),"cell-standard_price":i(({value:l})=>[E(b(N(l)),1)]),"cell-is_deleted":i(({value:l})=>[t("div",he,[t("span",{class:k(["inline-flex items-center justify-center w-6 h-6 rounded-full",l?"bg-red-100 text-red-600":"bg-green-100 text-green-600"]),title:l?"Удален":"Активен"},[l?(d(),p("svg",xe,[...e[32]||(e[32]=[t("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"},null,-1)])])):(d(),p("svg",ke,[...e[33]||(e[33]=[t("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])]))],10,ye)])]),actions:i(({row:l})=>[t("button",{onClick:C(u=>o(a).handleEdit(l),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Изменить ",8,we),t("button",{onClick:C(u=>o(a).handleDelete(l),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,Ce)]),_:1},8,["data","loading","pagination","onRowClick","onSearch","onSort"]),x(ie,{open:o(a).modalOpen.value,title:o(a).editingItem.value?"Редактирование работы":"Создание работы",size:"md",onClose:o(a).handleCloseModal},{footer:i(()=>[t("button",{onClick:e[13]||(e[13]=(...l)=>o(a).handleCloseModal&&o(a).handleCloseModal(...l)),type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),t("button",{onClick:e[14]||(e[14]=(...l)=>o(a).handleSubmit&&o(a).handleSubmit(...l)),type:"button",disabled:o(a).submitting.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50"},b(o(a).submitting.value?"Сохранение...":"Сохранить"),9,Se)]),default:i(()=>[t("form",{onSubmit:e[12]||(e[12]=C((...l)=>o(a).handleSubmit&&o(a).handleSubmit(...l),["prevent"])),class:"space-y-4"},[x(B,{modelValue:o(a).formData.value.name,"onUpdate:modelValue":e[9]||(e[9]=l=>o(a).formData.value.name=l),label:"Наименование",type:"text",required:"",error:o(a).errors.value.name},null,8,["modelValue","error"]),x(B,{modelValue:o(a).formData.value.unit,"onUpdate:modelValue":e[10]||(e[10]=l=>o(a).formData.value.unit=l),label:"Единица измерения",type:"text",error:o(a).errors.value.unit},null,8,["modelValue","error"]),x(ue,{modelValue:o(a).formData.value.parent_id,"onUpdate:modelValue":e[11]||(e[11]=l=>o(a).formData.value.parent_id=l),label:"Родительский элемент",items:o(a).parentItems.value,error:o(a).errors.value.parent_id},null,8,["modelValue","items","error"]),o(a).submitError.value?(d(),p("div",_e,[t("p",Ve,b(o(a).submitError.value),1)])):F("",!0)],32)]),_:1},8,["open","title","onClose"])])]),_:1}))}});export{We as default};
