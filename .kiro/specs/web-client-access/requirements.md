# Requirements Document

## Introduction

Данный документ описывает требования к веб-клиенту для системы управления рабочим временем строительных бригад. Веб-клиент предоставит альтернативный способ доступа к существующей функциональности через браузер, сохраняя при этом совместимость с текущей SQLite базой данных и бизнес-логикой.

## Glossary

- **WebClient** - веб-приложение, работающее в браузере пользователя
- **APIServer** - серверное приложение, предоставляющее REST API для доступа к данным
- **DesktopClient** - существующее PyQt6 приложение
- **DatabaseManager** - компонент управления базой данных SQLite
- **AuthenticationService** - сервис аутентификации пользователей
- **SessionManager** - компонент управления пользовательскими сессиями
- **RESTEndpoint** - точка доступа REST API
- **WebUI** - пользовательский интерфейс веб-клиента
- **ResponsiveLayout** - адаптивная верстка для разных устройств

## Requirements

### Requirement 1: Аутентификация пользователей

**User Story:** Как пользователь системы, я хочу войти в веб-клиент используя свои учетные данные, чтобы получить доступ к функциональности системы через браузер

#### Acceptance Criteria

1. WHEN пользователь открывает WebClient, THE WebClient SHALL отобразить форму входа с полями username и password
2. WHEN пользователь вводит корректные учетные данные и нажимает кнопку входа, THE AuthenticationService SHALL проверить данные в таблице users и создать сессию
3. IF пользователь вводит некорректные учетные данные, THEN THE AuthenticationService SHALL вернуть сообщение об ошибке без создания сессии
4. WHEN пользователь успешно аутентифицирован, THE SessionManager SHALL создать токен сессии со сроком действия 8 часов
5. WHEN срок действия токена истекает, THE WebClient SHALL перенаправить пользователя на форму входа

### Requirement 2: REST API для доступа к данным

**User Story:** Как разработчик веб-клиента, я хочу иметь REST API для доступа к данным системы, чтобы реализовать функциональность в браузере

#### Acceptance Criteria

1. THE APIServer SHALL предоставить RESTEndpoint для всех справочников (counterparties, objects, works, persons, organizations)
2. THE APIServer SHALL предоставить RESTEndpoint для документов (estimates, daily_reports) с поддержкой CRUD операций
3. WHEN клиент отправляет запрос без валидного токена, THE APIServer SHALL вернуть HTTP статус 401 Unauthorized
4. WHEN клиент запрашивает данные с валидным токеном, THE APIServer SHALL вернуть данные в формате JSON
5. THE APIServer SHALL использовать существующие repositories и services для доступа к данным

### Requirement 3: Управление справочниками

**User Story:** Как пользователь системы, я хочу просматривать и редактировать справочники через веб-интерфейс, чтобы работать с данными без установки десктопного приложения

#### Acceptance Criteria

1. WHEN пользователь открывает раздел справочников, THE WebUI SHALL отобразить список доступных справочников (Контрагенты, Объекты, Работы, Физлица, Организации)
2. WHEN пользователь выбирает справочник, THE WebUI SHALL отобразить таблицу с данными справочника с поддержкой поиска и фильтрации
3. WHEN пользователь нажимает кнопку создания элемента, THE WebUI SHALL отобразить форму создания с валидацией полей
4. WHEN пользователь сохраняет изменения, THE WebClient SHALL отправить данные через APIServer и обновить отображение
5. WHERE справочник поддерживает иерархию, THE WebUI SHALL отобразить древовидную структуру с возможностью сворачивания узлов

### Requirement 4: Работа со сметами

**User Story:** Как руководитель проекта, я хочу создавать и редактировать сметы через веб-интерфейс, чтобы работать с документами из любого места

#### Acceptance Criteria

1. WHEN пользователь открывает список смет, THE WebUI SHALL отобразить таблицу с номером, датой, заказчиком и суммой каждой сметы
2. WHEN пользователь создает новую смету, THE WebUI SHALL отобразить форму с полями header (номер, дата, заказчик, объект, подрядчик, ответственный)
3. WHEN пользователь добавляет строки в смету, THE WebUI SHALL предоставить возможность выбора работ из справочника с автозаполнением цены и трудоемкости
4. WHEN пользователь изменяет количество в строке сметы, THE WebClient SHALL автоматически пересчитать сумму и плановую трудоемкость
5. WHERE смета содержит группы работ, THE WebUI SHALL отобразить иерархическую структуру с возможностью сворачивания групп

### Requirement 5: Работа с ежедневными отчетами

**User Story:** Как бригадир, я хочу создавать ежедневные отчеты о выполненных работах через веб-интерфейс, чтобы вести учет с мобильного устройства на объекте

#### Acceptance Criteria

1. WHEN пользователь создает ежедневный отчет, THE WebUI SHALL предоставить выбор даты, сметы и бригадира
2. WHEN пользователь выбирает смету, THE WebClient SHALL автоматически заполнить строки отчета на основе строк выбранной сметы
3. WHEN пользователь вводит фактическую трудоемкость, THE WebClient SHALL автоматически рассчитать процент отклонения от плана
4. WHEN пользователь добавляет исполнителей к строке отчета, THE WebUI SHALL предоставить множественный выбор из справочника физлиц
5. WHEN пользователь сохраняет отчет, THE APIServer SHALL сохранить данные в таблицы daily_reports и daily_report_lines

### Requirement 6: Проведение документов

**User Story:** Как пользователь с правами администратора, я хочу проводить документы через веб-интерфейс, чтобы формировать движения в регистрах накопления

#### Acceptance Criteria

1. WHEN пользователь нажимает кнопку "Провести" для сметы, THE APIServer SHALL вызвать DocumentPostingService для создания записей в work_execution_register
2. WHEN документ успешно проведен, THE WebUI SHALL обновить статус документа и отобразить дату проведения
3. IF документ уже проведен, THEN THE WebUI SHALL отобразить кнопку "Отменить проведение"
4. WHEN пользователь отменяет проведение, THE APIServer SHALL удалить соответствующие записи из регистра
5. WHERE у пользователя нет прав на проведение, THE WebUI SHALL скрыть кнопки проведения

### Requirement 7: Печатные формы

**User Story:** Как пользователь системы, я хочу формировать печатные формы документов через веб-интерфейс, чтобы получать PDF файлы для печати

#### Acceptance Criteria

1. WHEN пользователь нажимает кнопку "Печать" в форме сметы, THE APIServer SHALL сгенерировать PDF файл используя существующий PrintFormService
2. WHEN PDF файл сгенерирован, THE WebClient SHALL предложить пользователю скачать или открыть файл в новой вкладке
3. THE APIServer SHALL поддерживать генерацию печатных форм в форматах АРСД и Excel
4. WHEN пользователь выбирает формат печати, THE WebUI SHALL отобразить диалог выбора с опциями АРСД и Excel
5. THE APIServer SHALL использовать шрифты с поддержкой кириллицы для корректного отображения русского текста

### Requirement 8: Адаптивный интерфейс

**User Story:** Как пользователь мобильного устройства, я хочу использовать веб-клиент на смартфоне или планшете, чтобы работать с системой на объекте строительства

#### Acceptance Criteria

1. THE WebUI SHALL использовать ResponsiveLayout для адаптации под экраны шириной от 320px до 2560px
2. WHEN пользователь открывает WebClient на устройстве с шириной экрана менее 768px, THE WebUI SHALL отобразить мобильную версию навигации с выдвижным меню
3. WHEN пользователь работает с таблицами на мобильном устройстве, THE WebUI SHALL отобразить данные в карточном виде вместо таблицы
4. THE WebUI SHALL поддерживать сенсорное управление для мобильных устройств (свайпы, тапы)
5. WHEN пользователь вводит данные в формы на мобильном устройстве, THE WebUI SHALL использовать соответствующие типы клавиатур (numeric для чисел, date для дат)

### Requirement 9: Регистры и отчеты

**User Story:** Как руководитель, я хочу просматривать регистры накопления и аналитические отчеты через веб-интерфейс, чтобы анализировать выполнение работ

#### Acceptance Criteria

1. WHEN пользователь открывает регистр выполнения работ, THE WebUI SHALL отобразить таблицу с движениями по объектам, сметам и работам
2. WHEN пользователь задает период отбора, THE WebClient SHALL отфильтровать данные регистра по указанному диапазону дат
3. THE WebUI SHALL предоставить возможность группировки данных по измерениям (объект, смета, работа)
4. WHEN пользователь запрашивает отчет, THE APIServer SHALL выполнить агрегацию данных и вернуть результат в формате JSON
5. THE WebUI SHALL отображать итоговые суммы по количеству и стоимости выполненных работ

### Requirement 10: Совместимость с десктопным клиентом

**User Story:** Как администратор системы, я хочу чтобы веб-клиент и десктопный клиент работали с одной базой данных, чтобы пользователи могли выбирать удобный способ доступа

#### Acceptance Criteria

1. THE APIServer SHALL использовать существующий DatabaseManager для доступа к SQLite базе данных
2. THE APIServer SHALL использовать существующие repositories и services без изменения их логики
3. WHEN пользователь изменяет данные через WebClient, THE DesktopClient SHALL видеть изменения после обновления данных
4. WHEN пользователь изменяет данные через DesktopClient, THE WebClient SHALL видеть изменения после обновления страницы
5. THE APIServer SHALL поддерживать одновременную работу нескольких пользователей с использованием транзакций SQLite

### Requirement 11: Безопасность

**User Story:** Как администратор безопасности, я хочу чтобы веб-клиент обеспечивал защиту данных, чтобы предотвратить несанкционированный доступ

#### Acceptance Criteria

1. THE APIServer SHALL использовать HTTPS протокол для шифрования трафика между клиентом и сервером
2. THE AuthenticationService SHALL хранить пароли в виде хешей с использованием bcrypt или аналогичного алгоритма
3. THE APIServer SHALL валидировать все входящие данные для предотвращения SQL injection и XSS атак
4. WHEN пользователь выполняет операцию, THE APIServer SHALL проверить права доступа на основе роли пользователя
5. THE SessionManager SHALL автоматически завершать неактивные сессии через 30 минут бездействия

### Requirement 12: Производительность

**User Story:** Как пользователь системы, я хочу чтобы веб-клиент работал быстро, чтобы эффективно выполнять свои задачи

#### Acceptance Criteria

1. WHEN пользователь открывает список документов, THE WebClient SHALL отобразить первую страницу данных в течение 2 секунд
2. THE APIServer SHALL использовать пагинацию для списков с возвращением максимум 50 записей за запрос
3. THE WebClient SHALL кэшировать справочные данные в браузере для уменьшения количества запросов к серверу
4. WHEN пользователь вводит текст в поле поиска, THE WebClient SHALL использовать debounce с задержкой 300ms перед отправкой запроса
5. THE APIServer SHALL использовать индексы базы данных для оптимизации запросов с фильтрацией и сортировкой
