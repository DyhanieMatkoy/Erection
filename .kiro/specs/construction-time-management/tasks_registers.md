# Задачи: Регистр накопления и проведение документов

## Задача 1: Создание регистра накопления ВыполнениеРабот

### Описание
Создать таблицу регистра накопления для хранения движений по выполнению работ.

### Критерии выполнения
- [x] Создана таблица `work_execution_register` с полями:
  - `id` - первичный ключ
  - `recorder_type` - тип документа-регистратора (estimate/daily_report)
  - `recorder_id` - ID документа-регистратора
  - `line_number` - номер строки движения
  - `period` - дата движения
  - `object_id` - ID объекта (измерение)
  - `estimate_id` - ID сметы (измерение)
  - `work_id` - ID работы (измерение)
  - `quantity_income` - приход количества
  - `quantity_expense` - расход количества
  - `sum_income` - приход суммы
  - `sum_expense` - расход суммы
  - `created_at` - дата создания записи
- [x] Создан индекс по полям (recorder_type, recorder_id) для быстрого удаления движений
- [x] Создан индекс по измерениям (period, object_id, estimate_id, work_id)

### Файлы
- `src/data/database_manager.py` - добавить создание таблицы

---

## Задача 2: Добавление поля "Проведен" в документы

### Описание
Добавить поле проведения в документы Смета и Ежедневный_Отчет.

### Критерии выполнения
- [x] Добавлено поле `is_posted` (INTEGER DEFAULT 0) в таблицу `estimates`
- [x] Добавлено поле `is_posted` (INTEGER DEFAULT 0) в таблицу `daily_reports`
- [x] Добавлено поле `posted_at` (TIMESTAMP) в обе таблицы для хранения времени проведения

### Файлы
- `src/data/database_manager.py` - добавить поля в таблицы

---

## Задача 3: Создание сервиса проведения документов

### Описание
Создать сервис для проведения и отмены проведения документов.

### Критерии выполнения
- [x] Создан класс `DocumentPostingService` с методами:
  - `post_estimate(estimate_id)` - проведение сметы
  - `unpost_estimate(estimate_id)` - отмена проведения сметы
  - `post_daily_report(report_id)` - проведение отчета
  - `unpost_daily_report(report_id)` - отмена проведения отчета
- [x] Метод проведения сметы создает движения с приходом (+)
- [x] Метод проведения отчета создает движения с расходом (-)
- [x] Метод отмены проведения удаляет все движения документа
- [x] Добавлена валидация: нельзя провести документ без обязательных полей
- [x] Добавлена валидация: нельзя провести отчет по уже полностью выполненной смете

### Файлы
- `src/services/document_posting_service.py` - новый файл

---

## Задача 4: Добавление кнопок проведения в формы документов

### Описание
Добавить кнопки "Провести" и "Отменить проведение" в формы документов.

### Критерии выполнения
- [x] В `EstimateDocumentForm` добавлена кнопка "Провести (Ctrl+K)"
- [x] В `EstimateDocumentForm` добавлена кнопка "Отменить проведение"
- [x] В `DailyReportDocumentForm` добавлены аналогичные кнопки
- [x] Кнопки активны/неактивны в зависимости от состояния документа
- [x] При проведении документ сохраняется автоматически
- [x] Проведенный документ нельзя редактировать (поля заблокированы)
- [x] Для редактирования проведенного документа нужно отменить проведение
- [x] Статус проведения отображается в заголовке формы и в формах списка документов зеленым флажком в первой колонке
- [x] В формах списка документов в контекстном меню можно провести и распровести выделенные документы

### Файлы
- `src/views/estimate_document_form.py`
- `src/views/daily_report_document_form.py`

---

## Задача 5: Создание репозитория регистра

### Описание
Создать репозиторий для работы с регистром накопления.

### Критерии выполнения
- [x] Создан класс `WorkExecutionRegisterRepository` с методами:
  - `get_balance(filters, grouping)` - получение остатков с группировкой
  - `get_turnovers(period_start, period_end, filters, grouping)` - получение оборотов
  - `get_movements(recorder_type, recorder_id)` - получение движений документа
  - `delete_movements(recorder_type, recorder_id)` - удаление движений документа
- [x] Метод `get_balance` возвращает остатки по измерениям
- [x] Метод `get_turnovers` возвращает обороты за период
- [x] Поддержка группировки по: object, estimate, work, period
- [x] Поддержка фильтрации по всем измерениям

### Файлы
- `src/data/repositories/work_execution_register_repository.py` - новый файл

---

## Задача 6: Создание отчета по выполнению работ

### Описание
Создать форму отчета с анализом выполнения работ по сметам.

### Критерии выполнения
- [x] Создана форма `WorkExecutionReportForm` с параметрами:
  - Период (дата начала, дата окончания)
  - Объект (выбор из справочника, необязательно)
  - Смета (выбор из справочника, необязательно)
  - Работа (выбор из справочника, необязательно)
  - Группировка (выбор: по объектам, по сметам, по работам, по датам)
- [x] Отчет показывает колонки:
  - Группировка (название)
  - План количество
  - Факт количество
  - Остаток количество
  - План сумма
  - Факт сумма
  - Остаток сумма
  - Процент выполнения
- [x] Двойной клик по строке показывает детализацию
- [x] Детализация показывает список документов-регистраторов
- [x] Из детализации можно перейти к документу
- [x] Кнопка "Обновить" для пересчета отчета
- [ ] Кнопка "Экспорт в Excel" (отложено)

### Файлы
- `src/views/work_execution_report_form.py` - новый файл
- `src/services/work_execution_report_service.py` - новый файл

---

## Задача 7: Добавление отчета в меню

### Описание
Добавить пункт меню для открытия отчета по выполнению работ.

### Критерии выполнения
- [x] В главном окне добавлен пункт меню "Отчеты" → "Выполнение работ"
- [x] При выборе пункта меню открывается форма отчета
- [x] Отчет открывается в MDI area главного окна

### Файлы
- `src/views/main_window.py`

---

## Задача 8: Обновление списков документов

### Описание
Добавить отображение статуса проведения в списках документов.

### Критерии выполнения
- [x] В `EstimateListForm` добавлена колонка "Проведен" (✓/✗)
- [x] В `DailyReportListForm` добавлена колонка "Проведен" (✓/✗)
- [x] Проведенные документы выделяются жирным шрифтом
- [x] Добавлена возможность фильтрации по статусу проведения

### Файлы
- `src/views/estimate_list_form.py`
- `src/views/daily_report_list_form.py`

---

## Задача 9: Тестирование проведения документов

### Описание
Создать тестовые данные и проверить работу проведения.

### Критерии выполнения
- [x] Создана тестовая смета с несколькими работами
- [x] Смета проведена, проверены движения в регистре
- [x] Создан тестовый отчет по смете
- [x] Отчет проведен, проверены движения в регистре
- [x] Проверен расчет остатков в отчете
- [x] Проверена отмена проведения
- [x] Проверено редактирование после отмены проведения

### Файлы
- `test_posting.py` - новый тестовый скрипт

---

## Порядок выполнения

1. Задача 1 - создание таблицы регистра
2. Задача 2 - добавление полей проведения
3. Задача 5 - создание репозитория регистра
4. Задача 3 - создание сервиса проведения
5. Задача 4 - добавление кнопок в формы
6. Задача 6 - создание отчета
7. Задача 7 - добавление в меню
8. Задача 8 - обновление списков
9. Задача 9 - тестирование
