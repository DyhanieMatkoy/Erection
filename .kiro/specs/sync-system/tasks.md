# План реализации (TODO)

## Phase 1: Подготовка Базы Данных (Database Migration)
Эти задачи критичны и должны быть выполнены первыми.

- [ ] **Добавить UUID и Audit поля:** Создать миграцию (Alembic) для добавления колонок `uuid` (UUID, unique), `updated_at` (Datetime), `is_deleted` (Bool) во все таблицы:
    - [ ] `daily_reports`
    - [ ] `daily_report_lines`
    - [ ] `estimates`
    - [ ] `estimate_lines`
    - [ ] `timesheets`
    - [ ] `work_specifications`
    - [ ] `users` (если синхронизируются)
- [ ] **Заполнить UUID:** Написать скрипт миграции данных, который сгенерирует UUID для существующих записей.
- [ ] **Создать таблицы синхронизации:**
    - [ ] `sync_nodes` (Справочник узлов)
    - [ ] `sync_changes` (Очередь изменений)

## Phase 2: Ядро синхронизации (Core Logic)
Реализация на уровне Python (Shared code для Web и Desktop).

- [ ] **Модель `SyncManager`:** Класс, управляющий логикой регистрации изменений.
- [ ] **Event Listeners (SQLAlchemy):**
    - [ ] `after_insert`: Добавлять запись в `sync_changes`.
    - [ ] `after_update`: Добавлять запись в `sync_changes`.
    - [ ] `after_delete`: Помечать `is_deleted=True` и добавлять запись в `sync_changes` (вместо реального удаления).
- [ ] **Сериализатор:** Реализовать универсальный `JsonSerializer`, который умеет превращать SQLAlchemy модели в dict и обратно, учитывая вложенные списки (например, строки сметы).

## Phase 3: Серверная часть (Web API)
Реализация API эндпоинтов на FastAPI.

- [ ] **Endpoint `/api/sync/register`:** Регистрация нового десктоп-клиента, выдача ему `node_id`.
- [ ] **Endpoint `/api/sync/exchange`:** Основной метод POST.
    - [ ] Логика проверки токена.
    - [ ] Логика обработки входящего пакета (Apply changes).
    - [ ] Логика генерации исходящего пакета (Collect changes).
    - [ ] Обработка квитанций (Purge queue).

## Phase 4: Клиентская часть (Desktop)
Интеграция в PyQt приложение.

- [ ] **Настройки:** UI для ввода адреса сервера и токена.
- [ ] **Фоновый поток:** `SyncWorker` (QThread), который периодически вызывает API.
- [ ] **Индикатор статуса:** Иконка в статус-баре (Онлайн/Офлайн/Синхронизация).
- [ ] **Обработка конфликтов:** Если сервер вернул ошибку конфликта, показать диалог пользователю (опционально для первой версии, по умолчанию Server Wins).

## Phase 5: Тестирование и Отладка

- [ ] **Unit Tests:** Тесты сериализации/десериализации.
- [ ] **Integration Tests:** Эмуляция обмена между двумя базами (в памяти).
- [ ] **Load Tests:** Проверка работы с большими пакетами (1000+ записей).
