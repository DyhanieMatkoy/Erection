# Требования к системе синхронизации данных (Sync Specs)

## 1. Общие положения
Система предназначена для обеспечения автономной работы Desktop-клиентов (офлайн-режим) с последующей двусторонней синхронизацией данных с центральным Web-сервером (PostgreSQL).

### 1.1. Основные цели
*   **Offline-First:** Пользователь может создавать и редактировать документы без подключения к интернету.
*   **Целостность данных:** Гарантированная доставка изменений (At-least-once delivery).
*   **Конфликтность:** Автоматическое или полуавтоматическое разрешение конфликтов при одновременном изменении одних и тех же данных.
*   **Универсальность:** Механизм обмена должен быть агностичен к конкретной бизнес-сущности, позволяя легко добавлять новые типы документов в обмен.

## 2. Сущности обмена
Синхронизации подлежат следующие ключевые объекты и их табличные части:

### 2.1. Документы (Транзакционные данные)
1.  **Смета (Estimate)**
    *   Шапка документа (Заказчик, Объект, Даты).
    *   Позиции сметы (Работы, Объемы, Стоимости).
2.  **Ежедневный отчет (DailyReport)**
    *   Привязка к дате и бригаде.
    *   Выполненные работы (факт).
    *   Использованные материалы.
3.  **Табель (Timesheet)**
    *   Учет рабочего времени сотрудников.
    *   Привязка к объекту и периоду.

### 2.2. Справочники и Вспомогательные данные
1.  **Спецификация работ (WorkSpecification)**
    *   Критически важная сущность. Должна синхронизироваться как иерархическая структура.
    *   Включает коды, наименования, единицы измерения.
2.  **Связанные справочники:**
    *   Объекты строительства.
    *   Контрагенты.
    *   Сотрудники.
    *   Материалы.

## 3. Функциональные требования

### 3.1. Идентификация объектов
*   Все синхронизируемые объекты должны иметь глобальный уникальный идентификатор (**UUID**).
*   Локальные ID (Integer Auto Increment) могут использоваться для внутренних связей внутри одной БД, но при обмене используются только UUID.

### 3.2. Механизм "Плана обмена" (Exchange Plan)
*   **Узлы (Nodes):** Система должна различать "Центральный узел" (Сервер) и "Периферийные узлы" (Desktop-клиенты).
*   **Регистрация изменений:** Любое изменение (INSERT, UPDATE, DELETE) отслеживаемой сущности должно регистрироваться в таблице изменений для всех активных узлов-получателей.
*   **Пакетная передача:** Изменения передаются пакетами (сообщениями).
*   **Квитирование (Ack):** Пакет считается доставленным только после получения подтверждения (квитанции) от получателя. До этого момента изменения хранятся в очереди.

### 3.3. Разрешение конфликтов
*   Стратегия по умолчанию: **Server Wins** (Сервер побеждает) или **Last Write Wins** (Последняя запись побеждает, на основе UTC Timestamp).
*   Приоритет отдается данным, уже зафиксированным в центральной базе.

### 3.4. Версионирование схемы данных
*   Протокол обмена должен включать версию схемы данных.
*   Если десктоп-клиент имеет устаревшую версию структуры БД, синхронизация должна блокироваться с требованием обновления ПО.

## 4. Нефункциональные требования
*   **Производительность:** Синхронизация 1000 записей не должна занимать более 30 секунд при стабильном соединении.
*   **Трафик:** Использование сжатия (GZIP) для пакетов данных.
*   **Безопасность:** Аутентификация узла по токену/сертификату. Передача данных только по HTTPS.
