import{d as Y,f as _,g as w,m as G,j as n,a as e,k as u,e as N,F as V,p as j,t as v,i as K,q as M,v as P,o as r,n as A,s as Q,x as X,h as Z,c as H,w as ee,l as te,b as F,u as R}from"./index-C7yHV0zj.js";import{u as se,_ as q}from"./FormField.vue_vue_type_script_setup_true_lang-CIydnAX3.js";import{u as ae,_ as oe}from"./PrintDialog.vue_vue_type_script_setup_true_lang-BgAo2d9G.js";import{getEstimates as re,getTimesheet as le,autofillTimesheet as ne,createTimesheet as ie,updateTimesheet as de,postTimesheet as ue,unpostTimesheet as ce}from"./documents-aFSYETPL.js";import{_ as me}from"./AppLayout.vue_vue_type_script_setup_true_lang-BRkCAdoF.js";import{_ as z}from"./Picker.vue_vue_type_script_setup_true_lang-D8mt08tv.js";import"./Modal.vue_vue_type_script_setup_true_lang-DA1ZvjIg.js";const pe={class:"bg-white shadow rounded-lg p-6 space-y-4"},ve={class:"flex items-center justify-between"},ye={class:"border border-gray-200 rounded-lg overflow-hidden"},be={class:"flex"},fe={class:"flex-shrink-0 border-r border-gray-200"},he={class:"divide-y divide-gray-200"},ge={class:"bg-white divide-y divide-gray-200"},xe={key:0},_e={class:"px-3 py-2 whitespace-nowrap text-sm text-gray-900"},we={class:"px-3 py-2 whitespace-nowrap"},ke=["onUpdate:modelValue","disabled","onInput"],$e={key:1,class:"bg-gray-100 font-bold"},Ve={class:"flex-1 overflow-x-auto"},je={class:"divide-y divide-gray-200"},Ce={class:"bg-gray-50"},De={class:"bg-white divide-y divide-gray-200"},Ee={key:0},Ue=["colspan"],Se=["onUpdate:modelValue","disabled","onInput"],Te={key:1,class:"bg-gray-100 font-bold"},Fe={class:"flex-shrink-0 border-l border-gray-200"},Ne={class:"divide-y divide-gray-200"},Le={class:"bg-gray-50"},Oe={key:0,class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24"},Be={class:"bg-white divide-y divide-gray-200"},Ie={key:0},Me=["colspan"],Pe={class:"px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 bg-blue-50"},He={class:"px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 bg-blue-50"},Ae={key:0,class:"px-3 py-2 whitespace-nowrap text-sm"},Re=["onClick"],qe={key:1,class:"bg-gray-100 font-bold"},ze={class:"px-3 py-2 text-sm bg-blue-100"},Ye={class:"px-3 py-2 text-sm bg-blue-100"},Je={key:0},We={class:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col"},Ge={class:"px-6 py-4 overflow-y-auto flex-1"},Ke={class:"mb-4"},Qe={class:"space-y-2"},Xe=["onClick"],Ze={class:"font-medium text-gray-900"},et={key:0,class:"text-sm text-gray-500"},tt={class:"px-6 py-4 border-t border-gray-200 flex justify-end"},st=Y({__name:"TimesheetLines",props:{modelValue:{},persons:{},monthYear:{},disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(x,{emit:E}){const h=x,C=E,d=_([]),k=_(!1),y=_(""),g=w(()=>{if(!h.monthYear)return 31;const i=h.monthYear.split("-").map(Number),s=i[0],a=i[1];return!s||!a?31:new Date(s,a,0).getDate()}),t=w(()=>{const i=y.value.toLowerCase();return h.persons.filter(s=>!s.is_deleted&&(s.full_name.toLowerCase().includes(i)||s.position&&s.position.toLowerCase().includes(i)))}),b=w(()=>d.value.reduce((i,s)=>i+s.total_hours,0)),D=w(()=>d.value.reduce((i,s)=>i+s.total_amount,0));function m(i){return h.persons.find(a=>a.id===i)?.full_name||"Неизвестно"}function U(i){if(!h.monthYear)return!1;const s=h.monthYear.split("-").map(Number),a=s[0],c=s[1];if(!a||!c)return!1;const $=new Date(a,c-1,i).getDay();return $===0||$===6}function L(i){return d.value.reduce((s,a)=>{const c=a.days[i]||0;return s+(typeof c=="number"?c:0)},0)}function T(i){const s=d.value[i];s&&(s.total_hours=Object.values(s.days).reduce((a,c)=>a+(typeof c=="number"?c:0),0),s.total_amount=s.total_hours*s.hourly_rate,S())}function O(){y.value="",k.value=!0}function B(i){if(d.value.some(a=>a.employee_id===i.id)){alert("Этот сотрудник уже добавлен");return}const s={line_number:d.value.length+1,employee_id:i.id,employee_name:i.full_name,hourly_rate:0,days:{},total_hours:0,total_amount:0};for(let a=1;a<=g.value;a++)s.days[a]=0;d.value.push(s),k.value=!1,S()}function I(i){confirm("Удалить строку?")&&(d.value.splice(i,1),d.value.forEach((s,a)=>{s.line_number=a+1}),S())}function S(){C("update:modelValue",d.value)}return G(()=>h.modelValue,i=>{d.value=JSON.parse(JSON.stringify(i))},{immediate:!0,deep:!0}),(i,s)=>(r(),n("div",pe,[e("div",ve,[s[4]||(s[4]=e("h3",{class:"text-lg font-medium text-gray-900"},"Табличная часть",-1)),x.disabled?u("",!0):(r(),n("button",{key:0,onClick:O,class:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...s[3]||(s[3]=[e("svg",{class:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),N(" Добавить сотрудника ",-1)])]))]),e("div",ye,[e("div",be,[e("div",fe,[e("table",he,[s[7]||(s[7]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48"}," Сотрудник "),e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28"}," Ставка ")])],-1)),e("tbody",ge,[d.value.length===0?(r(),n("tr",xe,[...s[5]||(s[5]=[e("td",{colspan:"2",class:"px-3 py-4 text-center text-sm text-gray-500"}," Нет данных ",-1)])])):u("",!0),(r(!0),n(V,null,j(d.value,(a,c)=>(r(),n("tr",{key:c,class:"hover:bg-gray-50"},[e("td",_e,v(m(a.employee_id)),1),e("td",we,[M(e("input",{"onUpdate:modelValue":f=>a.hourly_rate=f,type:"number",min:"0",step:"0.01",disabled:x.disabled,class:"w-24 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm disabled:bg-gray-100",onInput:f=>T(c)},null,40,ke),[[P,a.hourly_rate,void 0,{number:!0}]])])]))),128)),d.value.length>0?(r(),n("tr",$e,[...s[6]||(s[6]=[e("td",{class:"px-3 py-2 text-sm text-gray-900"},"Итого:",-1),e("td",{class:"px-3 py-2"},null,-1)])])):u("",!0)])])]),e("div",Ve,[e("table",je,[e("thead",Ce,[e("tr",null,[(r(!0),n(V,null,j(g.value,a=>(r(),n("th",{key:a,class:A(["px-2 py-3 text-center text-xs font-medium uppercase tracking-wider w-20",U(a)?"bg-red-50 text-red-700":"text-gray-500"])},v(a),3))),128))])]),e("tbody",De,[d.value.length===0?(r(),n("tr",Ee,[e("td",{colspan:g.value,class:"px-3 py-4 text-center text-sm text-gray-500"}," Добавьте сотрудников ",8,Ue)])):u("",!0),(r(!0),n(V,null,j(d.value,(a,c)=>(r(),n("tr",{key:c,class:"hover:bg-gray-50"},[(r(!0),n(V,null,j(g.value,f=>(r(),n("td",{key:f,class:"px-2 py-2"},[M(e("input",{"onUpdate:modelValue":$=>a.days[f]=$,type:"number",min:"0",max:"24",step:"0.5",disabled:x.disabled,class:A(["w-16 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm disabled:bg-gray-100 text-center",U(f)?"bg-red-50":""]),onInput:$=>T(c)},null,42,Se),[[P,a.days[f],void 0,{number:!0}]])]))),128))]))),128)),d.value.length>0?(r(),n("tr",Te,[(r(!0),n(V,null,j(g.value,a=>(r(),n("td",{key:a,class:"px-2 py-2 text-center text-sm"},v(L(a).toFixed(2)),1))),128))])):u("",!0)])])]),e("div",Fe,[e("table",Ne,[e("thead",Le,[e("tr",null,[s[8]||(s[8]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 w-24"}," Итого ",-1)),s[9]||(s[9]=e("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 w-28"}," Сумма ",-1)),x.disabled?u("",!0):(r(),n("th",Oe," Действия "))])]),e("tbody",Be,[d.value.length===0?(r(),n("tr",Ie,[e("td",{colspan:x.disabled?2:3,class:"px-3 py-4 text-center text-sm text-gray-500"}," - ",8,Me)])):u("",!0),(r(!0),n(V,null,j(d.value,(a,c)=>(r(),n("tr",{key:c,class:"hover:bg-gray-50"},[e("td",Pe,v(a.total_hours.toFixed(2)),1),e("td",He,v(a.total_amount.toFixed(2)),1),x.disabled?u("",!0):(r(),n("td",Ae,[e("button",{onClick:f=>I(c),class:"text-red-600 hover:text-red-900"}," Удалить ",8,Re)]))]))),128)),d.value.length>0?(r(),n("tr",qe,[e("td",ze,v(b.value.toFixed(2)),1),e("td",Ye,v(D.value.toFixed(2)),1),x.disabled?u("",!0):(r(),n("td",Je))])):u("",!0)])])])])]),k.value?(r(),n("div",{key:0,class:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50",onClick:s[2]||(s[2]=K(a=>k.value=!1,["self"]))},[e("div",We,[s[10]||(s[10]=e("div",{class:"px-6 py-4 border-b border-gray-200"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Выбор сотрудника")],-1)),e("div",Ge,[e("div",Ke,[M(e("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>y.value=a),type:"text",placeholder:"Поиск...",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"},null,512),[[P,y.value]])]),e("div",Qe,[(r(!0),n(V,null,j(t.value,a=>(r(),n("button",{key:a.id,onClick:c=>B(a),class:"w-full text-left px-4 py-3 border border-gray-200 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"},[e("div",Ze,v(a.full_name),1),a.position?(r(),n("div",et,v(a.position),1)):u("",!0)],8,Xe))),128))])]),e("div",tt,[e("button",{onClick:s[1]||(s[1]=a=>k.value=!1),class:"px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Отмена ")])])])):u("",!0)]))}}),at={class:"space-y-6"},ot={class:"flex items-center justify-between"},rt={class:"text-2xl font-bold text-gray-900"},lt={class:"mt-1 text-sm text-gray-600"},nt={class:"flex items-center space-x-2"},it={key:0,class:"px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"},dt={class:"bg-white shadow rounded-lg p-6 space-y-6"},ut={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},ct={class:"text-sm text-gray-600"},mt={class:"flex justify-between items-center"},pt=["disabled"],vt={class:"flex items-center space-x-3"},yt={key:0,class:"text-sm text-red-600"},bt=["disabled"],ft=["disabled"],ht=["disabled"],Ct=Y({__name:"TimesheetFormView",setup(x){const E=te(),h=X(),C=se(),{isAdmin:d}=Q(),{printTimesheet:k}=ae(),y=w(()=>h.params.id==="new"),g=_(!1),t=_({number:"",date:new Date().toISOString().split("T")[0],object_id:0,estimate_id:0,foreman_id:0,month_year:new Date().toISOString().slice(0,7),is_posted:!1,posted_at:null,marked_for_deletion:!1,lines:[]}),b=_({}),D=_(""),m=_(!1),U=_([]),L=w(()=>C.objects.filter(o=>!o.is_deleted).map(o=>({id:o.id,name:o.name}))),T=w(()=>{let o=U.value;return t.value.object_id&&(o=o.filter(l=>l.object_id===t.value.object_id)),o.map(l=>({id:l.id,name:`${l.number} от ${B(l.date)}`}))}),O=w(()=>C.persons.filter(o=>!o.is_deleted));function B(o){return new Date(o).toLocaleDateString("ru-RU")}function I(o){if(!o)return"";const[l,p]=o.split("-");return new Date(parseInt(l),parseInt(p)-1).toLocaleDateString("ru-RU",{year:"numeric",month:"long"})}function S(){t.value.date&&(t.value.month_year=t.value.date.slice(0,7))}function i(){t.value.estimate_id=0}async function s(){if(!t.value.object_id||!t.value.estimate_id){alert("Выберите объект и смету");return}if(!(t.value.lines&&t.value.lines.length>0&&!confirm("Табличная часть содержит данные. Заменить их?"))){m.value=!0;try{const o=await ne(t.value.object_id,t.value.estimate_id,t.value.month_year);t.value.lines=o.lines}catch(o){alert(o.response?.data?.detail||"Ошибка при автозаполнении")}finally{m.value=!1}}}async function a(){if(y.value){t.value.number=`ТБ-${Date.now()}`;return}try{const o=await le(Number(h.params.id));t.value=o}catch(o){console.error("Failed to load timesheet:",o),alert("Ошибка загрузки табеля"),E.push("/documents/timesheets")}}async function c(){if(b.value={},t.value.number||(b.value.number="Обязательное поле"),t.value.date||(b.value.date="Обязательное поле"),t.value.object_id||(b.value.object_id="Обязательное поле"),t.value.estimate_id||(b.value.estimate_id="Обязательное поле"),!(Object.keys(b.value).length>0)){m.value=!0,D.value="";try{if(y.value){const o=await ie(t.value);E.push(`/documents/timesheets/${o.id}`)}else await de(t.value.id,t.value),await a()}catch(o){const l=o;D.value=l.response?.data?.detail||"Ошибка при сохранении"}finally{m.value=!1}}}async function f(){if(confirm("Провести табель?")){m.value=!0;try{await ue(t.value.id),await a()}catch(o){alert(o.response?.data?.detail||"Ошибка при проведении")}finally{m.value=!1}}}async function $(){if(confirm("Отменить проведение табеля?")){m.value=!0;try{await ce(t.value.id),await a()}catch(o){alert(o.response?.data?.detail||"Ошибка при отмене проведения")}finally{m.value=!1}}}function J(){E.push("/documents/timesheets")}async function W(o,l){try{await k(t.value.id,o,l,`Табель_${t.value.number}`),g.value=!1}catch(p){console.error("Print failed:",p)}}return Z(async()=>{await C.fetchObjects(),await C.fetchPersons();try{const o=await re({page_size:1e3});U.value=o.data}catch(o){console.error("Failed to load estimates:",o)}await a()}),(o,l)=>(r(),H(me,null,{default:ee(()=>[e("div",at,[e("div",ot,[e("div",null,[e("h2",rt,v(y.value?"Новый табель":`Табель ${t.value.number}`),1),e("p",lt,v(y.value?"Создание нового табеля":"Редактирование табеля"),1)]),e("div",nt,[t.value.is_posted?(r(),n("span",it," Проведен ")):u("",!0),e("button",{onClick:J,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Назад ")])]),e("div",dt,[e("div",ut,[F(q,{modelValue:t.value.number,"onUpdate:modelValue":l[0]||(l[0]=p=>t.value.number=p),label:"Номер",required:"",disabled:t.value.is_posted,error:b.value.number},null,8,["modelValue","disabled","error"]),F(q,{modelValue:t.value.date,"onUpdate:modelValue":[l[1]||(l[1]=p=>t.value.date=p),S],label:"Дата",type:"date",required:"",disabled:t.value.is_posted,error:b.value.date},null,8,["modelValue","disabled","error"]),F(z,{modelValue:t.value.object_id,"onUpdate:modelValue":[l[2]||(l[2]=p=>t.value.object_id=p),i],label:"Объект",items:L.value,required:"",disabled:t.value.is_posted,error:b.value.object_id},null,8,["modelValue","items","disabled","error"]),F(z,{modelValue:t.value.estimate_id,"onUpdate:modelValue":l[3]||(l[3]=p=>t.value.estimate_id=p),label:"Смета",items:T.value,required:"",disabled:t.value.is_posted,error:b.value.estimate_id},null,8,["modelValue","items","disabled","error"])]),e("div",ct,[l[7]||(l[7]=e("strong",null,"Период:",-1)),N(" "+v(I(t.value.month_year)),1)])]),t.value.lines?(r(),H(st,{key:0,modelValue:t.value.lines,"onUpdate:modelValue":l[4]||(l[4]=p=>t.value.lines=p),persons:O.value,"month-year":t.value.month_year,disabled:t.value.is_posted},null,8,["modelValue","persons","month-year","disabled"])):u("",!0),e("div",mt,[e("div",null,[!y.value&&!t.value.is_posted&&t.value.object_id&&t.value.estimate_id?(r(),n("button",{key:0,onClick:s,disabled:m.value,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"},[...l[8]||(l[8]=[e("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),N(" Заполнить из ежедневных отчетов ",-1)])],8,pt)):u("",!0)]),e("div",vt,[D.value?(r(),n("div",yt,v(D.value),1)):u("",!0),y.value?u("",!0):(r(),n("button",{key:1,onClick:l[5]||(l[5]=p=>g.value=!0),class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...l[9]||(l[9]=[e("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1),N(" Печать ",-1)])])),!y.value&&R(d)&&!t.value.is_posted?(r(),n("button",{key:2,onClick:f,disabled:m.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50"}," Провести ",8,bt)):u("",!0),!y.value&&R(d)&&t.value.is_posted?(r(),n("button",{key:3,onClick:$,disabled:m.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"}," Отменить проведение ",8,ft)):u("",!0),t.value.is_posted?u("",!0):(r(),n("button",{key:4,onClick:c,disabled:m.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"},v(m.value?"Сохранение...":"Сохранить"),9,ht))])])]),t.value.id?(r(),H(oe,{key:0,open:g.value,"document-type":"timesheet","document-id":t.value.id,"document-name":`Табель_${t.value.number}`,onClose:l[6]||(l[6]=p=>g.value=!1),onPrint:W},null,8,["open","document-id","document-name"])):u("",!0)]),_:1}))}});export{Ct as default};
