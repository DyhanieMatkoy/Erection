import{d as B,f as g,g as w,m as O,j as r,o as l,a as t,k as b,b as k,n as V,t as c,w as L,q as U,i as I,v as R,F as K,p as j,T as Q,c as E,s as G,x as J,h as W,l as X,e as Y,u as z}from"./index-C7yHV0zj.js";import{u as Z,_ as ee}from"./FormField.vue_vue_type_script_setup_true_lang-CIydnAX3.js";import{u as te,_ as ae}from"./PrintDialog.vue_vue_type_script_setup_true_lang-BgAo2d9G.js";import{getEstimates as se,getDailyReport as le,getEstimate as oe,createDailyReport as re,updateDailyReport as ne,postDailyReport as de,unpostDailyReport as ie}from"./documents-aFSYETPL.js";import{_ as ue}from"./AppLayout.vue_vue_type_script_setup_true_lang-BRkCAdoF.js";import{_ as N}from"./Picker.vue_vue_type_script_setup_true_lang-D8mt08tv.js";import"./Modal.vue_vue_type_script_setup_true_lang-DA1ZvjIg.js";const ce={class:"relative"},me=["disabled"],pe={key:0,class:"block truncate"},ye={key:1,class:"block truncate text-gray-400"},ve={key:0,class:"mt-1 text-sm text-red-600"},xe={key:0,class:"absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"},fe={class:"sticky top-0 bg-white px-2 py-2 border-b border-gray-200"},be={key:0},ge=["onClick"],_e={class:"flex items-center"},he=["checked","onClick"],ke={key:1,class:"py-2 px-3 text-sm text-gray-500"},S=B({__name:"MultiPicker",props:{modelValue:{default:()=>[]},items:{},valueKey:{default:"id"},displayKey:{default:"name"},placeholder:{default:"Выберите..."},disabled:{type:Boolean},error:{}},emits:["update:modelValue"],setup(i,{emit:_}){const p=i,h=_,m=g(!1),y=g(""),x=w(()=>p.items.filter(d=>p.modelValue?.includes(d[p.valueKey]))),v=w(()=>{if(!y.value)return p.items;const d=y.value.toLowerCase();return p.items.filter(a=>{const u=a[p.displayKey];return typeof u=="string"&&u.toLowerCase().includes(d)})});function e(d){return p.modelValue?.includes(d)||!1}function s(d){const a=d[p.valueKey],u=p.modelValue||[];e(a)?h("update:modelValue",u.filter($=>$!==a)):h("update:modelValue",[...u,a])}return O(m,d=>{d||(y.value="")}),(d,a)=>(l(),r("div",ce,[t("button",{type:"button",disabled:i.disabled,class:V(["relative w-full cursor-pointer rounded-md border bg-white py-2 pl-3 pr-10 text-left shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 sm:text-sm",i.error?"border-red-300":"border-gray-300",i.disabled?"bg-gray-100 cursor-not-allowed":""]),onClick:a[0]||(a[0]=u=>m.value=!m.value)},[x.value.length>0?(l(),r("span",pe,c(x.value.map(u=>u[i.displayKey]).join(", ")),1)):(l(),r("span",ye,c(i.placeholder),1)),a[4]||(a[4]=t("span",{class:"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2"},[t("svg",{class:"h-5 w-5 text-gray-400",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z","clip-rule":"evenodd"})])],-1))],10,me),i.error?(l(),r("p",ve,c(i.error),1)):b("",!0),k(Q,{"leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:L(()=>[m.value?(l(),r("div",xe,[t("div",fe,[U(t("input",{"onUpdate:modelValue":a[1]||(a[1]=u=>y.value=u),type:"text",placeholder:"Поиск...",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm",onClick:a[2]||(a[2]=I(()=>{},["stop"]))},null,512),[[R,y.value]])]),v.value.length>0?(l(),r("div",be,[(l(!0),r(K,null,j(v.value,u=>(l(),r("div",{key:u[i.valueKey],class:V(["relative cursor-pointer select-none py-2 pl-3 pr-9 hover:bg-gray-100",e(u[i.valueKey])?"bg-blue-50 text-blue-900":"text-gray-900"]),onClick:$=>s(u)},[t("div",_e,[t("input",{type:"checkbox",checked:e(u[i.valueKey]),class:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3",onClick:I($=>s(u),["stop"])},null,8,he),t("span",{class:V(["block truncate",e(u[i.valueKey])?"font-semibold":"font-normal"])},c(u[i.displayKey]),3)])],10,ge))),128))])):(l(),r("div",ke,"Ничего не найдено"))])):b("",!0)]),_:1}),m.value?(l(),r("div",{key:1,class:"fixed inset-0 z-0",onClick:a[3]||(a[3]=u=>m.value=!1)})):b("",!0)]))}}),we={class:"bg-white shadow rounded-lg p-6 space-y-4"},$e={class:"hidden md:block overflow-x-auto"},Ve={class:"min-w-full divide-y divide-gray-200"},Ce={class:"bg-white divide-y divide-gray-200"},De={class:"px-3 py-2 text-sm text-gray-900"},Ue={class:"px-3 py-2 text-sm text-gray-900"},Re={class:"px-3 py-2 text-sm text-gray-900"},Ke={class:"px-3 py-2"},je=["onUpdate:modelValue","onInput"],Ee={key:1,class:"text-sm text-gray-900"},Be={class:"px-3 py-2"},Fe={key:1,class:"text-sm text-gray-900"},Ie={key:0},ze={class:"md:hidden space-y-4"},Ne={class:"flex items-center justify-between"},Se={class:"text-sm font-medium text-gray-500"},Le={class:"space-y-2"},Pe={class:"text-sm text-gray-900"},Me={class:"grid grid-cols-2 gap-2"},qe={class:"text-sm text-gray-900"},Te=["onUpdate:modelValue","onInput"],Ae={key:1,class:"text-sm text-gray-900"},He={key:1,class:"text-sm text-gray-900"},Oe={key:0,class:"text-center py-8 text-sm text-gray-500"},Qe=B({__name:"DailyReportLines",props:{modelValue:{},persons:{},disabled:{type:Boolean}},emits:["update:modelValue"],setup(i,{emit:_}){const p=i,h=_,m=w({get:()=>p.modelValue||[],set:v=>h("update:modelValue",v)});function y(v){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v)}function x(v){const e=m.value[v];e.deviation=e.actual_labor-e.planned_labor}return(v,e)=>(l(),r("div",we,[e[7]||(e[7]=t("h3",{class:"text-lg font-medium text-gray-900"},"Строки отчета",-1)),t("div",$e,[t("table",Ve,[e[1]||(e[1]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12"},"#"),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Работа"),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," План. труд. "),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Факт. труд. "),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32"}," Отклонение "),t("th",{class:"px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase"}," Исполнители ")])],-1)),t("tbody",Ce,[(l(!0),r(K,null,j(m.value,(s,d)=>(l(),r("tr",{key:d},[t("td",De,c(d+1),1),t("td",Ue,c(s.work_name),1),t("td",Re,c(y(s.planned_labor)),1),t("td",Ke,[i.disabled?(l(),r("span",Ee,c(y(s.actual_labor)),1)):U((l(),r("input",{key:0,"onUpdate:modelValue":a=>s.actual_labor=a,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:a=>x(d)},null,40,je)),[[R,s.actual_labor,void 0,{number:!0}]])]),t("td",{class:V(["px-3 py-2 text-sm font-medium",s.deviation>=0?"text-green-600":"text-red-600"])},c(y(s.deviation)),3),t("td",Be,[i.disabled?(l(),r("span",Fe,c(s.executor_names?.join(", ")||"—"),1)):(l(),E(S,{key:0,modelValue:s.executors,"onUpdate:modelValue":a=>s.executors=a,items:i.persons,"display-key":"full_name",placeholder:"Выберите исполнителей"},null,8,["modelValue","onUpdate:modelValue","items"]))])]))),128)),m.value.length===0?(l(),r("tr",Ie,[...e[0]||(e[0]=[t("td",{colspan:"6",class:"px-3 py-8 text-center text-sm text-gray-500"}," Нет строк. Выберите смету для автозаполнения. ",-1)])])):b("",!0)])])]),t("div",ze,[(l(!0),r(K,null,j(m.value,(s,d)=>(l(),r("div",{key:d,class:"border border-gray-200 rounded-lg p-4 space-y-3"},[t("div",Ne,[t("span",Se,"Строка "+c(d+1),1)]),t("div",Le,[t("div",null,[e[2]||(e[2]=t("label",{class:"block text-xs font-medium text-gray-500"},"Работа",-1)),t("span",Pe,c(s.work_name),1)]),t("div",Me,[t("div",null,[e[3]||(e[3]=t("label",{class:"block text-xs font-medium text-gray-500"},"План. труд.",-1)),t("span",qe,c(y(s.planned_labor)),1)]),t("div",null,[e[4]||(e[4]=t("label",{class:"block text-xs font-medium text-gray-500"},"Факт. труд.",-1)),i.disabled?(l(),r("span",Ae,c(y(s.actual_labor)),1)):U((l(),r("input",{key:0,"onUpdate:modelValue":a=>s.actual_labor=a,type:"number",step:"0.01",class:"w-full px-2 py-1 text-sm border border-gray-300 rounded",onInput:a=>x(d)},null,40,Te)),[[R,s.actual_labor,void 0,{number:!0}]])])]),t("div",null,[e[5]||(e[5]=t("label",{class:"block text-xs font-medium text-gray-500"},"Отклонение",-1)),t("span",{class:V(["text-sm font-medium",s.deviation>=0?"text-green-600":"text-red-600"])},c(y(s.deviation)),3)]),t("div",null,[e[6]||(e[6]=t("label",{class:"block text-xs font-medium text-gray-500"},"Исполнители",-1)),i.disabled?(l(),r("span",He,c(s.executor_names?.join(", ")||"—"),1)):(l(),E(S,{key:0,modelValue:s.executors,"onUpdate:modelValue":a=>s.executors=a,items:i.persons,"display-key":"full_name",placeholder:"Выберите исполнителей"},null,8,["modelValue","onUpdate:modelValue","items"]))])])]))),128)),m.value.length===0?(l(),r("div",Oe," Нет строк. Выберите смету для автозаполнения. ")):b("",!0)])]))}}),Ge={class:"space-y-6"},Je={class:"flex items-center justify-between"},We={class:"text-2xl font-bold text-gray-900"},Xe={class:"mt-1 text-sm text-gray-600"},Ye={class:"flex items-center space-x-2"},Ze={key:0,class:"px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"},et={class:"bg-white shadow rounded-lg p-6 space-y-6"},tt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},at={class:"flex justify-between items-center"},st={key:0,class:"text-sm text-red-600"},lt={class:"flex space-x-3 ml-auto"},ot=["disabled"],rt=["disabled"],nt=["disabled"],vt=B({__name:"DailyReportFormView",setup(i){const _=X(),p=J(),h=Z(),{isAdmin:m}=G(),{printDailyReport:y}=te(),x=w(()=>p.params.id==="new"),v=g(!1),e=g({date:new Date().toISOString().split("T")[0],estimate_id:0,foreman_id:0,is_posted:!1,posted_at:null,is_deleted:!1,lines:[]}),s=g({}),d=g(""),a=g(!1),u=g([]),$=w(()=>u.value.map(o=>({id:o.id,name:`${o.number} от ${C(o.date)} (${o.object_name})`}))),F=w(()=>h.persons.filter(o=>!o.is_deleted));function C(o){return new Date(o).toLocaleDateString("ru-RU")}async function P(){if(e.value.estimate_id)try{const o=await oe(e.value.estimate_id);e.value.lines=(o.lines||[]).filter(n=>!n.is_group).map(n=>({estimate_line_id:n.id,work_id:n.work_id,work_name:n.work_name,planned_labor:n.labor,actual_labor:0,deviation:-n.labor,executors:[]}))}catch(o){console.error("Failed to load estimate:",o)}}async function D(){if(!x.value)try{const o=await le(Number(p.params.id));e.value=o}catch(o){console.error("Failed to load daily report:",o),alert("Ошибка загрузки отчета"),_.push("/documents/daily-reports")}}async function M(){if(s.value={},e.value.date||(s.value.date="Обязательное поле"),e.value.estimate_id||(s.value.estimate_id="Обязательное поле"),e.value.foreman_id||(s.value.foreman_id="Обязательное поле"),!(Object.keys(s.value).length>0)){a.value=!0,d.value="";try{if(x.value){const o=await re(e.value);_.push(`/documents/daily-reports/${o.id}`)}else await ne(e.value.id,e.value),await D()}catch(o){const n=o;d.value=n.response?.data?.detail||"Ошибка при сохранении"}finally{a.value=!1}}}async function q(){if(confirm("Провести отчет?")){a.value=!0;try{await de(e.value.id),await D()}catch(o){alert(o.response?.data?.detail||"Ошибка при проведении")}finally{a.value=!1}}}async function T(){if(confirm("Отменить проведение отчета?")){a.value=!0;try{await ie(e.value.id),await D()}catch(o){alert(o.response?.data?.detail||"Ошибка при отмене проведения")}finally{a.value=!1}}}function A(){_.push("/documents/daily-reports")}async function H(o,n){try{await y(e.value.id,o,n,`Отчет_${C(e.value.date)}`),v.value=!1}catch(f){console.error("Print failed:",f)}}return W(async()=>{await h.fetchPersons();try{const o=await se({page_size:1e3});u.value=o.data}catch(o){console.error("Failed to load estimates:",o)}await D()}),(o,n)=>(l(),E(ue,null,{default:L(()=>[t("div",Ge,[t("div",Je,[t("div",null,[t("h2",We,c(x.value?"Новый ежедневный отчет":`Отчет от ${C(e.value.date)}`),1),t("p",Xe,c(x.value?"Создание нового отчета":"Редактирование отчета"),1)]),t("div",Ye,[e.value.is_posted?(l(),r("span",Ze," Проведен ")):b("",!0),t("button",{onClick:A,class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"}," Назад ")])]),t("div",et,[t("div",tt,[k(ee,{modelValue:e.value.date,"onUpdate:modelValue":n[0]||(n[0]=f=>e.value.date=f),label:"Дата",type:"date",required:"",disabled:e.value.is_posted,error:s.value.date},null,8,["modelValue","disabled","error"]),k(N,{modelValue:e.value.estimate_id,"onUpdate:modelValue":[n[1]||(n[1]=f=>e.value.estimate_id=f),P],label:"Смета",items:$.value,required:"",disabled:e.value.is_posted,error:s.value.estimate_id},null,8,["modelValue","items","disabled","error"]),k(N,{modelValue:e.value.foreman_id,"onUpdate:modelValue":n[2]||(n[2]=f=>e.value.foreman_id=f),label:"Бригадир",items:F.value,"display-key":"full_name",required:"",disabled:e.value.is_posted,error:s.value.foreman_id},null,8,["modelValue","items","disabled","error"])])]),k(Qe,{modelValue:e.value.lines,"onUpdate:modelValue":n[3]||(n[3]=f=>e.value.lines=f),persons:F.value,disabled:e.value.is_posted},null,8,["modelValue","persons","disabled"]),t("div",at,[d.value?(l(),r("div",st,c(d.value),1)):b("",!0),t("div",lt,[x.value?b("",!0):(l(),r("button",{key:0,onClick:n[4]||(n[4]=f=>v.value=!0),class:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"},[...n[6]||(n[6]=[t("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1),Y(" Печать ",-1)])])),!x.value&&z(m)&&!e.value.is_posted?(l(),r("button",{key:1,onClick:q,disabled:a.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50"}," Провести ",8,ot)):b("",!0),!x.value&&z(m)&&e.value.is_posted?(l(),r("button",{key:2,onClick:T,disabled:a.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"}," Отменить проведение ",8,rt)):b("",!0),e.value.is_posted?b("",!0):(l(),r("button",{key:3,onClick:M,disabled:a.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"},c(a.value?"Сохранение...":"Сохранить"),9,nt))])])]),k(ae,{open:v.value,"document-type":"daily-report","document-id":e.value.id,"document-name":`Отчет_${C(e.value.date)}`,onClose:n[5]||(n[5]=f=>v.value=!1),onPrint:H},null,8,["open","document-id","document-name"])]),_:1}))}});export{vt as default};
