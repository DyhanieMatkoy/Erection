import{d as z,f as r,g as T,h as U,c as F,w as s,o as f,a as n,b,u as h,i as x,n as H,t as p,j as _,e as O,k as S}from"./index-6EFolkGo.js";import{u as A,_ as G}from"./DataTable.vue_vue_type_script_setup_true_lang-BaWuvIHH.js";import{u as J,g as K,_ as L,a as Q,c as W,d as X,b as Y}from"./FormField.vue_vue_type_script_setup_true_lang-BDJ46V17.js";import{_ as Z}from"./AppLayout.vue_vue_type_script_setup_true_lang-fByiLTOw.js";import{_ as ee}from"./Modal.vue_vue_type_script_setup_true_lang-DDauu2p3.js";import{_ as te}from"./Picker.vue_vue_type_script_setup_true_lang-T-Ajx66M.js";const ae={class:"space-y-6"},ne={key:0,class:"flex gap-2"},oe={key:0,class:"text-gray-500"},le={key:1,class:"text-gray-400"},re=["onClick"],se=["onClick"],ie={key:0,class:"rounded-md bg-red-50 p-4"},ue={class:"text-sm text-red-800"},de=["disabled"],_e=z({__name:"CounterpartiesView",setup(ce){const V=J(),o=A(),y=r(),v=r([]),$=[{key:"id",label:"ID"},{key:"name",label:"Наименование"},{key:"parent_id",label:"Родитель"},{key:"is_deleted",label:"Статус"}],m=r(!1),i=r(null),l=r({name:"",parent_id:null}),d=r({}),c=r(""),g=r(!1),E=T(()=>o.data.value.filter(e=>!e.is_deleted&&e.id!==i.value?.id).map(e=>({id:e.id,name:e.name})));function D(e){return o.data.value.find(a=>a.id===e)?.name||""}async function u(){o.loading.value=!0;try{const e=await K(o.queryParams.value);o.data.value=e.data,o.pagination.value=e.pagination,await V.fetchCounterparties(!0)}catch(e){console.error("Failed to load counterparties:",e)}finally{o.loading.value=!1}}function B(e){o.setPage(e),u()}function j(e){o.setSearch(e),u()}function N(e,t){o.setSort(e,t),u()}function P(){i.value=null,l.value={name:"",parent_id:null},d.value={},c.value="",m.value=!0}function k(e){i.value=e,l.value={name:e.name,parent_id:e.parent_id},d.value={},c.value="",m.value=!0}async function C(){if(d.value={},!l.value.name.trim()){d.value.name="Обязательное поле";return}g.value=!0,c.value="";try{i.value?await Q(i.value.id,l.value):await W(l.value),m.value=!1,await u()}catch(e){const t=e;c.value=t.response?.data?.detail||"Ошибка при сохранении"}finally{g.value=!1}}async function I(e){if(confirm(`Удалить контрагента "${e.name}"?`))try{await X(e.id),await u()}catch(t){alert(t.response?.data?.detail||"Ошибка при удалении")}}function M(e){v.value=e}async function R(){if(v.value.length!==0&&confirm(`Удалить выбранные контрагенты (${v.value.length})?`))try{const e=v.value.map(a=>a.id),t=await Y(e);t.errors.length>0?alert(`${t.message}

Ошибки:
${t.errors.join(`
`)}`):alert(t.message),y.value?.clearSelection(),await u()}catch(e){alert(e.response?.data?.detail||"Ошибка при групповом удалении")}}function w(){m.value=!1,i.value=null}return U(()=>{u()}),(e,t)=>(f(),F(Z,null,{default:s(()=>[n("div",ae,[t[3]||(t[3]=n("div",null,[n("h2",{class:"text-2xl font-bold text-gray-900"},"Контрагенты"),n("p",{class:"mt-1 text-sm text-gray-600"},"Управление справочником контрагентов")],-1)),b(G,{ref_key:"tableRef",ref:y,columns:$,data:h(o).data.value,loading:h(o).loading.value,pagination:h(o).pagination.value,selectable:!0,onRowClick:k,onPageChange:B,onSearch:j,onSort:N,onSelectionChange:M},{"bulk-actions":s(({selected:a})=>[a.length>0?(f(),_("div",ne,[n("button",{onClick:R,class:"inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"}," Удалить ("+p(a.length)+") ",1)])):S("",!0)]),"header-actions":s(()=>[n("button",{onClick:P,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},[...t[2]||(t[2]=[n("svg",{class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),O(" Создать ",-1)])])]),"cell-parent_id":s(({row:a})=>[a.parent_id?(f(),_("span",oe,p(D(a.parent_id)),1)):(f(),_("span",le,"—"))]),"cell-is_deleted":s(({value:a})=>[n("span",{class:H(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",a?"bg-red-100 text-red-800":"bg-green-100 text-green-800"])},p(a?"Удален":"Активен"),3)]),actions:s(({row:a})=>[n("button",{onClick:x(q=>k(a),["stop"]),class:"text-blue-600 hover:text-blue-900 mr-4"}," Изменить ",8,re),n("button",{onClick:x(q=>I(a),["stop"]),class:"text-red-600 hover:text-red-900"}," Удалить ",8,se)]),_:1},8,["data","loading","pagination"]),b(ee,{open:m.value,title:i.value?"Редактирование контрагента":"Создание контрагента",size:"md",onClose:w},{footer:s(()=>[n("button",{onClick:w,type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"}," Отмена "),n("button",{onClick:C,type:"button",disabled:g.value,class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50"},p(g.value?"Сохранение...":"Сохранить"),9,de)]),default:s(()=>[n("form",{onSubmit:x(C,["prevent"]),class:"space-y-4"},[b(L,{modelValue:l.value.name,"onUpdate:modelValue":t[0]||(t[0]=a=>l.value.name=a),label:"Наименование",type:"text",required:"",error:d.value.name},null,8,["modelValue","error"]),b(te,{modelValue:l.value.parent_id,"onUpdate:modelValue":t[1]||(t[1]=a=>l.value.parent_id=a),label:"Родительский элемент",items:E.value,error:d.value.parent_id},null,8,["modelValue","items","error"]),c.value?(f(),_("div",ie,[n("p",ue,p(c.value),1)])):S("",!0)],32)]),_:1},8,["open","title"])])]),_:1}))}});export{_e as default};
