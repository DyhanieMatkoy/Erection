# Реализация проверки прав доступа

## Обзор

Реализована комплексная система проверки прав доступа для различных ролей пользователей в системе управления рабочим временем строительных бригад.

## Реализованные компоненты

### 1. Расширенный AuthService

Файл: `src/services/auth_service.py`

#### Основной метод проверки прав

```python
has_permission(action: str, resource: str = None, resource_id: int = None) -> bool
```

**Параметры:**
- `action`: Действие (view, create, edit, delete, post, manage_references, manage_system)
- `resource`: Тип ресурса (estimate, daily_report, reference, analytics, settings)
- `resource_id`: ID ресурса для проверки владения (опционально)

#### Вспомогательные методы

**Для смет:**
- `can_create_estimate()` - проверка права создания смет
- `can_edit_estimate(estimate_id)` - проверка права редактирования конкретной сметы
- `can_delete_estimate(estimate_id)` - проверка права удаления конкретной сметы
- `can_post_estimate(estimate_id)` - проверка права проведения конкретной сметы

**Для ежедневных отчетов:**
- `can_create_daily_report()` - проверка права создания отчетов
- `can_edit_daily_report(report_id)` - проверка права редактирования конкретного отчета
- `can_delete_daily_report(report_id)` - проверка права удаления конкретного отчета
- `can_post_daily_report(report_id)` - проверка права проведения конкретного отчета

**Общие:**
- `can_manage_references()` - проверка права управления справочниками
- `can_view_analytics()` - проверка права просмотра аналитики
- `can_manage_settings()` - проверка права управления настройками системы

#### Внутренние методы проверки владения

- `_can_access_estimate(estimate_id)` - проверка доступа к конкретной смете
- `_can_access_daily_report(report_id)` - проверка доступа к конкретному отчету

## Матрица прав доступа

### Администратор
- ✅ Полный доступ ко всем функциям
- ✅ Управление справочниками
- ✅ Управление настройками системы
- ✅ Просмотр, создание, редактирование, удаление, проведение всех документов
- ✅ Просмотр аналитики по всем данным

### Руководитель
- ✅ Просмотр, создание, редактирование, удаление, проведение всех документов
- ✅ Управление справочниками
- ✅ Просмотр аналитики по всем данным
- ❌ Управление системными настройками

### Бригадир
- ✅ Просмотр всех смет
- ✅ Создание смет
- ✅ Редактирование, удаление, проведение только своих смет (где он ответственный)
- ✅ Просмотр всех ежедневных отчетов
- ✅ Создание ежедневных отчетов
- ✅ Редактирование, удаление, проведение только своих отчетов (где он бригадир)
- ✅ Просмотр аналитики по своим данным
- ❌ Управление справочниками
- ❌ Управление настройками

### Сотрудник
- ✅ Просмотр смет (только чтение)
- ✅ Просмотр ежедневных отчетов (где он исполнитель)
- ✅ Просмотр аналитики по своим данным
- ❌ Создание, редактирование, удаление документов
- ❌ Управление справочниками
- ❌ Управление настройками

## Интеграция в формы

### EstimateListForm (src/views/estimate_list_form.py)

**Изменения:**
1. Добавлена инициализация `auth_service`
2. Кнопка "Создать" доступна только при наличии прав создания
3. Кнопка "Импорт из Excel" доступна только при наличии прав создания
4. Проверка прав перед созданием новой сметы
5. Проверка прав перед удалением сметы
6. Проверка прав перед импортом из Excel
7. Проверка прав перед проведением/отменой проведения сметы
8. Фильтрация списка смет для бригадиров (показываются только их сметы)

### DailyReportListForm (src/views/daily_report_list_form.py)

**Изменения:**
1. Кнопка "Создать" доступна только при наличии прав создания
2. Проверка прав перед созданием нового отчета
3. Проверка прав перед удалением отчета
4. Проверка прав перед проведением/отменой проведения отчета
5. Фильтрация списка отчетов для бригадиров (показываются только их отчеты)

### MainWindow (src/views/main_window.py)

**Изменения:**
1. Добавлена инициализация `auth_service`
2. Пункты меню "Справочники" доступны только при наличии прав управления справочниками
3. Пункт меню "Настройки программы" доступен только при наличии прав управления настройками
4. Пункт меню "Удаление помеченных объектов" доступен только при наличии прав управления справочниками

## Тестирование

Создан файл `test_access_rights.py` с комплексными тестами:

1. **test_administrator_permissions** - проверка полного доступа администратора
2. **test_manager_permissions** - проверка прав руководителя
3. **test_foreman_permissions** - проверка ограниченных прав бригадира
4. **test_employee_permissions** - проверка прав сотрудника (только чтение)
5. **test_no_user_permissions** - проверка отсутствия прав без авторизации
6. **test_convenience_methods** - проверка вспомогательных методов

**Результат:** ✅ Все тесты пройдены успешно

## Безопасность

### Реализованные меры безопасности:

1. **Проверка на уровне UI** - кнопки и пункты меню отключаются при отсутствии прав
2. **Проверка на уровне действий** - каждое действие проверяет права перед выполнением
3. **Проверка владения** - бригадиры могут работать только со своими документами
4. **Фильтрация данных** - пользователи видят только те данные, к которым имеют доступ
5. **Сообщения об ошибках** - понятные сообщения "Недостаточно прав для выполнения операции"

## Соответствие требованиям

Реализация полностью соответствует требованию 5 из спецификации:

✅ **5.1** - Проверка учетных данных и назначение роли при входе
✅ **5.2** - Бригадир видит только свои сметы
✅ **5.3** - Сотрудник видит только свои отчеты
✅ **5.4** - Руководитель имеет доступ ко всем данным организации
✅ **5.5** - Отклонение операций с сообщением "Недостаточно прав для выполнения операции"

## Примеры использования

### В коде формы:

```python
# Проверка перед созданием документа
if not self.auth_service.can_create_estimate():
    QMessageBox.warning(self, "Доступ запрещен", 
                      "Недостаточно прав для создания сметы")
    return

# Проверка перед редактированием конкретного документа
if not self.auth_service.can_edit_estimate(estimate_id):
    QMessageBox.warning(self, "Доступ запрещен", 
                      "Недостаточно прав для редактирования этой сметы")
    return

# Проверка общих прав
if self.auth_service.can_manage_references():
    # Показать меню управления справочниками
    pass
```

### Фильтрация данных:

```python
# Применение фильтрации для бригадиров
if self.auth_service.is_foreman():
    person_id = self.auth_service.current_person_id()
    if person_id:
        where_clauses.append("e.responsible_id = ?")
        params.append(person_id)
```

## Заключение

Система проверки прав доступа полностью реализована и протестирована. Она обеспечивает:

- Гибкое управление правами на основе ролей
- Безопасность данных через проверку владения
- Удобный API для проверки прав в формах
- Понятные сообщения об ошибках для пользователей
- Соответствие всем требованиям спецификации
