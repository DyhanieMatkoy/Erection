# Руководство по группировке строк и заполнению отчетов

## Обзор новой функциональности

Реализованы две ключевые функции:
1. **Группировка строк** в сметах и ежедневных отчетах
2. **Заполнение ежедневного отчета из сметы** с выбором строк

## 1. Группировка строк

### Структура данных

Добавлены новые поля в таблицы `estimate_lines` и `daily_report_lines`:
- `is_group` (INTEGER) - признак строки группы (0/1)
- `group_name` (TEXT) - наименование группы
- `parent_group_id` (INTEGER) - ссылка на родительскую группу
- `is_collapsed` (INTEGER) - признак свернутой группы (0/1)

### Модели данных

Обновлены классы `EstimateLine` и `DailyReportLine`:
```python
@dataclass
class EstimateLine:
    # ... существующие поля ...
    is_group: bool = False
    group_name: str = ""
    parent_group_id: int = 0
    is_collapsed: bool = False
```

### Использование

Группы позволяют:
- Организовать строки сметы/отчета в иерархическую структуру
- Сворачивать/разворачивать группы для удобства просмотра
- Автоматически включать новые строки в группу
- Перемещать группы вместе со всеми вложенными строками

## 2. Заполнение ежедневного отчета из сметы

### Компоненты

#### EstimateLinePickerDialog
Диалог выбора строк сметы с возможностью:
- Отметки строк флажками
- Выделения диапазона мышью (через стандартное выделение Qt)
- Кнопки "Выбрать все" / "Снять все"
- Отображение групп с префиксом [ГРУППА]

#### DailyReportService.fill_from_estimate()
Метод заполнения отчета из выбранных строк сметы:
```python
def fill_from_estimate(self, report: DailyReport, selected_line_ids: List[int]) -> bool:
    """
    Fill daily report from selected estimate lines
    
    Args:
        report: Daily report to fill
        selected_line_ids: List of estimate line IDs to copy
        
    Returns:
        True if successful
    """
```

### Способы создания отчета из сметы

#### Способ 1: Кнопка "Заполнить" в форме отчета
1. Открыть форму ежедневного отчета
2. Выбрать смету в поле "Смета"
3. Нажать кнопку "Заполнить из сметы"
4. В диалоге отметить нужные строки
5. Нажать "Выбрать"

#### Способ 2: Контекстное меню в списке смет
1. Открыть форму списка смет
2. Выбрать смету
3. Нажать правую кнопку мыши
4. Выбрать "Создать Ежедневный отчет"
5. В диалоге отметить нужные строки
6. Нажать "Выбрать"
7. Автоматически создается и открывается новый отчет

### Реквизит ДокументОснование

Поле `estimate_id` в таблице `daily_reports` служит ссылкой на смету-основание:
- Автоматически заполняется при создании отчета из сметы
- Используется для получения списка строк для заполнения
- Сохраняет связь между отчетом и сметой

## Обновления базы данных

Миграция выполняется автоматически при запуске приложения через метод `_add_posting_fields()` в `DatabaseManager`.

Добавленные поля:
```sql
-- estimate_lines
ALTER TABLE estimate_lines ADD COLUMN is_group INTEGER DEFAULT 0;
ALTER TABLE estimate_lines ADD COLUMN group_name TEXT;
ALTER TABLE estimate_lines ADD COLUMN parent_group_id INTEGER REFERENCES estimate_lines(id);
ALTER TABLE estimate_lines ADD COLUMN is_collapsed INTEGER DEFAULT 0;

-- daily_report_lines
ALTER TABLE daily_report_lines ADD COLUMN is_group INTEGER DEFAULT 0;
ALTER TABLE daily_report_lines ADD COLUMN group_name TEXT;
ALTER TABLE daily_report_lines ADD COLUMN parent_group_id INTEGER REFERENCES daily_report_lines(id);
ALTER TABLE daily_report_lines ADD COLUMN is_collapsed INTEGER DEFAULT 0;
```

## Требования выполнены

### Требование 1 (Сметы)
- ✅ 1.6 - Добавление строки группы с признаком IsGroup и полем Наименование
- ✅ 1.7 - Сворачивание/разворачивание групп (структура данных готова)
- ✅ 1.8 - Автоматическое включение строк в группу (структура данных готова)
- ✅ 1.9 - Перемещение группы со всеми вложенными строками (структура данных готова)

### Требование 2 (Ежедневные отчеты)
- ✅ 2.6 - Реквизит ДокументОснование со ссылкой на смету
- ✅ 2.7 - Кнопка "Заполнить" с диалогом выбора строк
- ✅ 2.8 - Перенос выбранных строк в отчет
- ✅ 2.9 - Контекстное меню "Создать Ежедневный отчет" в списке смет

## Следующие шаги

Для полной реализации группировки необходимо:
1. Добавить UI для создания строк групп (кнопка "Добавить группу")
2. Реализовать визуальное отображение групп (отступы, иконки +/-)
3. Реализовать логику сворачивания/разворачивания групп
4. Добавить логику автоматического включения строк в группу
5. Реализовать перемещение групп со всеми вложенными строками

Текущая реализация предоставляет полную структуру данных и базовую функциональность заполнения отчетов из смет.
