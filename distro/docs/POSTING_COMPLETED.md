# Проведение документов и регистр накопления - ЗАВЕРШЕНО

## ✅ Выполнено

### 1. База данных
- ✅ Создана таблица `work_execution_register` для хранения движений
- ✅ Добавлены поля `is_posted` и `posted_at` в таблицы `estimates` и `daily_reports`
- ✅ Созданы индексы для оптимизации запросов

### 2. Репозиторий регистра
- ✅ Создан `WorkExecutionRegisterRepository` с методами:
  - `get_movements()` - получение движений документа
  - `delete_movements()` - удаление движений
  - `create_movement()` - создание движения
  - `get_balance()` - получение остатков с группировкой
  - `get_turnovers()` - получение оборотов за период

### 3. Сервис проведения
- ✅ Создан `DocumentPostingService` с методами:
  - `post_estimate()` - проведение сметы (приход +)
  - `unpost_estimate()` - отмена проведения сметы
  - `post_daily_report()` - проведение отчета (расход -)
  - `unpost_daily_report()` - отмена проведения отчета

### 4. Формы документов
- ✅ В `EstimateDocumentForm` добавлены:
  - Кнопка "Провести (Ctrl+K)"
  - Кнопка "Отменить проведение"
  - Метод `on_post()` для проведения
  - Метод `on_unpost()` для отмены проведения
  - Метод `update_posting_state()` для блокировки полей
  - Загрузка статуса проведения при открытии
  - Обновление заголовка окна с отображением статуса [ПРОВЕДЕН]

- ✅ В `DailyReportDocumentForm` добавлены:
  - Аналогичные кнопки и методы
  - Блокировка редактирования проведенных документов

### 5. Списки документов
- ✅ В `EstimateListForm` добавлена:
  - Колонка "Проведен" с отметкой ✓
  - Выделение проведенных документов жирным шрифтом
  - Загрузка статуса проведения из БД

- ✅ В `DailyReportListForm` добавлена:
  - Аналогичная колонка и форматирование

### 6. Отчет по выполнению работ
- ✅ Создана форма `WorkExecutionReportForm` с:
  - Параметрами отбора: период, объект, смета, работа
  - Выбором группировки: по объектам, сметам, работам, датам
  - Таблицей результатов с колонками:
    - План количество
    - Факт количество
    - Остаток количество
    - План сумма
    - Факт сумма
    - Остаток сумма
    - % выполнения
  - Кнопкой "Сформировать"
  - Кнопкой "Экспорт в Excel" (заглушка)

### 7. Меню
- ✅ Добавлен пункт меню "Отчеты" → "Выполнение работ"
- ✅ Отчет открывается в MDI area главного окна

## Логика работы

### Проведение сметы
1. Пользователь создает/редактирует смету
2. Сохраняет смету
3. Нажимает "Провести"
4. Система создает движения в регистре с приходом (+):
   - Для каждой строки табличной части
   - quantity_income = количество
   - sum_income = сумма
   - period = дата сметы
   - object_id, estimate_id, work_id = из сметы
5. Документ помечается как проведенный
6. Поля формы блокируются для редактирования

### Проведение ежедневного отчета
1. Пользователь создает отчет по смете
2. Заполняет фактические трудозатраты
3. Сохраняет отчет
4. Нажимает "Провести"
5. Система создает движения в регистре с расходом (-):
   - Для каждой строки табличной части
   - quantity_expense = фактические трудозатраты
   - sum_expense = фактические трудозатраты × цена работы
   - period = дата отчета
   - object_id, estimate_id, work_id = из отчета
6. Документ помечается как проведенный
7. Поля формы блокируются

### Отчет по выполнению работ
1. Пользователь открывает отчет из меню
2. Выбирает параметры: период, фильтры, группировку
3. Нажимает "Сформировать"
4. Система запрашивает обороты из регистра
5. Рассчитывает:
   - План = SUM(quantity_income)
   - Факт = SUM(quantity_expense)
   - Остаток = План - Факт
   - % выполнения = (Факт / План) × 100
6. Отображает результаты в таблице

## Тестирование

### Сценарий 1: Проведение сметы
```
1. Создать смету с 3 работами
2. Заполнить количество и цены
3. Сохранить смету
4. Нажать "Провести"
5. Проверить:
   - Кнопка "Провести" стала неактивной
   - Кнопка "Отменить проведение" стала активной
   - Поля заблокированы
   - В заголовке появилось [ПРОВЕДЕН]
   - В списке смет появилась галочка ✓
```

### Сценарий 2: Проведение отчета
```
1. Создать ежедневный отчет по проведенной смете
2. Заполнить фактические трудозатраты
3. Сохранить отчет
4. Нажать "Провести"
5. Проверить аналогично смете
```

### Сценарий 3: Отчет по выполнению
```
1. Открыть "Отчеты" → "Выполнение работ"
2. Выбрать период, включающий проведенные документы
3. Выбрать группировку "По сметам"
4. Нажать "Сформировать"
5. Проверить:
   - В таблице отображается смета
   - План = сумма из сметы
   - Факт = сумма из отчета
   - Остаток = План - Факт
   - % выполнения рассчитан корректно
```

### Сценарий 4: Отмена проведения
```
1. Открыть проведенную смету
2. Нажать "Отменить проведение"
3. Подтвердить
4. Проверить:
   - Поля разблокированы
   - Кнопки переключились
   - Статус [ПРОВЕДЕН] исчез
   - В списке галочка исчезла
5. Изменить смету
6. Сохранить
7. Провести заново
8. Проверить отчет - данные обновились
```

## SQL для проверки

### Проверка движений сметы
```sql
SELECT * FROM work_execution_register 
WHERE recorder_type = 'estimate' AND recorder_id = 1;
```

### Проверка движений отчета
```sql
SELECT * FROM work_execution_register 
WHERE recorder_type = 'daily_report' AND recorder_id = 1;
```

### Проверка остатков
```sql
SELECT 
    e.number as estimate,
    w.name as work,
    SUM(r.quantity_income) as plan,
    SUM(r.quantity_expense) as fact,
    SUM(r.quantity_income - r.quantity_expense) as balance
FROM work_execution_register r
LEFT JOIN estimates e ON r.estimate_id = e.id
LEFT JOIN works w ON r.work_id = w.id
GROUP BY r.estimate_id, r.work_id;
```

## Структура регистра

```
work_execution_register:
├── id (PK)
├── recorder_type ('estimate' | 'daily_report')
├── recorder_id (ID документа)
├── line_number (номер строки)
├── period (дата движения) [измерение]
├── object_id (объект) [измерение]
├── estimate_id (смета) [измерение]
├── work_id (работа) [измерение]
├── quantity_income (приход +)
├── quantity_expense (расход -)
├── sum_income (приход суммы +)
├── sum_expense (расход суммы -)
└── created_at (дата создания)
```

## Файлы

### Новые файлы
- `src/data/repositories/work_execution_register_repository.py`
- `src/services/document_posting_service.py`
- `src/views/work_execution_report_form.py`
- `.kiro/specs/construction-time-management/tasks_registers.md`
- `POSTING_IMPLEMENTATION.md`
- `POSTING_COMPLETED.md`

### Измененные файлы
- `src/data/database_manager.py` - добавлена таблица регистра и поля проведения
- `src/views/estimate_document_form.py` - добавлены кнопки и методы проведения
- `src/views/daily_report_document_form.py` - добавлены кнопки и методы проведения
- `src/views/estimate_list_form.py` - добавлена колонка "Проведен"
- `src/views/daily_report_list_form.py` - добавлена колонка "Проведен"
- `src/views/main_window.py` - добавлен пункт меню отчета
- `.kiro/specs/construction-time-management/requirements.md` - добавлено Требование 8

## Итог

Полностью реализована система проведения документов и регистр накопления:
- ✅ Документы можно проводить и отменять проведение
- ✅ Проведенные документы создают движения в регистре
- ✅ Проведенные документы нельзя редактировать
- ✅ Отчет показывает план-факт по выполнению работ
- ✅ Поддерживается группировка и фильтрация
- ✅ Все изменения отображаются в интерфейсе

Система готова к использованию!
