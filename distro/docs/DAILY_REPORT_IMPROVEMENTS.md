# Улучшения формы Ежедневного отчёта

## Внесённые изменения

### 1. Кнопка создания ежедневного отчёта в списке смет

**Проблема:** Не было удобного способа создать ежедневный отчёт на основе выбранной сметы.

**Решение:** 
- Добавлена кнопка "Создать Ежедневный отчёт" в форму списка смет (`EstimateListForm`)
- При нажатии кнопки открывается новая форма ежедневного отчёта с предзаполненной сметой
- Функция также доступна через контекстное меню (правый клик на смете)

**Расположение:** `src/views/estimate_list_form.py`

### 2. Исправление выбора сметы и бригадира в новом отчёте

**Проблема:** В непроведенном ежедневном отчёте выпадающие списки для выбора сметы и бригадира были пусты.

**Решение:**
- Добавлена инициализация полей сметы и бригадира в методе `create_new_report()`
- Добавлен параметр `estimate_id` в конструктор `DailyReportDocumentForm`
- При создании нового отчёта из списка смет, смета автоматически предзаполняется

**Расположение:** `src/views/daily_report_document_form.py`

## Как использовать

### Создание ежедневного отчёта из сметы

1. Откройте список смет (Документы → Сметы)
2. Выберите нужную смету в списке
3. Нажмите кнопку "Создать Ежедневный отчёт" или используйте контекстное меню
4. Откроется форма нового ежедневного отчёта с уже выбранной сметой
5. Выберите бригадира, нажав кнопку "..." рядом с полем "Бригадир"
6. Нажмите "Заполнить из сметы" для добавления строк
7. Сохраните отчёт

### Выбор сметы и бригадира

**Выбор сметы:**
- Нажмите кнопку "..." рядом с полем "Смета"
- Откроется список смет
- Выберите нужную смету и нажмите "Выбрать"

**Выбор бригадира:**
- Нажмите кнопку "..." рядом с полем "Бригадир"
- Откроется справочник "Физические лица"
- Выберите нужного бригадира и нажмите "Выбрать" (Ctrl+Enter)

## Технические детали

### Изменения в EstimateListForm

```python
# Добавлена кнопка
self.create_report_button = QPushButton("Создать Ежедневный отчёт")
self.create_report_button.clicked.connect(self.on_create_daily_report)

# Упрощён метод создания отчёта
def on_create_daily_report(self):
    """Create daily report from selected estimate"""
    # Создаёт новую форму с предзаполненной сметой
    form = DailyReportDocumentForm(0, estimate_id)
```

### Изменения в DailyReportDocumentForm

```python
# Добавлен параметр estimate_id в конструктор
def __init__(self, report_id: int = 0, estimate_id: int = 0):
    # ...
    if report_id > 0:
        self.load_report()
    else:
        self.create_new_report(estimate_id)

# Обновлён метод создания нового отчёта
def create_new_report(self, estimate_id: int = 0):
    """Create new report"""
    self.date_edit.setDate(QDate.currentDate())
    # Инициализация пустых значений
    self.estimate_id = 0
    self.estimate_edit.setText("")
    self.foreman_id = 0
    self.foreman_edit.setText("")
    
    # Если передан estimate_id, загрузить смету
    if estimate_id > 0:
        self.load_estimate(estimate_id)
```

## Тестирование

Для тестирования изменений запустите:

```bash
python test_daily_report_creation.py
```

Проверьте:
1. ✓ Кнопка "Создать Ежедневный отчёт" присутствует в списке смет
2. ✓ При выборе сметы и нажатии кнопки открывается форма ежедневного отчёта
3. ✓ В форме отчёта смета уже выбрана
4. ✓ Можно выбрать бригадира через кнопку "..."
5. ✓ Выпадающие списки работают корректно

## Связанные файлы

- `src/views/estimate_list_form.py` - список смет
- `src/views/daily_report_document_form.py` - форма ежедневного отчёта
- `src/views/reference_picker_dialog.py` - диалог выбора из справочника
- `test_daily_report_creation.py` - тестовый скрипт
