# Новые функции системы

## Обзор изменений

Реализованы следующие улучшения системы:

### 1. F5 - Обновление форм списков

**Описание:** Во всех формах списков (Работы, Сметы, Ежедневные отчеты, Контрагенты и т.д.) теперь работает клавиша F5 для обновления данных.

**Использование:**
- Откройте любую форму списка
- Нажмите F5
- Список обновится с учетом текущего фильтра поиска

**Технические детали:**
- Реализовано в базовом классе `BaseListForm`
- Автоматически работает во всех наследниках

---

### 2. Кнопка "Изменить" в диалогах выбора

**Описание:** В диалогах выбора элементов справочников добавлена кнопка "Изменить" (F4), которая открывает выбранный элемент на редактирование.

**Использование:**
- Откройте диалог выбора (например, при выборе работы в смете)
- Выберите элемент в списке
- Нажмите кнопку "Изменить" или клавишу F4
- Откроется форма редактирования выбранного элемента

**Поддерживаемые справочники:**
- Работы
- Контрагенты
- Объекты
- Организации
- Персоны

**Технические детали:**
- Реализовано в `ReferencePickerDialog.on_edit()`
- Поддерживает горячую клавишу F4

---

### 3. Расширенный справочник "Работы"

**Описание:** Справочник работ теперь содержит дополнительные поля:
- **Код** - уникальный код работы (до 12 символов)
- **Норма трудозатрат** - норма в часах на единицу работы
- **Единица измерения** - ед.изм. работы
- **Стоимость единицы** - цена за единицу работы

**Отображение в системе:**

#### В списке работ:
```
Код       | Наименование              | Ед.изм. | Цена    | Норма ТЗ
TEST-001  | Тестовая работа с кодом  | шт      | 1500.00 | 8.50
```

#### В смете:
При выборе работы автоматически заполняются:
- Код работы (отображается в названии: `[TEST-001] Тестовая работа`)
- Единица измерения
- Цена
- Норма трудозатрат

#### В печатной форме:
Код работы отображается в отдельной колонке таблицы сметы.

**Технические детали:**
- Добавлены поля в таблицу `works`: `code`, `parent_id`, `is_group`
- Обновлены формы: `WorkForm`, `WorkListForm`
- Обновлена печатная форма: `EstimatePrintForm`

---

### 4. Группы в смете

**Описание:** В смете можно добавлять строки-группы для структурирования работ.

**Использование:**
1. Откройте смету
2. Нажмите кнопку "Добавить группу"
3. В таблице появится строка с текстом "=== ГРУППА ==="
4. Отредактируйте название группы
5. Добавьте работы после группы

**Особенности:**
- Группы не участвуют в расчете итогов
- Группы выделяются в печатной форме
- Группы можно перемещать вместе с работами

**Технические детали:**
- Группы сохраняются с `work_id = -1`
- Название группы хранится в поле `unit`
- Реализовано в `EstimateDocumentForm.on_add_group()`

---

### 5. Перемещение строк в табличных частях

**Описание:** В табличных частях документов (смета, ежедневный отчет) можно перемещать строки вверх/вниз.

**Использование:**
1. Выберите строку в таблице
2. Нажмите **Ctrl+Shift+Up** для перемещения вверх
3. Нажмите **Ctrl+Shift+Down** для перемещения вниз

**Технические детали:**
- Реализовано в `EstimateDocumentForm.on_move_row_up()` и `on_move_row_down()`
- Использует метод `swap_rows()` для обмена строк

---

## Миграция базы данных

Для работы новых функций необходимо обновить структуру БД:

```bash
python migrate_works_table.py
```

Скрипт добавит следующие поля в таблицу `works`:
- `code TEXT` - код работы
- `parent_id INTEGER` - родительская группа
- `is_group INTEGER DEFAULT 0` - признак группы

---

## Тестирование

Для проверки новых функций:

```bash
python test_new_features.py
```

Скрипт:
1. Проверит структуру БД
2. Добавит тестовые данные
3. Выведет инструкции по тестированию UI

---

## Горячие клавиши

### Формы списков:
- **F5** - Обновить список
- **Insert / F9** - Создать новый элемент
- **Enter** - Открыть выбранный элемент
- **Delete** - Пометить на удаление
- **Ctrl+F** - Активировать поиск

### Диалоги выбора:
- **F4** - Изменить выбранный элемент
- **Enter** - Открыть группу / Выбрать элемент
- **Ctrl+Enter** - Выбрать элемент
- **Backspace** - Вверх по иерархии
- **Esc** - Отмена

### Табличные части:
- **Insert** - Добавить строку
- **Delete** - Удалить строку
- **F4** - Выбрать элемент (в колонке работы)
- **Ctrl+Shift+Up** - Переместить строку вверх
- **Ctrl+Shift+Down** - Переместить строку вниз

---

## Примеры использования

### Создание работы с кодом

1. Откройте "Справочники" → "Работы"
2. Нажмите Insert или F9
3. Заполните поля:
   - Наименование: "Монтаж оборудования"
   - Код: "МНТ-001"
   - Единица измерения: "шт"
   - Цена: 5000.00
   - Норма трудозатрат: 16.0
4. Сохраните (Ctrl+S)

### Создание сметы с группами

1. Откройте "Документы" → "Сметы"
2. Создайте новую смету (Insert)
3. Заполните реквизиты
4. Нажмите "Добавить группу"
5. Измените название группы на "Подготовительные работы"
6. Нажмите "Добавить строку"
7. Выберите работу (двойной клик или F4)
8. Повторите для других работ
9. Используйте Ctrl+Shift+Up/Down для изменения порядка
10. Сохраните смету

### Быстрое редактирование из диалога выбора

1. В смете дважды кликните на колонку "Работа"
2. В диалоге выбора найдите нужную работу
3. Нажмите F4 для редактирования
4. Измените данные работы
5. Сохраните
6. Вернитесь в диалог выбора и нажмите F5 для обновления
7. Выберите работу (Ctrl+Enter)

---

## Известные ограничения

1. Группы в смете не могут содержать вложенные группы
2. При перемещении строк пересчет итогов происходит автоматически
3. Код работы ограничен 12 символами

---

## Обратная совместимость

Все изменения обратно совместимы:
- Существующие сметы продолжат работать
- Работы без кода будут отображаться без префикса
- Старые строки смет не содержат групп

---

## Поддержка

При возникновении проблем:
1. Проверьте, что выполнена миграция БД
2. Запустите тестовый скрипт
3. Проверьте логи приложения
