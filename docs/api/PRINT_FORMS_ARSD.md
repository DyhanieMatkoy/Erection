# Печатные формы в формате АРСД

## Обзор

Реализованы печатные формы для сметы и ежедневного отчета на основе формата АРСД (пример сметы арсд.xlsx).

## Реализованные формы

### 1. Смета (Локальный сметный расчет)

**Файл:** `src/services/estimate_print_form.py`

**Формат документа:**
- Шапка с согласованием (Заказчик / Подрядчик)
- Заголовок: "ЛОКАЛЬНЫЙ СМЕТНЫЙ РАСЧЕТ №{номер}"
- Подзаголовок: "(локальная смета)"
- Описание объекта
- Таблица работ с колонками:
  - N - номер строки
  - Код - код работы
  - Наименование работ и затрат
  - ЕдИзм - единица измерения
  - Кол-во - количество
  - **На единицу работ:**
    - Зарплата
    - Материалы, механизмы
    - Всего
    - ТЗ (трудозатраты)
  - **На полный объём работ:**
    - Зарплата
    - Материалы, механизмы
    - Всего
    - ТЗ (трудозатраты)
- Итоговая секция с общей суммой и трудозатратами

**Использование:**
```python
from src.services.estimate_print_form import EstimatePrintForm

generator = EstimatePrintForm()
pdf_content = generator.generate(estimate_id)

# Сохранить в файл
with open('estimate.pdf', 'wb') as f:
    f.write(pdf_content)
```

### 2. Ежедневный отчет

**Файл:** `src/services/daily_report_print_form.py`

**Формат документа:**
- Заголовок: "ЕЖЕДНЕВНЫЙ ОТЧЕТ О ВЫПОЛНЕННЫХ РАБОТАХ"
- Информация о документе:
  - Дата отчета
  - Смета №
  - Объект
  - Бригадир
- Таблица выполненных работ с колонками:
  - № п/п
  - Наименование выполненных работ
  - Ед.изм.
  - Объем работ
  - Плановые трудозатраты, ч
  - Фактические трудозатраты, ч
  - Отклонение, %
  - Исполнители (ФИО)
- Итоговая секция:
  - Плановые трудозатраты
  - Фактические трудозатраты
  - Отклонение
- Секция подписей:
  - Бригадир (подпись)
  - Принял (подпись)

**Использование:**
```python
from src.services.daily_report_print_form import DailyReportPrintForm

generator = DailyReportPrintForm()
pdf_content = generator.generate(report_id)

# Сохранить в файл
with open('daily_report.pdf', 'wb') as f:
    f.write(pdf_content)
```

## Базовый класс

**Файл:** `src/services/print_form_generator.py`

Базовый класс `PrintFormGenerator` предоставляет общие методы для генерации PDF:

- `create_title(text)` - создание заголовка
- `create_subtitle(text)` - создание подзаголовка
- `create_paragraph(text)` - создание обычного параграфа
- `create_centered_paragraph(text)` - создание центрированного параграфа
- `create_small_paragraph(text)` - создание мелкого текста
- `create_small_centered_paragraph(text)` - создание мелкого центрированного текста
- `create_spacer(height)` - создание вертикального отступа
- `create_table(data, col_widths, style)` - создание таблицы
- `create_info_table(data)` - создание информационной таблицы (метка-значение)
- `format_number(value, decimals)` - форматирование чисел
- `format_date(date_obj)` - форматирование дат
- `create_pdf(elements)` - генерация PDF из элементов

## Особенности реализации

### Поддержка кириллицы

Используется шрифт DejaVu Sans для корректного отображения русского текста. Если шрифт недоступен, используется Helvetica с ограниченной поддержкой кириллицы.

### Формат АРСД

Печатные формы соответствуют формату АРСД:
- Двухуровневая шапка таблицы для сметы
- Разделение на единичные и полные объемы работ
- Расчет зарплаты и материалов отдельно
- Подписи согласования и утверждения

### Расчеты

**Для сметы:**
- Единичная зарплата = норма трудозатрат
- Единичные материалы = цена - зарплата
- Единичный итог = цена
- Полная зарплата = единичная зарплата × количество
- Полные материалы = единичные материалы × количество
- Полный итог = сумма строки
- Полные трудозатраты = плановые трудозатраты

**Для ежедневного отчета:**
- Отклонение = ((факт - план) / план) × 100%

## Тестирование

Запустите тест для проверки генерации форм:

```bash
python test_print_forms_updated.py
```

Будут созданы файлы:
- `test_estimate_arsd.pdf` - пример сметы
- `test_daily_report_arsd.pdf` - пример ежедневного отчета

## Интеграция с приложением

Печатные формы интегрированы в формы документов:

**Смета:**
- Кнопка "Печать" в форме сметы (`src/views/estimate_document_form.py`)
- Вызывает `EstimatePrintForm().generate(estimate_id)`

**Ежедневный отчет:**
- Кнопка "Печать" в форме ежедневного отчета (`src/views/daily_report_document_form.py`)
- Вызывает `DailyReportPrintForm().generate(report_id)`

## Зависимости

Требуется библиотека ReportLab:
```
reportlab>=3.6.0
```

Уже включена в `requirements.txt`.

## Дальнейшие улучшения

Возможные улучшения:
1. Добавление логотипов организаций
2. Настройка шрифтов и стилей через конфигурацию
3. Экспорт в Excel формат
4. Добавление штрих-кодов или QR-кодов
5. Поддержка групп в печатных формах
6. Настройка видимости колонок
