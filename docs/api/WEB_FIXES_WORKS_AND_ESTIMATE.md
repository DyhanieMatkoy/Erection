# Исправления: Справочник Работы и Ввод Смет на основании Ежедневного отчета

## Дата: 2025-12-01

## Исправленные проблемы

### 1. Справочник "Работы" - Ошибка alert [object Object]

**Проблема:** При ошибке загрузки данных в справочнике "Работы" показывался alert с текстом "[object Object]" вместо понятного сообщения об ошибке.

**Решение:** Исправлена обработка ошибок в `web-client/src/views/references/WorksView.vue`:
- Добавлено правильное приведение типа ошибки к `{ response?: { data?: { detail?: string } } }`
- Теперь показывается текст ошибки из `error.response?.data?.detail` или общее сообщение "Ошибка при загрузке данных"

**Измененные файлы:**
- `web-client/src/views/references/WorksView.vue` - исправлена обработка ошибок в функциях `loadData()` и `handleBulkDelete()`

### 2. Кнопка "Ввод на основании ежедневного отчета" в списке Смет

**Проблема:** В списке документов "Сметы" отсутствовала кнопка для создания сметы на основании ежедневного отчета (как в Desktop версии).

**Решение:** Добавлена функциональность создания сметы на основании ежедневного отчета:

1. **В EstimateListView.vue:**
   - Добавлена кнопка "Ввод на основании ежедневного отчета" в header-actions
   - Добавлено модальное окно для выбора ежедневного отчета
   - Реализована функция `handleCreateFromTimesheet()` для загрузки списка отчетов
   - Реализована функция `handleTimesheetSelected()` для перехода к созданию сметы с параметром `timesheet_id`

2. **В EstimateFormView.vue:**
   - Добавлена функция `loadFromTimesheet(timesheetId)` для загрузки данных из ежедневного отчета
   - При создании новой сметы проверяется параметр `timesheet_id` в URL
   - Автоматически заполняются поля: дата, объект, заказчик, подрядчик, ответственный (из связанной сметы)
   - Генерируется номер сметы в формате `СМ-YYYYMMDD-XXX`

**Измененные файлы:**
- `web-client/src/views/documents/EstimateListView.vue` - добавлена кнопка и модальное окно выбора
- `web-client/src/views/documents/EstimateFormView.vue` - добавлена логика загрузки из ежедневного отчета

## Технические детали

### Модальное окно выбора ежедневного отчета

Модальное окно показывает таблицу с последними 100 ежедневными отчетами:
- Номер отчета
- Дата
- Объект
- Заказчик

Пользователь выбирает отчет и нажимает "Создать смету", после чего открывается форма создания сметы с предзаполненными данными.

### Логика заполнения сметы

При создании сметы на основании ежедневного отчета:
1. Загружается выбранный ежедневный отчет (Timesheet)
2. Заполняются основные поля из отчета (дата, объект)
3. Если у отчета есть связанная смета (estimate_id), загружаются дополнительные данные (заказчик, подрядчик, ответственный)
4. Генерируется уникальный номер сметы
5. Строки сметы остаются пустыми - пользователь добавляет их вручную

## Сборка

Проект успешно собран:
```bash
cd web-client
npm run build-only
```

Собранные файлы скопированы в `build/web/`

## Тестирование

Рекомендуется протестировать:
1. Открытие справочника "Работы" - проверить, что ошибки показываются корректно
2. Создание сметы на основании ежедневного отчета:
   - Открыть список смет
   - Нажать "Ввод на основании ежедневного отчета"
   - Выбрать отчет из списка
   - Проверить, что форма сметы открылась с предзаполненными данными
   - Добавить строки и сохранить смету
