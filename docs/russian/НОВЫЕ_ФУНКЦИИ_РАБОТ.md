# Новые функции управления работами

## Реализованные функции

### 1. ✅ Создание подгрупп при импорте

**Описание**: При загрузке CSV, если выбрана родительская группа И в CSV заполнено поле "Тип работ", автоматически создаётся подгруппа.

**Логика**:
- Без родительской группы: "Тип работ" создаёт группу в корне
- С родительской группой: "Тип работ" создаёт подгруппу внутри выбранной группы

**Пример**:
```
Родительская группа: "Строительные работы"
CSV:
  Тип работ: "Кладка"
  Наименование: "Кладка кирпича"
  
Результат:
  Строительные работы
    └─ Кладка
       └─ Кладка кирпича
```

### 2. ✅ Режим удаления при импорте

**Описание**: Новая опция "Режим удаления" помечает работы на удаление по наименованиям из CSV файла вместо импорта.

**Использование**:
1. Откройте импорт CSV
2. Установите галочку "Режим удаления"
3. Выберите CSV файл с наименованиями работ для удаления
4. Нажмите "Импортировать"

**Результат**: Все работы с совпадающими наименованиями будут помечены на удаление (marked_for_deletion = 1).

**Примечание**: В режиме удаления опция "Пропускать существующие работы" автоматически отключается.

### 3. ✅ Массовая смена группы

**Описание**: Возможность переместить несколько выбранных работ в другую группу одним действием.

**Использование**:
1. Выделите работы (чекбоксы)
2. Нажмите кнопку "Сменить группу" на командной панели
3. Выберите новую родительскую группу
4. Нажмите "Переместить"

**Результат**: Все выбранные работы будут перемещены в указанную группу.

### 4. ✅ Упрощённое управление

**Изменения в интерфейсе**:

**Удалены кнопки из строк таблицы**:
- ❌ Кнопка "Изменить"
- ❌ Кнопка "Удалить"

**Новые способы управления**:
- **Двойной клик** на строке → открывает форму редактирования
- **Клавиша Del** → удаляет выбранные работы
- **Командная панель** → содержит все действия для выбранных элементов

**Командная панель** (появляется при выборе элементов):
- Кнопка "Сменить группу"
- Кнопка "Удалить (N)" - где N количество выбранных

### 5. ⚠️ Фиксированная командная панель

**Статус**: Требует дополнительной реализации в компоненте DataTable

**Описание**: Командная панель должна оставаться видимой при прокрутке списка.

**Текущее состояние**: Командная панель находится в header-actions и прокручивается вместе со списком.

**Требуется**: Модификация компонента DataTable для sticky позиционирования командной панели.

### 6. ⚠️ Массовое выделение обводом мышкой

**Статус**: Требует дополнительной реализации

**Описание**: Возможность выделить несколько элементов, обведя их мышкой (drag selection).

**Текущее состояние**: Выделение работает только через чекбоксы.

**Требуется**: 
- Добавление библиотеки для drag selection (например, vue-drag-select)
- Интеграция с компонентом DataTable
- Обработка событий мыши для выделения

### 7. ⚠️ Перетаскивание элементов

**Статус**: Требует дополнительной реализации

**Описание**: Возможность перетащить выбранные элементы в другую группу drag-and-drop.

**Текущее состояние**: Перемещение работает только через модальное окно "Сменить группу".

**Требуется**:
- Добавление библиотеки для drag-and-drop (например, vue-draggable-next)
- Интеграция с иерархическим представлением
- Обработка drop событий для смены группы

## API Endpoints

### POST /api/references/works/import-csv

**Новые параметры**:
- `delete_mode` (boolean, default: false) - режим удаления

**Пример**:
```bash
curl -X POST "http://localhost:8000/api/references/works/import-csv?delete_mode=true" \
  -H "Authorization: Bearer TOKEN" \
  -F "file=@works_to_delete.csv"
```

### POST /api/references/works/bulk-move

**Описание**: Массовое перемещение работ в другую группу

**Request Body**:
```json
{
  "work_ids": [1, 2, 3],
  "new_parent_id": 10
}
```

**Response**:
```json
{
  "success": true,
  "message": "Moved 3 of 3 works",
  "processed": 3,
  "errors": []
}
```

## Горячие клавиши

- **Double Click** - редактировать работу
- **Del** - удалить выбранные работы
- **Ctrl+A** - выделить все (стандартное поведение браузера)

## Примеры использования

### Пример 1: Импорт с созданием подгрупп

```csv
Тип работ;Наименование работы;Цена;Единица измерения
Фундамент;Земляные работы;1000;м3
Фундамент;Бетонирование;2000;м3
Стены;Кладка кирпича;1500;м2
Стены;Штукатурка;500;м2
```

Выберите родительскую группу "Строительные работы" → Импорт создаст:
```
Строительные работы
  ├─ Фундамент
  │   ├─ Земляные работы
  │   └─ Бетонирование
  └─ Стены
      ├─ Кладка кирпича
      └─ Штукатурка
```

### Пример 2: Удаление работ по списку

Создайте CSV с работами для удаления:
```csv
Тип работ;Наименование работы;Цена;Единица измерения
;Устаревшая работа 1;;
;Устаревшая работа 2;;
;Устаревшая работа 3;;
```

Установите галочку "Режим удаления" → Импорт пометит эти работы на удаление.

### Пример 3: Массовое перемещение

1. Выделите 10 работ из группы "Электромонтаж"
2. Нажмите "Сменить группу"
3. Выберите "Дополнительные работы"
4. Нажмите "Переместить"

Все 10 работ переместятся в группу "Дополнительные работы".

## Что осталось реализовать

### Высокий приоритет
- ✅ Создание подгрупп при импорте
- ✅ Режим удаления при импорте
- ✅ Массовая смена группы
- ✅ Упрощённое управление (двойной клик, Del)

### Средний приоритет
- ⚠️ Фиксированная командная панель (требует изменения DataTable)

### Низкий приоритет
- ⚠️ Массовое выделение обводом мышкой (требует библиотеки)
- ⚠️ Перетаскивание элементов (требует библиотеки)

## Технические детали

### Backend изменения
- `api/endpoints/references.py`:
  - Обновлён endpoint `import_works_from_csv` с параметром `delete_mode`
  - Добавлен endpoint `bulk_move_works`
  - Логика создания подгрупп с учётом parent_id

### Frontend изменения
- `web-client/src/api/references.ts`:
  - Обновлена функция `importWorksFromCSV` с параметром `deleteMode`
  - Добавлена функция `bulkMoveWorks`

- `web-client/src/views/references/WorksView.vue`:
  - Добавлена опция "Режим удаления" в модальное окно импорта
  - Добавлено модальное окно "Сменить группу"
  - Добавлена кнопка "Сменить группу" в bulk-actions
  - Удалены кнопки "Изменить" и "Удалить" из строк таблицы
  - Добавлена обработка двойного клика для редактирования
  - Добавлена обработка клавиши Del для удаления

## Тестирование

### Тест 1: Создание подгрупп
```bash
# Создайте CSV с типами работ
# Выберите родительскую группу
# Импортируйте
# Проверьте иерархию
```

### Тест 2: Режим удаления
```bash
# Создайте CSV с наименованиями
# Включите "Режим удаления"
# Импортируйте
# Проверьте, что работы помечены на удаление
```

### Тест 3: Массовое перемещение
```bash
# Выделите несколько работ
# Нажмите "Сменить группу"
# Выберите новую группу
# Проверьте перемещение
```
