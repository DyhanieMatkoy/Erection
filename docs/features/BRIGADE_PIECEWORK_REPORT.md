# Отчет "Сдельная форма по бригаде"

## Описание

Реализован новый вариант отчета "Выполнение работ" - **"Сдельная форма по бригаде"**, который формирует детальный отчет о выполненных работах с разбивкой по датам в формате Excel.

## Особенности отчета

### Структура отчета

Отчет содержит следующие разделы:

1. **Заголовок**: Название проекта, исполнитель, период
2. **Сводная информация**:
   - Объём по проекту (План/Факт/+/-/%)
   - Стоимость по проекту (План/Факт/+/-/%)
3. **Детализация по датам**: Для каждой даты выполнения работ показываются:
   - Фактические объёмы
   - Фактическая стоимость
4. **Итоговая строка**: Суммы по всем работам

### Колонки отчета

- **№ п/п** - порядковый номер
- **Наименование работ** - название работы
- **Исполнитель** - ФИО исполнителя (бригадира)
- **Ед. изм.** - единица измерения
- **Стоимость на ед.** - цена за единицу
- **Объём по проекту**:
  - План - плановое количество
  - Факт - фактическое количество
  - +/- - отклонение
  - % - процент выполнения
- **Стоимость по проекту**:
  - План - плановая стоимость
  - Факт - фактическая стоимость
  - +/- - отклонение
  - % - процент выполнения
- **Даты выполнения** (динамические колонки):
  - Факт объёмы - количество выполненных работ в эту дату
  - Факт стоимость - стоимость выполненных работ в эту дату

## Использование

### Через интерфейс

1. Откройте форму **"Отчет: Выполнение работ"** из главного меню
2. Установите параметры отчета:
   - **Период** - начальная и конечная даты
   - **Объект** - фильтр по объекту (опционально)
   - **Смета** - фильтр по смете (опционально)
   - **Работа** - фильтр по виду работ (опционально)
   - **Исполнитель** - фильтр по исполнителю/бригадиру (опционально)
3. Нажмите кнопку **"Сформировать"** для просмотра данных в таблице
4. Нажмите кнопку **"Сдельная форма по бригаде"** для экспорта в Excel
5. Выберите место сохранения файла

### Программно

```python
from src.services.excel_brigade_piecework_report import ExcelBrigadePieceworkReport

# Создать генератор
generator = ExcelBrigadePieceworkReport()

# Сформировать отчет
excel_bytes = generator.generate(
    period_start='2025-01-01',
    period_end='2025-12-31',
    filters={
        'object_id': 1,           # опционально
        'estimate_id': 5,         # опционально
        'work_id': 10,            # опционально
        'executor_id': 3          # опционально
    }
)

# Сохранить в файл
if excel_bytes:
    with open('report.xlsx', 'wb') as f:
        f.write(excel_bytes)
```

## Фильтры

Отчет поддерживает следующие фильтры:

- **object_id** - ID объекта строительства
- **estimate_id** - ID сметы
- **work_id** - ID вида работ
- **executor_id** - ID исполнителя (бригадира)

Все фильтры опциональны. Если фильтр не указан, в отчет попадают все данные.

## Источник данных

Отчет формируется на основе данных из регистра **work_execution_register**:

- **План** - записи с `quantity_income > 0` (приход из смет)
- **Факт** - записи с `quantity_expense > 0` (расход из ежедневных отчетов)
- **Исполнители** - определяются из связанных ежедневных отчетов через поле `foreman_id`

## Формат файла

- **Формат**: Excel (.xlsx)
- **Лист**: "Отчёт по проекту"
- **Стили**:
  - Заголовки - жирный шрифт, голубой фон
  - Итоговая строка - жирный шрифт, жёлтый фон
  - Числовые значения - формат с двумя знаками после запятой
  - Проценты - формат с двумя знаками и символом %

## Примеры использования

### Отчет по всем работам за период

```python
generator = ExcelBrigadePieceworkReport()
excel_bytes = generator.generate('2025-01-01', '2025-12-31')
```

### Отчет по конкретному объекту

```python
excel_bytes = generator.generate(
    '2025-01-01', 
    '2025-12-31',
    filters={'object_id': 1}
)
```

### Отчет по конкретному исполнителю

```python
excel_bytes = generator.generate(
    '2025-01-01', 
    '2025-12-31',
    filters={'executor_id': 3}
)
```

### Отчет по смете и исполнителю

```python
excel_bytes = generator.generate(
    '2025-01-01', 
    '2025-12-31',
    filters={
        'estimate_id': 5,
        'executor_id': 3
    }
)
```

## Тестирование

Для тестирования отчета используйте скрипт:

```bash
python test_brigade_piecework_report.py
```

Скрипт создаст несколько тестовых файлов:
- `test_brigade_piecework_YYYY-MM-DD_YYYY-MM-DD.xlsx` - без фильтров
- `test_brigade_piecework_object_YYYY-MM-DD_YYYY-MM-DD.xlsx` - с фильтром по объекту
- `test_brigade_piecework_executor_YYYY-MM-DD_YYYY-MM-DD.xlsx` - с фильтром по исполнителю

## Технические детали

### Файлы

- **Сервис**: `src/services/excel_brigade_piecework_report.py`
- **Форма**: `src/views/work_execution_report_form.py` (добавлена кнопка)
- **Тест**: `test_brigade_piecework_report.py`
- **Шаблон**: `Сдельная форма по бриагаде.xlsx` (исходный файл)

### Зависимости

- `openpyxl` - для работы с Excel
- `ExcelPrintFormGenerator` - базовый класс для генерации Excel отчетов
- `DatabaseManager` - для работы с базой данных

### Производительность

Отчет оптимизирован для работы с большими объемами данных:
- Используются индексированные запросы к БД
- Данные группируются на уровне SQL
- Минимальное количество обращений к БД

## Известные ограничения

1. Отчет показывает только те работы, по которым есть плановые данные (записи в сметах)
2. Исполнитель определяется из ежедневных отчетов (поле `foreman_id`)
3. Цена работы берется из первой найденной строки сметы для данной работы
4. Динамические колонки создаются только для дат, в которые были выполнены работы

## Будущие улучшения

- [ ] Добавить группировку по бригадам
- [ ] Добавить фильтр по нескольким исполнителям
- [ ] Добавить возможность выбора отображаемых колонок
- [ ] Добавить графики выполнения работ
- [ ] Добавить экспорт в PDF
