# Диаграмма работы фильтрации смет в табеле

## До исправления (проблемная логика)

```
┌─────────────────────────────────────────────────────────────┐
│ Форма табеля                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Загрузка ВСЕ сметы (10000 записей)                     │
│     ↓                                                       │
│     estimatesData = [Смета1, Смета2, ..., СметаN]          │
│                                                             │
│  2. Пользователь выбирает Объект 5                         │
│     ↓                                                       │
│     filteredEstimates = filter(object_id === 5)            │
│     ↓                                                       │
│     Результат: [] (пусто)                                  │
│                                                             │
│  3. ❌ ПРОБЛЕМА: Fallback механизм                         │
│     ↓                                                       │
│     if (filtered.length === 0) {                           │
│       return ALL estimates with object names               │
│     }                                                       │
│     ↓                                                       │
│     Показываются ВСЕ сметы:                                │
│     - "295 от 19.11.2025 (Торговый центр)"                 │
│     - "TEST-001 от 20.11.2025 (Жилой комплекс)"            │
│     - ...                                                   │
│                                                             │
│  4. ❌ Пользователь в замешательстве:                      │
│     - Работает ли фильтр?                                  │
│     - Почему показываются сметы других объектов?           │
│     - Можно ли их выбрать?                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## После исправления (правильная логика)

```
┌─────────────────────────────────────────────────────────────┐
│ Форма табеля                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Загрузка ВСЕ сметы (10000 записей)                     │
│     ↓                                                       │
│     estimatesData = [Смета1, Смета2, ..., СметаN]          │
│                                                             │
│  2. Пользователь выбирает Объект 5                         │
│     ↓                                                       │
│     filteredEstimates = filter(object_id === 5)            │
│     ↓                                                       │
│     Результат: [] (пусто)                                  │
│                                                             │
│  3. ✅ РЕШЕНИЕ: Четкая обратная связь                      │
│     ↓                                                       │
│     estimatesForPicker = filteredEstimates                 │
│     ↓                                                       │
│     placeholder = "Нет смет для выбранного объекта"        │
│     ↓                                                       │
│     Показывается:                                          │
│     ┌─────────────────────────────────────────┐            │
│     │ Смета *                                 │            │
│     │ ┌─────────────────────────────────────┐ │            │
│     │ │ Нет смет для выбранного объекта   ▼ │ │            │
│     │ └─────────────────────────────────────┘ │            │
│     │ ⚠️ Для выбранного объекта нет смет.    │            │
│     │    Создайте смету в разделе            │            │
│     │    "Документы → Сметы".                │            │
│     └─────────────────────────────────────────┘            │
│                                                             │
│  4. ✅ Пользователь понимает:                              │
│     - Фильтр работает корректно                            │
│     - Для этого объекта нет смет                           │
│     - Нужно создать смету                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Сравнение сценариев

### Сценарий A: Объект БЕЗ смет (Object 5)

#### ДО:
```
┌──────────────────────────────────┐
│ Объект: Object 5                 │
│ ┌──────────────────────────────┐ │
│ │ Object 5                   ▼ │ │
│ └──────────────────────────────┘ │
│                                  │
│ Смета:                           │
│ ┌──────────────────────────────┐ │
│ │ Выберите...              ▼ │ │  ← Открывается список
│ └──────────────────────────────┘ │
│   ↓ Клик                         │
│ ┌──────────────────────────────┐ │
│ │ 295 от 19.11 (Торговый...)   │ │  ← ❌ Показываются
│ │ 295 от 20.11 (Торговый...)   │ │     ВСЕ сметы!
│ │ TEST-001 от 20.11 (Жилой...) │ │
│ │ TEST-GROUPS от 20.11 (Жил..) │ │
│ └──────────────────────────────┘ │
└──────────────────────────────────┘
```

#### ПОСЛЕ:
```
┌──────────────────────────────────┐
│ Объект: Object 5                 │
│ ┌──────────────────────────────┐ │
│ │ Object 5                   ▼ │ │
│ └──────────────────────────────┘ │
│                                  │
│ Смета:                           │
│ ┌──────────────────────────────┐ │
│ │ Нет смет для выбранного... ▼ │ │  ← ✅ Четкое сообщение
│ └──────────────────────────────┘ │
│ ⚠️ Для выбранного объекта нет   │  ← ✅ Инструкция
│    смет. Создайте смету в       │
│    разделе "Документы → Сметы". │
└──────────────────────────────────┘
```

### Сценарий B: Объект СО сметами (Object 1)

#### ДО и ПОСЛЕ (одинаково):
```
┌──────────────────────────────────┐
│ Объект: Object 1                 │
│ ┌──────────────────────────────┐ │
│ │ Object 1                   ▼ │ │
│ └──────────────────────────────┘ │
│                                  │
│ Смета:                           │
│ ┌──────────────────────────────┐ │
│ │ Выберите смету (доступно: 4)▼│ │  ← ✅ Показывает количество
│ └──────────────────────────────┘ │
│   ↓ Клик                         │
│ ┌──────────────────────────────┐ │
│ │ TEST-001 от 30.11.2025       │ │  ← ✅ Только сметы
│ │ TEST-001 от 30.11.2025       │ │     для Object 1
│ │ TEST-001-UPDATED от 30.11... │ │
│ │ TEST-002 от 30.11.2025       │ │
│ └──────────────────────────────┘ │
└──────────────────────────────────┘
```

### Сценарий C: Объект НЕ выбран

#### ДО:
```
┌──────────────────────────────────┐
│ Объект:                          │
│ ┌──────────────────────────────┐ │
│ │ Выберите...                ▼ │ │
│ └──────────────────────────────┘ │
│                                  │
│ Смета:                           │
│ ┌──────────────────────────────┐ │
│ │ Выберите...              ▼ │ │  ← ❌ Активен
│ └──────────────────────────────┘ │
│   ↓ Клик                         │
│ ┌──────────────────────────────┐ │
│ │ 295 от 19.11.2025            │ │  ← ❌ Показываются
│ │ 295 от 20.11.2025            │ │     ВСЕ сметы
│ │ TEST-001 от 20.11.2025       │ │
│ │ ...                          │ │
│ └──────────────────────────────┘ │
└──────────────────────────────────┘
```

#### ПОСЛЕ:
```
┌──────────────────────────────────┐
│ Объект:                          │
│ ┌──────────────────────────────┐ │
│ │ Выберите...                ▼ │ │
│ └──────────────────────────────┘ │
│                                  │
│ Смета:                           │
│ ┌──────────────────────────────┐ │
│ │ Сначала выберите объект    ▼ │ │  ← ✅ Отключен
│ └──────────────────────────────┘ │
│   (disabled)                     │
└──────────────────────────────────┘
```

## Блок-схема логики фильтрации

```
                    ┌─────────────────┐
                    │ Форма табеля    │
                    │ открыта         │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ Загрузить все   │
                    │ сметы из API    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ Объект выбран?  │
                    └────┬───────┬────┘
                         │       │
                    НЕТ  │       │  ДА
                         │       │
                         ▼       ▼
              ┌──────────────┐  ┌──────────────────┐
              │ Placeholder: │  │ Фильтровать      │
              │ "Сначала     │  │ сметы по         │
              │ выберите     │  │ object_id        │
              │ объект"      │  └────────┬─────────┘
              │              │           │
              │ Picker       │           ▼
              │ disabled     │  ┌──────────────────┐
              └──────────────┘  │ Есть сметы?      │
                                └────┬───────┬─────┘
                                     │       │
                                НЕТ  │       │  ДА
                                     │       │
                                     ▼       ▼
                          ┌──────────────┐  ┌──────────────┐
                          │ Placeholder: │  │ Placeholder: │
                          │ "Нет смет    │  │ "Выберите    │
                          │ для объекта" │  │ смету        │
                          │              │  │ (доступно:N)"│
                          │ Показать     │  │              │
                          │ предупреждение│ │ Показать     │
                          │              │  │ список смет  │
                          └──────────────┘  └──────────────┘
```

## Состояния компонента Picker

```
┌─────────────────────────────────────────────────────────────┐
│ Состояние 1: Объект не выбран                               │
├─────────────────────────────────────────────────────────────┤
│ disabled: true                                              │
│ placeholder: "Сначала выберите объект"                      │
│ items: []                                                   │
│ warning: нет                                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ Состояние 2: Объект выбран, смет нет                        │
├─────────────────────────────────────────────────────────────┤
│ disabled: false                                             │
│ placeholder: "Нет смет для выбранного объекта"              │
│ items: []                                                   │
│ warning: "⚠️ Для выбранного объекта нет смет..."            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ Состояние 3: Объект выбран, есть сметы                      │
├─────────────────────────────────────────────────────────────┤
│ disabled: false                                             │
│ placeholder: "Выберите смету (доступно: N)"                 │
│ items: [Смета1, Смета2, ..., СметаN]                        │
│ warning: нет                                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ Состояние 4: Документ проведен                              │
├─────────────────────────────────────────────────────────────┤
│ disabled: true                                              │
│ placeholder: (текущее значение)                             │
│ items: (текущий список)                                     │
│ warning: нет                                                │
└─────────────────────────────────────────────────────────────┘
```

## Поток данных

```
┌──────────────┐
│   Backend    │
│   API        │
└──────┬───────┘
       │
       │ GET /documents/estimates?page_size=10000
       │
       ▼
┌──────────────────────────────────────────┐
│ estimatesData.value                      │
│ [                                        │
│   { id: 1, object_id: 4, number: "295" },│
│   { id: 2, object_id: 4, number: "295" },│
│   { id: 6, object_id: 3, number: "..." },│
│   ...                                    │
│ ]                                        │
└──────────────┬───────────────────────────┘
               │
               │ computed: filteredEstimates
               │ filter(e => e.object_id === formData.object_id)
               │
               ▼
┌──────────────────────────────────────────┐
│ filteredEstimates.value                  │
│ [                                        │
│   { id: 158, name: "TEST-001 от ..." }, │
│   { id: 159, name: "TEST-001 от ..." }, │
│   { id: 160, name: "TEST-001-UP..." },  │
│   { id: 162, name: "TEST-002 от ..." }  │
│ ]                                        │
└──────────────┬───────────────────────────┘
               │
               │ computed: estimatesForPicker
               │ return filteredEstimates
               │
               ▼
┌──────────────────────────────────────────┐
│ estimatesForPicker.value                 │
│ (передается в Picker component)          │
└──────────────────────────────────────────┘
               │
               │ computed: estimatePickerPlaceholder
               │ if (!object_id) return "Сначала..."
               │ if (length === 0) return "Нет смет..."
               │ return "Выберите смету (N)"
               │
               ▼
┌──────────────────────────────────────────┐
│ <Picker                                  │
│   :items="estimatesForPicker"            │
│   :placeholder="estimatePickerPlaceholder"│
│   :disabled="!object_id || is_posted"    │
│ />                                       │
└──────────────────────────────────────────┘
```
