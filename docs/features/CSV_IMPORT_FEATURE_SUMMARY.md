# Функция импорта работ из CSV - Сводка изменений

## Обзор

Добавлена функция импорта работ из CSV файлов с поддержкой:
- Веб-интерфейса (графический импорт)
- Командной строки (автоматизация)

## Созданные файлы

### Backend (API)

1. **api/endpoints/references.py** (дополнен)
   - Добавлен endpoint `POST /api/references/works/import-csv`
   - Поддержка загрузки CSV файлов
   - Парсинг цен и единиц измерения
   - Автоматическое создание групп работ
   - Обработка ошибок и отчет о результатах

### Frontend (Web)

2. **web-client/src/api/references.ts** (дополнен)
   - Добавлена функция `importWorksFromCSV()`
   - Типы `ImportWorksResult`
   - Поддержка FormData для загрузки файлов

3. **web-client/src/views/references/WorksView.vue** (дополнен)
   - Кнопка "Импорт CSV" в интерфейсе
   - Модальное окно импорта
   - Выбор файла
   - Выбор родительской группы
   - Опция пропуска существующих работ
   - Отображение результатов импорта

### CLI Tools

4. **import_works_from_csv.py**
   - Скрипт импорта для командной строки
   - Парсинг CSV с разделителем ";"
   - Автоматическая группировка работ
   - Обработка цен и единиц измерения

5. **import_works.bat**
   - Batch-файл для удобного запуска импорта
   - Автоматическая активация виртуального окружения

6. **view_works.py**
   - Просмотр импортированных работ
   - Отображение групп и работ
   - Статистика

7. **view_works.bat**
   - Batch-файл для просмотра работ

8. **clean_duplicate_works.py**
   - Поиск и удаление дубликатов
   - Режим просмотра и удаления

### Документация

9. **ИМПОРТ_РАБОТ_ИНСТРУКЦИЯ.md**
   - Полная инструкция по импорту
   - Описание формата CSV
   - Примеры использования

10. **ИМПОРТ_РАБОТ_ВЕБ.md**
    - Краткая инструкция для веб-интерфейса
    - Быстрый старт

11. **WEB_IMPORT_WORKS_GUIDE.md**
    - Подробное руководство по веб-импорту
    - Примеры и советы

### Тестовые файлы

12. **test_import.csv**
    - Пример CSV файла для тестирования

13. **умелец.csv** (уже существовал)
    - Реальный пример с 228 работами

## Функциональность

### Веб-интерфейс

**Расположение**: Справочники → Работы → Кнопка "Импорт CSV"

**Возможности**:
- Загрузка CSV файла через drag-and-drop или выбор
- Выбор родительской группы для импорта
- Опция пропуска существующих работ
- Отображение прогресса и результатов
- Автоматическое обновление таблицы после импорта

**Параметры**:
- `file` - CSV файл
- `parent_id` - ID родительской группы (опционально)
- `skip_existing` - пропускать существующие работы (по умолчанию true)

### Командная строка

**Использование**:
```bash
# Импорт с пропуском существующих
import_works.bat умелец.csv

# Импорт с обновлением существующих
import_works.bat умелец.csv --update

# Просмотр групп
view_works.bat

# Просмотр работ группы
view_works.bat "Электромонтажные работы"

# Поиск дубликатов
python clean_duplicate_works.py

# Удаление дубликатов
python clean_duplicate_works.py --delete
```

## Формат CSV

```csv
Тип работ;Наименование работы;Цена;Единица измерения
Электромонтажные работы;монтаж розетки (220 В);500;руб.
Электромонтажные работы;монтаж выключателя (220 В);500;руб.
Сантехнические работы;установка унитаза;1500;руб.
```

**Требования**:
- Разделитель: точка с запятой (;)
- Кодировка: UTF-8
- Первая строка - заголовки

**Колонки**:
- **Тип работ** - группа (опционально)
- **Наименование работы** - название (обязательно)
- **Цена** - стоимость (автоматический парсинг)
- **Единица измерения** - ед.изм. (автоматическая очистка)

## Логика работы

### Группировка

1. **Без родительской группы**:
   - Если указан "Тип работ", создается/используется группа с этим именем
   - Работы добавляются как дочерние элементы группы

2. **С родительской группой**:
   - Все работы добавляются в указанную группу
   - Поле "Тип работ" игнорируется

### Обработка существующих работ

1. **Пропуск (по умолчанию)**:
   - Проверка по имени и parent_id
   - Существующие работы не изменяются

2. **Обновление**:
   - Существующие работы обновляются
   - Может создать дубликаты при изменении структуры

### Парсинг данных

**Цена**:
- "500 руб." → 500.0
- "1,500.50" → 1500.5
- "бесплатно" → 0.0

**Единица измерения**:
- "руб/м2" → "м2"
- "руб./пог.м" → "пог.м"
- "руб." → ""

## API Endpoint

```
POST /api/references/works/import-csv
```

**Query Parameters**:
- `parent_id` (optional) - ID родительской группы
- `skip_existing` (optional, default: true) - пропускать существующие

**Request Body**:
- `file` - CSV файл (multipart/form-data)

**Response**:
```json
{
  "success": true,
  "message": "Import completed: 10 added, 5 skipped",
  "added": 10,
  "skipped": 5,
  "errors": ["Строка 15: Пустое наименование работы"]
}
```

## Тестирование

### Ручное тестирование

1. Запустите API сервер:
   ```bash
   start_api.bat
   ```

2. Запустите веб-клиент:
   ```bash
   cd web-client
   npm run dev
   ```

3. Откройте браузер: http://localhost:5173

4. Перейдите в Справочники → Работы

5. Нажмите "Импорт CSV" и выберите `test_import.csv`

### CLI тестирование

```bash
# Импорт тестового файла
import_works.bat test_import.csv

# Просмотр результата
view_works.bat "Тестовые работы"
```

## Безопасность

- Требуется авторизация (JWT token)
- Проверка типа файла (.csv)
- Проверка кодировки (UTF-8)
- Обработка ошибок парсинга
- Транзакции БД для целостности данных

## Производительность

- Пакетная обработка строк
- Кэширование групп работ
- Минимальные запросы к БД
- Обработка больших файлов (протестировано на 228 работах)

## Известные ограничения

1. Размер файла ограничен настройками FastAPI (по умолчанию ~16MB)
2. Только формат CSV с разделителем ";"
3. Только кодировка UTF-8
4. Обновление существующих работ может создать дубликаты

## Будущие улучшения

- [ ] Поддержка других разделителей (запятая, табуляция)
- [ ] Автоопределение кодировки
- [ ] Предпросмотр перед импортом
- [ ] Импорт с маппингом колонок
- [ ] Экспорт работ в CSV
- [ ] История импортов
- [ ] Откат импорта
