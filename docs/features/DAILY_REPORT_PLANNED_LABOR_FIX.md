# Исправление: Преобразование "План.труд" к числу в ежедневных отчетах

## Проблема
В табличной части ежедневных отчетов поле "План.труд" (planned_labor) могло содержать нечисловые значения, что приводило к невозможности расчета отклонений.

## Решение
Добавлено явное преобразование к числу (float) с обработкой ошибок во всех местах, где используется `planned_labor`:

### 1. Desktop приложение (PyQt6)

**Файл:** `src/views/daily_report_document_form.py`

- **Строка 577-597:** Функция `recalculate_deviations()` - добавлена обработка нечисловых значений при расчете отклонений
- **Строка 640-658:** Функция `on_save()` - добавлена обработка при сохранении данных

**Файл:** `src/services/daily_report_service.py`

- **Строка 48-68:** Функция `load()` - добавлено преобразование при загрузке из БД
- **Строка 268-278:** Функция `fill_from_estimate()` - добавлено преобразование при заполнении из сметы

### 2. Web-клиент (Vue.js)

**Файл:** `web-client/src/components/documents/DailyReportLines.vue`

- **Строка 159-171:** Функция `handleLineChange()` - добавлено преобразование и правильный расчет отклонения в процентах

**Файл:** `web-client/src/views/documents/DailyReportFormView.vue`

- **Строка 191-203:** Функция `handleEstimateChange()` - добавлено преобразование при автозаполнении из сметы

### 3. API (FastAPI)

**Файл:** `api/models/documents.py`

- **Строка 105-113:** Класс `DailyReportLineBase` - добавлен валидатор `convert_to_float()` для полей `planned_labor`, `actual_labor`, `deviation_percent`

**Файл:** `api/endpoints/documents.py`

- **Строка 503-505:** Функция `get_daily_report_lines_with_joins()` - добавлен маппинг `deviation_percent` → `deviation` для совместимости с фронтендом

## Логика преобразования

```python
# Преобразование с обработкой ошибок
try:
    planned_labor = float(value) if value else 0.0
except (ValueError, TypeError):
    planned_labor = 0.0
```

## Расчет отклонения

Отклонение рассчитывается как процент:

```python
if planned_labor > 0:
    deviation = ((actual_labor - planned_labor) / planned_labor) * 100
else:
    deviation = 0.0
```

## Тестирование

Создан тестовый скрипт `test_daily_report_conversion.py` для проверки корректности преобразования различных типов данных.

## Результат

Теперь поле "План.труд" всегда преобразуется к числу, что позволяет корректно рассчитывать отклонения в ежедневных отчетах независимо от источника данных.

## Как проверить исправление

### Desktop приложение:
1. Откройте существующий ежедневный отчет или создайте новый
2. Заполните из сметы
3. Введите фактические трудозатраты в любую строку
4. Отклонение должно автоматически пересчитаться в процентах

### Web-клиент:
1. Откройте `/documents/daily-reports/new`
2. Выберите смету - строки заполнятся автоматически с отклонением -100%
3. Введите фактические трудозатраты
4. Отклонение должно пересчитаться в реальном времени
5. При сохранении и повторном открытии отклонения должны отображаться корректно

### Формула расчета:
- Если план > 0: `отклонение = ((факт - план) / план) * 100`
- Если план = 0: `отклонение = 0`

### Примеры:
- План: 10, Факт: 12 → Отклонение: +20%
- План: 10, Факт: 8 → Отклонение: -20%
- План: 10, Факт: 0 → Отклонение: -100%
