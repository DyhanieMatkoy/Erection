# Отчет "Выполнение работ" - Двухуровневая группировка

## Обзор

В отчет "Выполнение работ" добавлена поддержка **2 вложенных группировок**, что позволяет анализировать данные в иерархической структуре.

## Новые возможности

### 1. Двухуровневая группировка

Теперь можно выбрать две независимые группировки:
- **Группировка 1** - первый уровень иерархии (основная группировка)
- **Группировка 2** - второй уровень иерархии (детализация внутри групп первого уровня)

### 2. Доступные варианты группировки

Каждая группировка может быть:
- **Без группировки** - не применять группировку на этом уровне
- **По объектам** - группировка по объектам строительства
- **По сметам** - группировка по сметам
- **По работам** - группировка по видам работ
- **По датам** - группировка по периодам выполнения

### 3. Визуальное представление

#### Группы первого уровня:
- Отображаются **жирным шрифтом**
- Имеют **голубой фон** (RGB: 230, 240, 255)
- Показывают **итоговые значения** по всем вложенным элементам

#### Элементы второго уровня:
- Отображаются с **отступом** (2 пробела)
- Обычный шрифт и фон
- Показывают **детальные данные** по каждому элементу группы

## Примеры использования

### Пример 1: По объектам → По сметам
```
Объект "Жилой дом №1"          [итоги по объекту]
  Смета №1 от 01.01.2024       [детали сметы]
  Смета №2 от 15.01.2024       [детали сметы]
Объект "Торговый центр"        [итоги по объекту]
  Смета №3 от 20.01.2024       [детали сметы]
```

### Пример 2: По сметам → По работам
```
Смета №1 от 01.01.2024         [итоги по смете]
  Земляные работы              [детали работы]
  Бетонные работы              [детали работы]
  Кирпичная кладка             [детали работы]
Смета №2 от 15.01.2024         [итоги по смете]
  Штукатурные работы           [детали работы]
```

### Пример 3: По датам → По работам
```
2024-01-15                     [итоги за день]
  Земляные работы              [детали работы]
  Бетонные работы              [детали работы]
2024-01-16                     [итоги за день]
  Кирпичная кладка             [детали работы]
```

## Инструкция по использованию

### Шаг 1: Открыть отчет
Меню → Отчеты → Выполнение работ

### Шаг 2: Настроить параметры
1. **Период** - выберите даты начала и окончания периода
2. **Фильтры** (опционально):
   - Объект - фильтр по конкретному объекту
   - Смета - фильтр по конкретной смете
   - Работа - фильтр по конкретному виду работ

### Шаг 3: Выбрать группировки
1. **Группировка 1** - выберите основную группировку (первый уровень)
2. **Группировка 2** - выберите детализацию (второй уровень)

⚠️ **Важно**: Группировки должны быть разными! Система предупредит, если выбраны одинаковые.

### Шаг 4: Сформировать отчет
Нажмите кнопку **"Сформировать"**

## Отображаемые данные

Для каждой строки отчета показываются:

| Колонка | Описание |
|---------|----------|
| Группировка | Название группы или элемента |
| План кол-во | Плановое количество работ |
| Факт кол-во | Фактическое количество выполненных работ |
| Остаток кол-во | Остаток к выполнению (План - Факт) |
| План сумма | Плановая стоимость работ |
| Факт сумма | Фактическая стоимость выполненных работ |
| Остаток сумма | Остаток стоимости (План - Факт) |
| % выполнения | Процент выполнения (Факт / План × 100%) |

## Рекомендуемые комбинации группировок

### Для анализа по объектам:
- **Объекты → Сметы** - какие сметы выполняются на каждом объекте
- **Объекты → Работы** - какие работы выполняются на каждом объекте
- **Объекты → Даты** - динамика выполнения по каждому объекту

### Для анализа по сметам:
- **Сметы → Работы** - детализация работ в каждой смете
- **Сметы → Даты** - динамика выполнения каждой сметы
- **Сметы → Объекты** - на каких объектах используется смета

### Для анализа по времени:
- **Даты → Объекты** - какие объекты работали в каждый день
- **Даты → Работы** - какие работы выполнялись в каждый день
- **Даты → Сметы** - какие сметы выполнялись в каждый день

### Для анализа по работам:
- **Работы → Объекты** - на каких объектах выполняется каждая работа
- **Работы → Сметы** - в каких сметах используется каждая работа
- **Работы → Даты** - когда выполнялась каждая работа

## Технические детали

### Изменения в коде

#### 1. Форма отчета (`work_execution_report_form.py`)
- Добавлены два комбобокса: `grouping1_combo` и `grouping2_combo`
- Реализована валидация на одинаковые группировки
- Добавлен метод `_fill_table_hierarchical()` для иерархического отображения
- Добавлен метод `_fill_table_flat()` для плоского отображения
- Добавлены вспомогательные методы `_get_group_key()` и `_get_group_name()`

#### 2. Репозиторий регистра (`work_execution_register_repository.py`)
- Метод `get_turnovers()` уже поддерживает множественную группировку
- Принимает список группировок: `grouping: List[str]`
- Автоматически строит SQL с нужными GROUP BY

### Алгоритм построения иерархии

1. Получить данные с двумя группировками из БД
2. Сгруппировать данные по первому уровню в памяти
3. Для каждой группы первого уровня:
   - Вычислить итоговые значения
   - Отобразить строку группы (жирным, с фоном)
   - Отобразить все вложенные строки (с отступом)

## Тестирование

Запустите тестовый скрипт:
```bash
python test_work_execution_report_grouping.py
```

Скрипт откроет форму отчета и выведет инструкции по тестированию.

## Ограничения

1. **Максимум 2 уровня группировки** - система поддерживает только два уровня иерархии
2. **Группировки должны быть разными** - нельзя выбрать одинаковые группировки на обоих уровнях
3. **Без группировки** - если не выбрана ни одна группировка, данные отображаются плоским списком

## Будущие улучшения

Возможные направления развития:
- Экспорт иерархического отчета в Excel с сохранением форматирования
- Сворачивание/разворачивание групп первого уровня
- Поддержка 3 и более уровней группировки
- Сохранение настроек группировки для быстрого доступа
- Графическое представление данных (диаграммы, графики)

## Связанные файлы

- `src/views/work_execution_report_form.py` - форма отчета
- `src/data/repositories/work_execution_register_repository.py` - репозиторий данных
- `test_work_execution_report_grouping.py` - тестовый скрипт
