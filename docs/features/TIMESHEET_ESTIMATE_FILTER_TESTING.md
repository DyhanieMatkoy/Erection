# Инструкция по тестированию исправления фильтрации смет

## Подготовка к тестированию

### 1. Проверить данные в базе

```bash
# Проверить сметы по объектам
python -c "import sqlite3; conn = sqlite3.connect('construction.db'); cursor = conn.cursor(); cursor.execute('SELECT object_id, COUNT(*) as count FROM estimates WHERE marked_for_deletion = 0 GROUP BY object_id ORDER BY object_id'); rows = cursor.fetchall(); print('Estimates by Object:'); [print(f'Object {r[0]}: {r[1]} estimates') for r in rows]; conn.close()"
```

**Ожидаемый результат:**
```
Estimates by Object:
Object 1: 4 estimates
Object 3: 2 estimates
Object 4: 2 estimates
```

### 2. Запустить приложение

```bash
# Запустить API
cd api
python -m uvicorn main:app --reload

# Запустить веб-клиент (в другом терминале)
cd web-client
npm run dev
```

### 3. Войти в систему

- URL: http://localhost:5173
- Логин: `admin`
- Пароль: `admin`

## Тестовые сценарии

### ✅ Тест 1: Объект без смет

**Цель:** Проверить, что для объекта без смет показывается корректное сообщение

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. Заполнить поля:
   - Номер: `TEST-TAB-001`
   - Дата: текущая дата
4. В поле "Объект" выбрать любой объект с ID > 4 (например, "Test Object")
5. Посмотреть на поле "Смета"

**Ожидаемый результат:**
- ✅ Поле "Смета" показывает: `"Нет смет для выбранного объекта"`
- ✅ Под полем отображается предупреждение: `"⚠️ Для выбранного объекта нет смет. Создайте смету в разделе "Документы → Сметы"."`
- ✅ Поле "Смета" активно (можно кликнуть)
- ✅ При клике на поле открывается пустой список с сообщением "Ничего не найдено"

**Скриншот:**
```
┌─────────────────────────────────────┐
│ Объект: Test Object              ▼ │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ Смета: Нет смет для выбранного... ▼ │
└─────────────────────────────────────┘
⚠️ Для выбранного объекта нет смет.
   Создайте смету в разделе "Документы → Сметы".
```

---

### ✅ Тест 2: Объект со сметами (Object 1)

**Цель:** Проверить, что для объекта со сметами показывается корректный список

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. Заполнить поля:
   - Номер: `TEST-TAB-002`
   - Дата: текущая дата
4. В поле "Объект" найти и выбрать объект с ID = 1
5. Посмотреть на поле "Смета"
6. Кликнуть на поле "Смета"

**Ожидаемый результат:**
- ✅ Поле "Смета" показывает: `"Выберите смету (доступно: 4)"`
- ✅ Предупреждение НЕ отображается
- ✅ При клике открывается список из 4 смет:
  - TEST-001 от 30.11.2025
  - TEST-001 от 30.11.2025
  - TEST-001-UPDATED от 30.11.2025
  - TEST-002 от 30.11.2025
- ✅ Можно выбрать любую смету

**Скриншот:**
```
┌─────────────────────────────────────┐
│ Объект: [Object 1]               ▼ │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ Смета: Выберите смету (доступно: 4)▼│
└─────────────────────────────────────┘
  ↓ Клик
┌─────────────────────────────────────┐
│ TEST-001 от 30.11.2025              │
│ TEST-001 от 30.11.2025              │
│ TEST-001-UPDATED от 30.11.2025      │
│ TEST-002 от 30.11.2025              │
└─────────────────────────────────────┘
```

---

### ✅ Тест 3: Объект со сметами (Object 3)

**Цель:** Проверить фильтрацию для другого объекта

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. В поле "Объект" выбрать "Жилой комплекс "Солнечный"" (Object 3)
4. Посмотреть на поле "Смета"
5. Кликнуть на поле "Смета"

**Ожидаемый результат:**
- ✅ Поле "Смета" показывает: `"Выберите смету (доступно: 2)"`
- ✅ При клике открывается список из 2 смет:
  - TEST-001 от 20.11.2025
  - TEST-GROUPS от 20.11.2025
- ✅ НЕ показываются сметы от других объектов

---

### ✅ Тест 4: Без выбранного объекта

**Цель:** Проверить, что поле "Смета" отключено до выбора объекта

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. НЕ выбирать объект
4. Посмотреть на поле "Смета"
5. Попытаться кликнуть на поле "Смета"

**Ожидаемый результат:**
- ✅ Поле "Смета" показывает: `"Сначала выберите объект"`
- ✅ Поле "Смета" отключено (серый фон, курсор not-allowed)
- ✅ Клик не открывает список
- ✅ Предупреждение НЕ отображается

**Скриншот:**
```
┌─────────────────────────────────────┐
│ Объект: Выберите...              ▼ │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ Смета: Сначала выберите объект   ▼ │  (disabled)
└─────────────────────────────────────┘
```

---

### ✅ Тест 5: Смена объекта (со смет на без смет)

**Цель:** Проверить, что при смене объекта выбранная смета сбрасывается

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. Выбрать "Объект" = Object 1 (4 сметы)
4. Выбрать "Смета" = TEST-001
5. Сменить "Объект" на Test Object (0 смет)
6. Посмотреть на поле "Смета"

**Ожидаемый результат:**
- ✅ Поле "Смета" очищается (estimate_id = 0)
- ✅ Показывается: `"Нет смет для выбранного объекта"`
- ✅ Отображается предупреждение
- ✅ Выбранная ранее смета НЕ сохраняется

---

### ✅ Тест 6: Смена объекта (без смет на со сметами)

**Цель:** Проверить переход от объекта без смет к объекту со сметами

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. Выбрать "Объект" = Test Object (0 смет)
4. Убедиться, что показывается предупреждение
5. Сменить "Объект" на Object 1 (4 сметы)
6. Посмотреть на поле "Смета"

**Ожидаемый результат:**
- ✅ Предупреждение исчезает
- ✅ Показывается: `"Выберите смету (доступно: 4)"`
- ✅ Можно выбрать смету из списка

---

### ✅ Тест 7: Смена объекта (между объектами со сметами)

**Цель:** Проверить, что сметы фильтруются корректно при смене объекта

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. Выбрать "Объект" = Object 1 (4 сметы)
4. Кликнуть на "Смета" и запомнить список
5. Сменить "Объект" на Object 3 (2 сметы)
6. Кликнуть на "Смета" и сравнить список

**Ожидаемый результат:**
- ✅ Для Object 1 показываются 4 сметы (TEST-001, TEST-001, TEST-001-UPDATED, TEST-002)
- ✅ Для Object 3 показываются 2 сметы (TEST-001, TEST-GROUPS)
- ✅ Списки НЕ пересекаются
- ✅ Счетчик обновляется: "доступно: 4" → "доступно: 2"

---

### ✅ Тест 8: Редактирование существующего табеля

**Цель:** Проверить, что фильтрация работает при редактировании

**Шаги:**
1. Создать табель с Object 1 и сметой TEST-001
2. Сохранить
3. Открыть для редактирования
4. Посмотреть на поле "Смета"

**Ожидаемый результат:**
- ✅ Показывается выбранная смета: "TEST-001 от 30.11.2025"
- ✅ При клике показываются только сметы для Object 1
- ✅ Можно сменить смету на другую из того же объекта

---

### ✅ Тест 9: Проведенный табель

**Цель:** Проверить, что поля отключены для проведенного документа

**Шаги:**
1. Создать табель с Object 1 и сметой TEST-001
2. Сохранить
3. Провести документ (кнопка "Провести")
4. Посмотреть на поля "Объект" и "Смета"

**Ожидаемый результат:**
- ✅ Поле "Объект" отключено
- ✅ Поле "Смета" отключено
- ✅ Показывается бейдж "Проведен"
- ✅ Нельзя изменить объект или смету

---

### ✅ Тест 10: Поиск в списке смет

**Цель:** Проверить, что поиск работает в Picker компоненте

**Шаги:**
1. Перейти в "Документы → Табели"
2. Нажать "Создать"
3. Выбрать "Объект" = Object 1 (4 сметы)
4. Кликнуть на поле "Смета"
5. В поле поиска ввести "UPDATED"

**Ожидаемый результат:**
- ✅ Список фильтруется
- ✅ Показывается только "TEST-001-UPDATED от 30.11.2025"
- ✅ Остальные сметы скрыты

---

## Проверка консоли браузера

### Ожидаемые логи:

```javascript
// При монтировании компонента
Loaded 8 estimates

// При выборе объекта (не должно быть ошибок)
// Никаких дополнительных логов
```

### НЕ должно быть:

- ❌ Ошибок в консоли
- ❌ Предупреждений Vue
- ❌ Ошибок сети (кроме ожидаемых 404)

---

## Проверка сетевых запросов

### При открытии формы:

```
GET /api/references/objects?page_size=1000
GET /api/references/persons?page_size=1000
GET /api/documents/estimates?page=1&page_size=10000
```

### При смене объекта:

- ❌ НЕ должно быть дополнительных запросов к API
- ✅ Фильтрация происходит на клиенте

---

## Регрессионное тестирование

### Проверить, что НЕ сломалось:

1. ✅ Создание табеля с объектом и сметой
2. ✅ Сохранение табеля
3. ✅ Редактирование табеля
4. ✅ Проведение табеля
5. ✅ Отмена проведения табеля
6. ✅ Удаление табеля
7. ✅ Автозаполнение из ежедневных отчетов
8. ✅ Печать табеля

---

## Чек-лист для тестировщика

### Функциональность:
- [ ] Тест 1: Объект без смет - PASSED
- [ ] Тест 2: Объект со сметами (Object 1) - PASSED
- [ ] Тест 3: Объект со сметами (Object 3) - PASSED
- [ ] Тест 4: Без выбранного объекта - PASSED
- [ ] Тест 5: Смена объекта (со смет на без смет) - PASSED
- [ ] Тест 6: Смена объекта (без смет на со сметы) - PASSED
- [ ] Тест 7: Смена объекта (между объектами со сметами) - PASSED
- [ ] Тест 8: Редактирование существующего табеля - PASSED
- [ ] Тест 9: Проведенный табель - PASSED
- [ ] Тест 10: Поиск в списке смет - PASSED

### UI/UX:
- [ ] Placeholder отображается корректно
- [ ] Предупреждение отображается только когда нужно
- [ ] Счетчик смет показывает правильное число
- [ ] Поле отключается когда нужно
- [ ] Цвета и стили соответствуют дизайну

### Производительность:
- [ ] Нет задержек при смене объекта
- [ ] Фильтрация работает мгновенно
- [ ] Нет лишних запросов к API

### Совместимость:
- [ ] Chrome - OK
- [ ] Firefox - OK
- [ ] Edge - OK
- [ ] Safari - OK (если доступен)

---

## Известные ограничения

1. **Загрузка всех смет:** Фронтенд загружает все сметы (page_size: 10000) при открытии формы. Для больших баз данных это может быть медленно.
   - **Решение:** Использовать серверную фильтрацию (см. TIMESHEET_ESTIMATE_FILTER_FIX.md)

2. **Нет кэширования:** При каждом открытии формы сметы загружаются заново.
   - **Решение:** Использовать Pinia store для кэширования

3. **Нет индикатора загрузки:** Пользователь не видит, что сметы загружаются.
   - **Решение:** Добавить skeleton loader или spinner

---

## Отчет о тестировании

### Шаблон:

```markdown
# Отчет о тестировании фильтрации смет в табеле

**Дата:** [дата]
**Тестировщик:** [имя]
**Версия:** [версия приложения]
**Браузер:** [браузер и версия]

## Результаты

### Функциональные тесты:
- Тест 1: ✅ PASSED / ❌ FAILED
- Тест 2: ✅ PASSED / ❌ FAILED
- ...

### Найденные проблемы:
1. [Описание проблемы]
   - Шаги воспроизведения: ...
   - Ожидаемый результат: ...
   - Фактический результат: ...
   - Скриншот: ...

### Общая оценка:
- Критичные баги: [количество]
- Некритичные баги: [количество]
- Улучшения: [количество]

### Рекомендация:
✅ Готово к релизу / ❌ Требуется доработка
```

---

## Контакты для вопросов

Если возникли вопросы по тестированию, обратитесь к:
- Документации: `TIMESHEET_ESTIMATE_FILTER_ANALYSIS.md`
- Описанию исправления: `TIMESHEET_ESTIMATE_FILTER_FIX.md`
- Диаграммам: `TIMESHEET_ESTIMATE_FILTER_DIAGRAM.md`
