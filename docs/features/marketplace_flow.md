# Поток обработки заказов маркетплейса

## Описание процесса

0. Менеджер утром создаёт документ Поставка в УТ11
1. Клиент заказывает товар через Маркетплейс
2. Маркетплейс включает заказы в Поставку на склад, создаёт грузовую марку на поставку
3. Менеджер в УТ11:
   - Получает ЗКС по API маркетплейса, заказ попадает в систему
   - Получает маркировку ЗКС по API маркетплейса
   - Создаёт ЗК (в статусе Принят)
4. УТ11 регистрирует ЗК в плане обмена с УТ10 (в момент записи)
5. УТ10 получает ЗК в статусе Принят и непроведенную РеализациюТоваровУслуг
6. Работник склада меняет статус ЗК на Отгрузка (и проводит РеализациюТоваровУслуг?):
   - Стикер картинкой попадает в связанный справочник ПрикрепленныеФайлыЗаказовКлиентов
   - Номер сборочного задания попадает в типовой реквизит ЗК НомерВходящегоДокумента
7. УТ10 передаёт ЗК в статусе Отгрузка в одну из УТ11 (в зависимости от организации)
   - ЗКС попадают в поставку УТ11 в процессе обмена при смене статуса ЗК
8. Менеджер закрывает поставку в УТ11
9. Менеджер загружает маркировку поставки в УТ11 по API маркетплейса
10. Маркировка поставки передаётся из УТ11 в УТ10 (куда именно?)

## Диаграмма потока

```mermaid
flowchart TD
    Start([Начало дня]) --> Step0[0. Менеджер создаёт документ<br/>Поставка в УТ11]
    Step0 --> Step1[1. Клиент заказывает товар<br/>через Маркетплейс]
    Step1 --> Step2[2. Маркетплейс включает заказы<br/>в Поставку на склад и создаёт<br/>грузовую марку]
    
    Step2 --> Step3a[3a. Менеджер получает ЗКС<br/>по API маркетплейса]
    Step3a --> Step3b[3b. Менеджер получает<br/>маркировку ЗКС по API]
    Step3b --> Step3c[3c. Менеджер создаёт ЗК<br/>в статусе Принят в УТ11]
    
    Step3c --> Step4[4. УТ11 регистрирует ЗК<br/>в плане обмена с УТ10]
    
    Step4 --> Step5[5. УТ10 получает ЗК<br/>в статусе Принят и<br/>непроведенную РеализациюТоваровУслуг]
    
    Step5 --> Step6[6. Работник склада меняет<br/>статус ЗК на Отгрузка]
    Step6 --> Step6a[Стикер → ПрикрепленныеФайлыЗаказовКлиентов<br/>Номер задания → НомерВходящегоДокумента]
    
    Step6a --> Step7[7. УТ10 передаёт ЗК<br/>в статусе Отгрузка в УТ11<br/>по организации]
    Step7 --> Step7a[ЗКС попадают в поставку УТ11]
    
    Step7a --> Step8[8. Менеджер закрывает<br/>поставку в УТ11]
    
    Step8 --> Step9[9. Менеджер загружает<br/>маркировку поставки<br/>по API маркетплейса в УТ11]
    
    Step9 --> Step10[10. Маркировка поставки<br/>передаётся из УТ11 в УТ10<br/>куда именно?]
    
    Step10 --> End([Конец процесса])
    
    style Step0 fill:#e1f5ff
    style Step3c fill:#fff4e1
    style Step6 fill:#ffe1e1
    style Step8 fill:#e1ffe1
    style Step10 fill:#ffe1f5
```

## Системы и роли

- **УТ11** - Управление торговлей (филиал/подразделение)
- **УТ10** - Управление торговлей (центральная система)
- **Маркетплейс** - Внешняя торговая площадка
- **Менеджер** - Обрабатывает заказы в УТ11
- **Работник склада** - Выполняет отгрузку в УТ10

## Вопросы для уточнения

1. На шаге 6: проводится ли РеализациюТоваровУслуг при смене статуса?
2. На шаге 10: куда именно передаётся маркировка поставки в УТ10?
```


## Диаграмма последовательности

```mermaid
sequenceDiagram
    participant Менеджер as Менеджер
    participant MP as Маркетплейс
    participant УТ11 as 1С:УТ11
    participant УТ10 as 1С:УТ10
    participant Склад as Работник склада

    Note over Менеджер,УТ11: 0. Утро - начало рабочего дня
    Менеджер->>УТ11: Создаёт документ Поставка

    Note over MP: 1. Клиент заказывает товар
    
    MP->>MP: 2. Включает заказы в Поставку на склад
    MP->>MP: Создаёт грузовую марку на поставку
    
    MP->>УТ11: 3a. API: Передача ЗКС
    MP->>УТ11: 3b. API: Передача маркировки ЗКС
    
    Note right of УТ11: 3c. Менеджер создаёт<br/>Заказ Клиента (статус: Принят)
    
    УТ11->>УТ11: 4. Регистрирует ЗК в плане обмена с УТ10<br/>(в момент записи)
    
    УТ11->>УТ10: 5. Передача Заказа Клиента
    
    УТ10->>УТ10: Создаёт Заказ Клиента (статус: Принят)
    УТ10->>УТ10: Создаёт непроведенную РеализациюТоваровУслуг
    
    Note right of УТ10: 6. Стикер → ПрикрепленныеФайлыЗаказовКлиентов<br/>Номер сборочного задания → НомерВходящегоДокумента
    
    Склад->>УТ10: Меняет статус заказа на "Отгрузка"
    Склад->>УТ10: Проводит РеализациюТоваровУслуг (?)
    
    УТ10->>УТ11: 7. Передача ЗК (статус: Отгрузка)
    
    Note right of УТ11: Передача в соответствующую УТ11<br/>(в зависимости от организации)<br/>ЗКС попадают в поставку
    
    Менеджер->>УТ11: 8. Закрывает поставку
    
    Менеджер->>MP: 9. API: Загружает маркировку поставки
    MP->>УТ11: API: Возвращает маркировку поставки
    
    УТ11->>УТ10: 10. Передача маркировки поставки
    
    Note right of УТ10: Куда именно попадает<br/>маркировка поставки?
```
