# Реализация функциональности документа Табель

## Обзор выполненных задач

Реализованы все запрошенные функции для работы с документом "Табель учета рабочего времени":

### ✅ 1. Исправление отображения помеченных документов Табель

**Проблема:** Документы Табель не отображались в инструменте "Удаление помеченных объектов"

**Решение:**
- Добавлена таблица `timesheets` в список проверяемых таблиц в `src/views/delete_marked_dialog.py`
- Документы Табель теперь корректно отображаются в диалоге удаления

**Файлы изменены:**
- `src/views/delete_marked_dialog.py` - добавлена строка `("timesheets", "Табель", "number")`

### ✅ 2. Настройка отображения помеченных объектов

**Реализовано:**
- Создан сервис настроек пользователя `UserSettingsService`
- Добавлена таблица `user_settings` в базу данных
- Реализована опция "отображать помеченные на удаление объекты в списке"
- По умолчанию помеченные объекты скрыты (настройка `show_marked_objects = False`)
- Добавлены индивидуальные настройки для каждого типа объектов

**Новые файлы:**
- `src/services/user_settings_service.py` - сервис управления настройками
- `create_user_settings_table.py` - скрипт создания таблицы настроек

**Файлы изменены:**
- `src/views/delete_marked_dialog.py` - добавлен UI настроек и логика фильтрации

### ✅ 3. Экспорт/импорт данных Табеля

**Реализованные форматы:**
- **Excel (.xlsx)** - полная печатная форма с форматированием
- **JSON** - структурированные данные для программного обмена

**Функциональность:**
- Экспорт всех реквизитов документа и табличной части
- Импорт с поиском сотрудников по полю "Наименование" (ФИО)
- Валидация данных при импорте
- Защита от импорта в проведенные документы

**Новые файлы:**
- `src/services/timesheet_export_import_service.py` - основной сервис экспорта/импорта

### ✅ 4. Печатная форма документа Табель

**Реализовано:**
- Полноценная печатная форма в формате Excel
- Содержит все реквизиты документа:
  - Номер и дата документа
  - Период (месяц/год)
  - Объект строительства
  - Смета
  - Прораб
  - Статус проведения
- Табличная часть с данными по дням месяца (1-31)
- Профессиональное форматирование с границами, заливкой заголовков
- Автоматическая настройка ширины колонок

### ✅ 5. Заполнение из Excel формы

**Реализовано:**
- Импорт данных из Excel файла печатной формы
- Поиск сотрудников по полю "Наименование" (ФИО)
- Автоматическое заполнение часов по дням месяца
- Расчет итоговых сумм
- Валидация и обработка ошибок

### ✅ 6. Интеграция в пользовательский интерфейс

**Добавлено в форму Табель:**
- Кнопка "Экспорт в Excel"
- Кнопка "Импорт из Excel" 
- Кнопка "Экспорт в JSON"
- Кнопка "Импорт из JSON"
- Подтверждающие диалоги для безопасности данных

**Файлы изменены:**
- `src/views/timesheet_document_form.py` - добавлены кнопки и методы обработки

## Технические детали

### Структура базы данных

```sql
-- Таблица настроек пользователя
CREATE TABLE user_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
    UNIQUE (user_id, setting_key)
);
```

### Настройки удаления помеченных объектов

```python
# Доступные настройки
settings = {
    'show_marked_objects': False,  # По умолчанию скрыто
    'show_estimates': True,
    'show_daily_reports': True,
    'show_timesheets': True,
    'show_counterparties': True,
    'show_objects': True,
    'show_organizations': True,
    'show_persons': True,
    'show_works': True,
}
```

### Форматы экспорта

#### Excel формат
- Заголовок с номером документа
- Блок реквизитов документа
- Таблица с сотрудниками и часами по дням
- Профессиональное форматирование

#### JSON формат
```json
{
  "document_info": {
    "type": "timesheet",
    "version": "1.0",
    "number": "ТБ-001",
    "date": "2024-12-19",
    "month_year": "12.2024",
    "is_posted": false,
    "object_name": "Жилой дом",
    "estimate_number": "СМ-001",
    "foreman_name": "Иванов И.И."
  },
  "lines": [
    {
      "line_number": 1,
      "employee_name": "Петров П.П.",
      "hourly_rate": 500.0,
      "days_data": {
        "day_01": 8.0,
        "day_02": 8.0
      },
      "total_hours": 16.0,
      "total_amount": 8000.0
    }
  ]
}
```

## Тестирование

Создан комплексный тест функциональности:
- `test_timesheet_functionality_simple.py` - проверка всех компонентов
- Все тесты пройдены успешно ✅

## Использование

### Настройка отображения помеченных объектов
1. Открыть "Настройки" → "Удаление помеченных объектов"
2. Установить флажок "Отображать помеченные на удаление объекты в списке"
3. Выбрать типы объектов для отображения

### Экспорт табеля
1. Открыть документ Табель
2. Нажать кнопку "Экспорт в Excel" или "Экспорт в JSON"
3. Выбрать место сохранения файла

### Импорт табеля
1. Открыть документ Табель (несохраненный или непроведенный)
2. Нажать кнопку "Импорт из Excel" или "Импорт из JSON"
3. Выбрать файл для импорта
4. Подтвердить замену данных

## Безопасность

- Импорт возможен только в непроведенные документы
- Подтверждающие диалоги перед заменой данных
- Валидация существования сотрудников в базе данных
- Обработка ошибок с информативными сообщениями

## Заключение

Все запрошенные функции успешно реализованы и протестированы. Система готова к использованию.