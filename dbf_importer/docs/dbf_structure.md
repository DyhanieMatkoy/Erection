# Структура DBF файлов

## Обзор

Документ описывает структуру DBF файлов, используемых для импорта данных из системы 1С в систему управления строительством.

## Общие требования

- Кодировка файлов: CP866 (стандартная для 1С)
- Расширение файлов: .dbf
- Формат даты: ГГГГММДД (например, 20231208 для 8 декабря 2023 года)
- Логические поля: True/False или 1/0

## Структура файлов

### 1. Виды работ / Номенклатура (works.dbf, nomenclature.dbf)

**Важно:** В данном проекте сущность "Номенклатура" из DBF файлов импортируется напрямую в таблицу Works. Термин "Номенклатура" используется как синоним для "Видов работ". Оба файла (works.dbf и nomenclature.dbf) импортируются в одну таблицу works.

| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| ID | Numeric | Уникальный идентификатор записи | Да |
| NAME | Character | Наименование вида работ (номенклатуры) | Да |
| PARENT | Numeric | ID родительской записи (0 для корневых) | Нет |
| CODE | Character | Код вида работ | Нет |
| UNIT | Character | Единица измерения | Нет |
| PRICE | Numeric | Цена за единицу | Нет |
| LABOR_RATE | Numeric | Норма трудозатрат | Нет |
| DELMARK | Logical | Признак удаления (True - удалена) | Да |

**Пример данных:**
```
ID,NAME,PARENT,CODE,UNIT,PRICE,LABOR_RATE,DELMARK
1,Строительные работы,0,STR,,0.00,0.00,False
11,Земляные работы,1,EARTH,м3,0.00,0.00,False
12,Фундаментные работы,1,FOUND,м3,0.00,0.00,False
111,Разработка грунта,11,EARTH1,м3,150.50,2.5,False
112,Устройство котлована,11,EARTH2,м3,320.75,4.0,False
```

### 2. Материалы (materials.dbf)

| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| ID | Numeric | Уникальный идентификатор записи | Да |
| NAME | Character | Наименование материала | Да |
| UNIT | Numeric | ID единицы измерения | Да |
| DELMARK | Logical | Признак удаления (True - удален) | Да |

**Пример данных:**
```
ID,NAME,UNIT,DELMARK
1001,Бетон М200,1,False
1002,Арматура А500,2,False
1003,Кирпич силикатный,3,False
1004,Песок,4,False
1005,Щебень,4,False
```

### 3. Элементы затрат (cost_items.dbf)

| Поле | Тип | Описание | Обязательное |
|------|-----|----------|--------------|
| ID | Numeric | Уникальный идентификатор записи | Да |
| NAME | Character | Наименование элемента затрат | Да |
| WORK | Numeric | ID вида работ | Да |
| COST | Numeric | Стоимость | Да |
| DELMARK | Logical | Признак удаления (True - удален) | Да |

**Пример данных:**
```
ID,NAME,WORK,COST,DELMARK
1001,Разработка грунта группы I,101,150.50,False
1002,Разработка грунта группы II,101,180.75,False
2001,Устройство опалубки,201,320.00,False
2002,Укладка бетона,201,450.25,False
```

## Связи между таблицами

1. **works.parent** → **works.id**
   - Каждый вид работ может ссылаться на родительский вид работ (иерархия)

2. **cost_items.work** → **works.id**
   - Каждый элемент затрат должен ссылаться на существующий вид работ

3. **materials.unit** → **units.id**
   - Каждый материал должен ссылаться на существующую единицу измерения

## Особенности импорта

1. **Порядок импорта**: Данные импортируются в следующем порядке:
   - Виды работ (включая данные из файла номенклатуры)
   - Материалы
   - Элементы затрат

2. **Обработка удаленных записей**:
   - Записи с DELMARK=True импортируются, но помечаются как удаленные в базе данных
   - Это позволяет сохранять историю изменений

3. **Обновление существующих записей**:
   - Если запись с указанным ID уже существует в базе данных, она обновляется
   - Если запись с указанным ID не существует, она создается

## Рекомендации по подготовке DBF файлов

1. **Проверка целостности данных**:
   - Убедитесь, что все ссылки на ID корректны
   - Проверьте отсутствие циклических ссылок в иерархии видов работ

2. **Оптимизация размера файлов**:
   - Удалите записи с DELMARK=True, если они не нужны для истории
   - Сжать файлы после удаления записей

3. **Резервное копирование**:
   - Перед импортом создайте резервную копию базы данных
   - Сохраните исходные DBF файлы

## Типичные ошибки и их исправление

1. **Нарушение ссылочной целостности**:
   - Ошибка: Вид работ ссылается на несуществующий родительский вид работ
   - Решение: Проверить и исправить поле PARENT в файле works.dbf

2. **Отсутствие обязательных полей**:
   - Ошибка: В записи отсутствует поле NAME
   - Решение: Добавить отсутствующие поля во все записи

3. **Некорректные типы данных**:
   - Ошибка: В числовом поле содержится текст
   - Решение: Проверить и исправить типы данных в DBF файле

4. **Дубликаты ID**:
   - Ошибка: Две записи имеют одинаковый ID
   - Решение: Установить уникальные ID для всех записей